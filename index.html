<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>میری فیملی ٹری</title>
    <style>
        /* CSS pichle version jaisa hi hai, ismein sirf naye modal aur buttons ke liye izafa hai */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            direction: rtl; 
            text-align: right;
        }

        .header-bar {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .site-name-heading {
            margin: 0;
            font-size: 1.5em;
            cursor: pointer;
        }

        .action-button, .edit-btn, .delete-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 5px;
            transition: background-color 0.3s ease;
        }

        .delete-btn {
            background-color: #dc3545; /* Red color for Delete */
        }
        .edit-btn {
            background-color: #ffc107; /* Yellow color for Edit */
            color: #333;
        }

        .action-button:hover, .edit-btn:hover, .delete-btn:hover {
            opacity: 0.9;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .tree-display {
            padding: 20px;
            text-align: right;
        }

        .member-node {
            margin-right: 20px; 
            padding-right: 15px;
            border-right: 2px solid #ccc; 
            margin-bottom: 15px;
        }

        .member-card {
            background-color: #ffffff;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 5px;
            gap: 10px; 
            width: fit-content; /* Card size adjust */
        }
        
        .member-info {
            flex-grow: 1;
            margin-left: 10px;
        }

        .member-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .children-list {
            list-style: none;
            padding-right: 0;
            margin-right: 20px;
            border-right: none;
        }

        .children-list li {
            position: relative;
            margin-bottom: 10px;
        }
        .parent-info {
            font-size: 0.8em;
            color: #777;
            margin: 5px 0 0 0;
        }

        /* --- Modal CSS for Editing --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 10; 
            right: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            direction: rtl; 
            text-align: right;
        }

        .close-btn {
            color: #aaa;
            float: left; 
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <header class="header-bar">
        <h1 id="siteNameHeading" class="site-name-heading">
            نام لوڈ ہو رہا ہے...
        </h1>
        
        <button id="adminButton" class="action-button" onclick="handleAdminAction()">
            نام تبدیل کریں
        </button>
    </header>

    <main style="padding: 20px;">
        <h2>فیملی ممبر شامل کریں</h2>
        
        <section style="padding: 20px; background-color: white; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05);">
            <div class="form-group"><label for="memberName">نام:</label><input type="text" id="memberName"></div>
            <div class="form-group"><label for="memberDob">تاریخ پیدائش:</label><input type="text" id="memberDob" placeholder="YYYY"></div>
            <div class="form-group"><label for="memberPic">تصویر اپ لوڈ کریں:</label><input type="file" id="memberPic" accept="image/*"></div>
            <div class="form-group"><label for="memberParentId">والد کی ID (پہلے ممبر کے لیے 0):</label><input type="text" id="memberParentId" placeholder="مثلاً: کوئی ID"></div>
            
            <button class="action-button" onclick="addFamilyMember()">
                ممبر کو ڈیٹا بیس میں محفوظ کریں
            </button>
            <p style="margin-top: 10px; font-size: 0.9em;">*پہلے ممبر کے لیے والد کی ID کو **0** لکھیں۔</p>
        </section>


        <h2>فیملی کا شجرہ نسب</h2>
        <div id="familyTreeContainer" class="tree-display">
            <p>فیملی ٹری لوڈ ہو رہا ہے...</p>
        </div>
    </main>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeEditModal()">&times;</span>
        <h3>ممبر کو تبدیل کریں (Edit Member)</h3>
        <input type="hidden" id="editMemberId">
        <input type="hidden" id="editOldPicUrl"> 
        
        <div class="form-group"><label for="editName">نام:</label><input type="text" id="editName"></div>
        <div class="form-group"><label for="editDob">تاریخ پیدائش:</label><input type="text" id="editDob"></div>
        <div class="form-group"><label for="editParentId">والد کی ID:</label><input type="text" id="editParentId"></div>
        <div class="form-group">
            <label for="editPic">تصویر تبدیل کریں (اختیاری):</label>
            <input type="file" id="editPic" accept="image/*">
            <p style="margin-top: 5px; font-size: 0.8em;">(اگر آپ نئی تصویر نہیں لگاتے تو پرانی تصویر ہی رہے گی)</p>
        </div>
        
        <button class="action-button" onclick="updateMember()">
            تبدیلی محفوظ کریں (Save Changes)
        </button>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==================================================================
        // **!!! APKI SUPABASE CONFIGURATION !!!**
        // ==================================================================
        
        // Aapka Project URL
        const SUPABASE_URL = 'https://pqednxysbdtcnemowtvv.supabase.co';

        // Aapki Public Anon Key
        const SUPABASE_ANON_KEY = 'EyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxZWRueHlzYmR0Y25lbW93dHZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMjM1NjYsImV4cCI6MjA3OTg5OTU2Nn0.5VyOnx7vEK_OWpLTetbuXukmbJfw1SjbHw7yhXPvE64'; 
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ------------------------------------------------------------------
        // Variables
        const SITE_CONFIG_DOC_ID = 1;
        const MEMBERS_TABLE = 'members';
        const SETTINGS_TABLE = 'settings';
        const STORAGE_BUCKET = 'member-pics'; 
        const defaultName = 'میری فیملی ٹری'; 
        const siteNameElement = document.getElementById('siteNameHeading');
        const treeContainer = document.getElementById('familyTreeContainer');
        const editModal = document.getElementById('editModal');

        document.addEventListener('DOMContentLoaded', () => {
            loadSiteName();
            loadFamilyTree(); 
        });
        
        // ==================================================================
        // ADMIN & INITIALIZATION FUNCTIONS (Naam Badalna)
        // ==================================================================

        // ... (loadSiteName, changeSiteName, handleAdminAction functions wahi hain)
        async function loadSiteName() {
            const { data, error } = await supabase.from(SETTINGS_TABLE).select('site_name').eq('id', SITE_CONFIG_DOC_ID).single();
            if (data && data.site_name) {
                siteNameElement.textContent = data.site_name;
            } else {
                siteNameElement.textContent = defaultName;
                await changeSiteName(defaultName); 
            }
        }
        
        async function changeSiteName(newName) {
            if (!newName) return;
            const { error } = await supabase.from(SETTINGS_TABLE).upsert([{ id: SITE_CONFIG_DOC_ID, site_name: newName.trim() }]);
            if (error) {
                console.error("Naam update karne mein error:", error);
                alert("Naam tabdeel nahi ho saka.");
            } else {
                siteNameElement.textContent = newName.trim();
                alert(`Web site ka naam kamyabi se tabdeel ho kar "${newName.trim()}" ho gaya hai.`);
            }
        }
        
        function handleAdminAction() {
            const currentName = siteNameElement.textContent;
            const newName = prompt(`Web site ka naya naam darj karein:`, currentName);
            if (newName && newName.trim() !== "" && newName.trim() !== currentName) {
                changeSiteName(newName);
            } else if (newName !== null) {
                alert('Naam khali hai ya aapne koi tabdeeli nahi ki.');
            }
        }
        
        // ==================================================================
        // STORAGE FUNCTIONS (Tasveer Upload & Delete)
        // ==================================================================

        async function uploadImage(imageFile) {
            const filePath = `family-pics/${Date.now()}_${imageFile.name}`;
            const { error: uploadError } = await supabase.storage.from(STORAGE_BUCKET).upload(filePath, imageFile);
            if (uploadError) {
                throw new Error('Tasveer upload karne mein error: ' + uploadError.message);
            }
            const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(filePath);
            return data.publicUrl;
        }

        async function deleteImage(picUrl) {
            if (!picUrl || picUrl.includes('placeholder.com')) return; // Placeholder ko delete na karein

            // Supabase URL se sirf file path nikalein
            const urlParts = picUrl.split('/public/');
            if (urlParts.length > 1) {
                const filePath = urlParts[1];
                const { error } = await supabase.storage.from(STORAGE_BUCKET).remove([filePath]);
                if (error) {
                    console.error("Purani tasveer delete karne mein error:", error.message);
                }
            }
        }

        // ==================================================================
        // CREATE FUNCTION (Naya Member Shamil Karna)
        // ==================================================================

        async function addFamilyMember() {
            // Logic wahi hai, sirf Update/Delete ke liye jagah bana di gayi hai
            const name = document.getElementById('memberName').value.trim();
            const dob = document.getElementById('memberDob').value.trim();
            const parentIdInput = document.getElementById('memberParentId').value.trim();
            const imageFile = document.getElementById('memberPic').files[0]; 

            if (!name || !dob || !imageFile) {
                alert("Naam, tareekh e paidaish, aur tasveer upload karna zaroori hai.");
                return;
            }

            const addButton = document.querySelector('button[onclick="addFamilyMember()"]');
            addButton.disabled = true;
            addButton.textContent = '...mehfooz ho raha hai';

            try {
                const picUrl = await uploadImage(imageFile); 
                const parentId = parentIdInput === '0' ? null : parentIdInput;

                const newMemberData = {
                    name: name,
                    dob: dob,
                    parent_id: parentId,
                    pic_url: picUrl 
                };

                const { error } = await supabase.from(MEMBERS_TABLE).insert([newMemberData]);

                if (error) throw error;
                
                alert(`Naya member kamyabi se shamil ho gaya hai.`);
                
                document.getElementById('memberName').value = '';
                document.getElementById('memberDob').value = '';
                document.getElementById('memberPic').value = '';
                loadFamilyTree(); 

            } catch (error) {
                console.error("Member shamil karne mein ya upload mein error:", error.message);
                alert(`Error aa gaya: ${error.message}.`);
            } finally {
                addButton.disabled = false;
                addButton.textContent = 'ممبر کو ڈیٹا بیس میں محفوظ کریں';
            }
        }

        // ==================================================================
        // UPDATE/EDIT FUNCTIONS (Data Badalna)
        // ==================================================================

        function closeEditModal() {
            editModal.style.display = 'none';
        }

        function openEditModal(id, name, dob, parent_id, pic_url) {
            document.getElementById('editMemberId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editDob').value = dob;
            document.getElementById('editParentId').value = parent_id || '0';
            document.getElementById('editOldPicUrl').value = pic_url;
            document.getElementById('editPic').value = ''; // Input file ko saaf karein
            editModal.style.display = 'block';
        }

        async function updateMember() {
            const id = document.getElementById('editMemberId').value;
            const newName = document.getElementById('editName').value.trim();
            const newDob = document.getElementById('editDob').value.trim();
            const newParentIdInput = document.getElementById('editParentId').value.trim();
            const newImageFile = document.getElementById('editPic').files[0];
            const oldPicUrl = document.getElementById('editOldPicUrl').value;
            
            if (!newName || !newDob) {
                alert("Naam aur Tareekh-e-Paidaish khali nahi ho sakte.");
                return;
            }

            let newPicUrl = oldPicUrl;

            const updateButton = editModal.querySelector('button');
            updateButton.disabled = true;
            updateButton.textContent = '...tabdeeli mehfooz ho rahi hai';

            try {
                if (newImageFile) {
                    // 1. Purani tasveer delete karein (Agar nayi upload ho rahi hai)
                    await deleteImage(oldPicUrl); 
                    // 2. Nayi tasveer upload karein
                    newPicUrl = await uploadImage(newImageFile);
                }

                const newParentId = newParentIdInput === '0' ? null : newParentIdInput;

                const updatedData = {
                    name: newName,
                    dob: newDob,
                    parent_id: newParentId,
                    pic_url: newPicUrl 
                };

                // 3. Supabase mein data update karein
                const { error } = await supabase
                    .from(MEMBERS_TABLE)
                    .update(updatedData)
                    .eq('id', id);

                if (error) throw error;

                alert(`Member ID ${id} ka data kamyabi se tabdeel ho gaya hai.`);
                closeEditModal();
                loadFamilyTree(); // Tree ko refresh karein

            } catch (error) {
                console.error("Update karne mein error:", error.message);
                alert(`Error aa gaya: ${error.message}.`);
            } finally {
                updateButton.disabled = false;
                updateButton.textContent = 'تبدیلی محفوظ کریں (Save Changes)';
            }
        }

        // ==================================================================
        // DELETE FUNCTION (Data aur Tasveer Delete Karna)
        // ==================================================================

        async function deleteMember(id, picUrl, name) {
            if (!confirm(`Kya aap waqai ${name} (ID: ${id}) ko hamesha ke liye delete karna chahte hain?`)) {
                return;
            }

            try {
                // 1. Supabase Storage se tasveer delete karein
                await deleteImage(picUrl);

                // 2. Supabase Database se data delete karein
                const { error } = await supabase
                    .from(MEMBERS_TABLE)
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                
                alert(`${name} ka data kamyabi se delete ho gaya hai.`);
                loadFamilyTree(); // Tree ko refresh karein

            } catch (error) {
                console.error("Delete karne mein error:", error.message);
                alert(`Error aa gaya: ${error.message}.`);
            }
        }
        
        // ==================================================================
        // READ FUNCTIONS (Data Dikhana)
        // ==================================================================

        async function loadFamilyTree() {
            treeContainer.innerHTML = 'TrEE tayyar kiya ja raha hai...';
            
            const { data: membersData, error } = await supabase.from(MEMBERS_TABLE).select('*');

            if (error) {
                console.error("Family Tree load karne mein error:", error);
                treeContainer.innerHTML = '<p style="color:red;">Data load nahi ho saka. Policies check karein.</p>';
                return;
            }

            const allMembers = membersData.map(member => ({
                ...member,
                id: member.id.toString(), 
                parent_id: member.parent_id ? member.parent_id.toString() : null
            }));

            const treeStructure = buildTreeStructure(allMembers);

            if (treeStructure.length > 0) {
                treeContainer.innerHTML = '<h4>Shajrah Nasab:</h4>';
                treeStructure.forEach(rootMember => {
                    treeContainer.innerHTML += generateHtmlForNode(rootMember);
                });
            } else {
                treeContainer.innerHTML = '<p>Data base mein koi family member maujood nahi hai.</p>';
            }
        }

        function buildTreeStructure(members) {
            const map = {};
            const tree = [];
            members.forEach(member => {
                member.children = [];
                map[member.id] = member;
            });
            members.forEach(member => {
                if (member.parent_id && map[member.parent_id]) {
                    map[member.parent_id].children.push(member);
                } else {
                    tree.push(member);
                }
            });
            return tree;
        }

        // HTML generate karne ka function - Buttons ke saath update kiya gaya hai
        function generateHtmlForNode(member) {
            let html = '';
            
            // Delete aur Edit ke buttons member ke data par click karne ke liye tayyar hain
            const editFunction = `openEditModal('${member.id}', '${member.name.replace(/'/g, "\\'")}', '${member.dob}', '${member.parent_id || ''}', '${member.pic_url}')`;
            const deleteFunction = `deleteMember('${member.id}', '${member.pic_url}', '${member.name.replace(/'/g, "\\'")}')`;

            html += `<div class="member-node">`;
            html += `   <div class="member-card">`;
            html += `       <img src="${member.pic_url || 'https://via.placeholder.com/50'}" alt="${member.name}">`;
            html += `       <div class="member-info">`;
            html += `           <strong>${member.name}</strong> (${member.dob})`;
            html += `           <p class="parent-info">ID: ${member.id} | Waald ID: ${member.parent_id || 'N/A'}</p>`;
            html += `           <button class="edit-btn" onclick="${editFunction}">Edit</button>`;
            html += `           <button class="delete-btn" onclick="${deleteFunction}">Delete</button>`;
            html += `       </div>`;
            html += `   </div>`;

            if (member.children.length > 0) {
                html += `<ul class="children-list">`;
                member.children.forEach(child => {
                    html += `<li>${generateHtmlForNode(child)}</li>`;
                });
                html += `</ul>`;
            }

            html += `</div>`;
            return html;
        }
    </script>
</body>
</html>
