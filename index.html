<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shajra Pro - Ultimate UI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- HIGH END ANIMATIONS & STYLES --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
            --blur: blur(12px);
            --primary: #4f46e5;
            --accent: #f59e0b;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #f0f2f5;
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            overflow: hidden; 
            user-select: none;
        }

        /* FLOATING GLASS PANELS */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        /* ZOOM & PAN CONTAINER */
        #viewport {
            width: 100vw; height: 100vh;
            overflow: hidden;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #viewport:active { cursor: grabbing; }
        #canvas {
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }

        /* TREE NODES STYLING */
        .node-card {
            background: white;
            padding: 12px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 4px 10px -2px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 140px;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .node-card:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 20px 40px -5px rgba(79, 70, 229, 0.2);
            z-index: 50;
        }
        
        .avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 8px;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            object-fit: cover;
        }

        /* CONNECTORS */
        .connector-line {
            position: absolute;
            background: #cbd5e1;
            z-index: -1;
        }

        /* BOTTOM DOCK (IOS STYLE) */
        .dock-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            padding: 12px 20px;
            border-radius: 24px;
            z-index: 100;
            transition: bottom 0.3s;
        }
        
        .dock-icon {
            position: relative;
            width: 50px; height: 50px;
            border-radius: 14px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .dock-icon:hover {
            transform: scale(1.2) translateY(-10px);
            color: var(--primary);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        .dock-tooltip {
            position: absolute;
            top: -40px;
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            opacity: 0;
            transition: 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }
        .dock-icon:hover .dock-tooltip { opacity: 1; top: -45px; }

        /* MODALS */
        .custom-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 200;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        .modal-box {
            background: white;
            width: 90%; max-width: 400px;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { to { transform: scale(1); } }

        /* Urdu Font Support */
        .font-urdu { font-family: 'Noto Nastaliq Urdu', serif; line-height: 1.8; }
    </style>
</head>
<body>

    <div class="fixed top-6 left-6 z-50 flex items-center gap-3 glass-panel px-4 py-2 rounded-full">
        <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold">
            <i class="fa-solid fa-tree"></i>
        </div>
        <div>
            <h1 class="font-bold text-gray-800 text-sm leading-tight">Family Shajra</h1>
            <p class="text-[10px] text-green-600 font-medium flex items-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Online
            </p>
        </div>
    </div>

    <div class="fixed top-6 right-6 z-50 flex flex-col gap-2">
        <button onclick="adjustZoom(0.1)" class="glass-panel w-10 h-10 rounded-xl flex items-center justify-center text-gray-600 hover:text-indigo-600 active:scale-95 transition">
            <i class="fa-solid fa-plus"></i>
        </button>
        <button onclick="resetZoom()" class="glass-panel w-10 h-10 rounded-xl flex items-center justify-center text-gray-600 hover:text-indigo-600 active:scale-95 transition font-bold text-xs">
            100%
        </button>
        <button onclick="adjustZoom(-0.1)" class="glass-panel w-10 h-10 rounded-xl flex items-center justify-center text-gray-600 hover:text-indigo-600 active:scale-95 transition">
            <i class="fa-solid fa-minus"></i>
        </button>
    </div>

    <div id="viewport">
        <div id="canvas">
            </div>
    </div>

    <div class="dock-container glass-panel">
        
        <div class="dock-icon" onclick="switchTree(1)">
            <i class="fa-solid fa-sitemap"></i>
            <span class="dock-tooltip">Tree View</span>
        </div>

        <div class="dock-icon" onclick="openModal('uploadModal')">
            <i class="fa-solid fa-user-plus text-indigo-500"></i>
            <span class="dock-tooltip">Add Member</span>
        </div>

        <div class="dock-icon" onclick="openModal('analyticsModal'); fetchStats()">
            <i class="fa-solid fa-chart-pie text-orange-500"></i>
            <span class="dock-tooltip">Analytics</span>
        </div>
        
        <div class="dock-icon" onclick="openModal('aboutModal')">
            <i class="fa-solid fa-address-card text-emerald-500"></i>
            <span class="dock-tooltip">Contact</span>
        </div>

        <div class="dock-icon" onclick="location.reload()">
            <i class="fa-solid fa-rotate-right"></i>
            <span class="dock-tooltip">Refresh</span>
        </div>

    </div>

    <div id="uploadModal" class="custom-modal">
        <div class="modal-box">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">New Family Member</h2>
                <button onclick="closeModal('uploadModal')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-red-100 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Full Name</label>
                    <input type="text" id="nameInput" placeholder="e.g. Ali Ahmed" class="w-full mt-1 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Photo</label>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-300 transition mt-1 group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-400 group-hover:text-indigo-500">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2"></i>
                            <p class="text-xs">Click to upload photo</p>
                        </div>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="previewFile()">
                    </label>
                    <div id="previewArea" class="hidden mt-2 text-center text-xs text-green-600 font-bold">Image Selected!</div>
                </div>

                <button onclick="uploadData()" id="btn-upload" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-400 hover:scale-[1.02] transition active:scale-95">
                    Save to Shajra
                </button>
                <p id="status" class="text-center text-xs mt-2 text-gray-500"></p>
            </div>
        </div>
    </div>

    <div id="analyticsModal" class="custom-modal">
        <div class="modal-box text-center">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Family Insights</h2>
                <button onclick="closeModal('analyticsModal')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-red-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl border border-indigo-100">
                    <i class="fa-solid fa-users text-indigo-400 text-xl mb-2"></i>
                    <div class="text-3xl font-bold text-gray-800" id="statTotal">--</div>
                    <div class="text-xs text-gray-500 font-medium">Total Members</div>
                </div>
                <div class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-2xl border border-orange-100">
                    <i class="fa-solid fa-mars-and-venus text-orange-400 text-xl mb-2"></i>
                    <div class="text-sm font-bold text-gray-800 mt-2" id="statGender">--</div>
                    <div class="text-xs text-gray-500 font-medium">Male / Female</div>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl text-left">
                <h3 class="text-sm font-bold text-gray-700 mb-2 border-b pb-2">Fun Facts</h3>
                <div class="flex justify-between text-xs mb-2">
                    <span class="text-gray-500">Most Common Name:</span>
                    <span class="font-bold text-indigo-600" id="statCommonName">--</span>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="text-gray-500">Data Status:</span>
                    <span class="font-bold text-green-600">Sync Active</span>
                </div>
            </div>
        </div>
    </div>

    <div id="aboutModal" class="custom-modal">
        <div class="modal-box text-center">
            <span onclick="closeModal('aboutModal')" class="absolute top-4 right-4 cursor-pointer text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark fa-lg"></i></span>
            
            <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-handshake"></i>
            </div>
            
            <h2 class="text-xl font-bold mb-1">Contact Admin</h2>
            <p class="text-sm text-gray-500 mb-6 font-urdu" id="dynamicUrduText">Loading info...</p>
            
            <a id="waLink" href="#" class="flex items-center justify-center gap-2 w-full py-3 bg-[#25D366] text-white font-bold rounded-xl shadow-lg hover:brightness-110 transition mb-3">
                <i class="fa-brands fa-whatsapp fa-lg"></i> Chat on WhatsApp
            </a>
            
            <div class="text-xs text-gray-400 mt-4">
                Design & Code by Shajra Pro v3.0
            </div>
        </div>
    </div>


    <script>
        /* --- 1. INTERACTIVE CANVAS LOGIC (ZOOM/DRAG) --- */
        const viewport = document.getElementById('viewport');
        const canvas = document.getElementById('canvas');
        let scale = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        viewport.addEventListener('mousedown', e => {
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            viewport.style.cursor = 'grabbing';
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            viewport.style.cursor = 'grab';
        });

        window.addEventListener('mousemove', e => {
            if (!isDragging) return;
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform();
        });

        function adjustZoom(amount) {
            scale += amount;
            if (scale < 0.5) scale = 0.5;
            if (scale > 2) scale = 2;
            updateTransform();
        }

        function resetZoom() {
            scale = 1; translateX = 0; translateY = 0;
            updateTransform();
        }

        function updateTransform() {
            canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }


        /* --- 2. TREE RENDERING --- */
        // Demo Data Structure (Recursive)
        const demoTree = {
            name: "Dada Abba", role: "Head of Family",
            children: [
                { 
                    name: "Uncle 1", role: "Son", 
                    children: [{ name: "Cousin A", role: "Grandson" }, { name: "Cousin B", role: "Granddaughter" }] 
                },
                { 
                    name: "My Father", role: "Son", spouse: "Mother",
                    children: [
                        { name: "Me", role: "Self" }, 
                        { name: "Brother", role: "Brother" }, 
                        { name: "Sister", role: "Sister" }
                    ] 
                },
                { name: "Aunt", role: "Daughter" }
            ]
        };

        function generateTreeHTML(node) {
            if (!node) return '';
            const hasChildren = node.children && node.children.length > 0;
            
            let childrenHTML = '';
            if (hasChildren) {
                const childrenElements = node.children.map((child, index) => {
                    const isFirst = index === 0;
                    const isLast = index === node.children.length - 1;
                    const count = node.children.length;
                    
                    // Connector Lines CSS logic
                    let lineStyle = `position: absolute; top: -20px; height: 20px; border-top: 2px solid #cbd5e1; width: 50%;`;
                    if(count === 1) lineStyle += `left: 50%; transform: translateX(-50%); border-left: 2px solid #cbd5e1; border-top: none; width: 2px;`;
                    else if(isFirst) lineStyle += `right: 0; border-top-left-radius: 10px; border-left: 2px solid #cbd5e1;`;
                    else if(isLast) lineStyle += `left: 0; border-top-right-radius: 10px; border-right: 2px solid #cbd5e1;`;
                    else lineStyle += `width: 100%; left: 0; border-left: none;`;

                    // Only show horizontal bar if middle child
                    let horizontalBar = (!isFirst && !isLast && count > 1) ? `<div style="position:absolute; top:-20px; left:0; width:100%; border-top: 2px solid #cbd5e1;"></div>` : '';
                    
                    // For single child, simplified logic handled by CSS usually, but here inline:
                    if(count > 1 && !isFirst && !isLast) lineStyle = `position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1; left: 50%;`;

                    return `
                        <div class="flex flex-col items-center relative px-2">
                             ${count > 1 ? (isFirst || isLast ? `<div style="${lineStyle}"></div>` : horizontalBar + `<div style="position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1; left: 50%;"></div>`) : `<div style="position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1;"></div>`}
                             
                             ${generateTreeHTML(child)}
                        </div>
                    `;
                }).join('');
                
                childrenHTML = `
                    <div class="flex flex-row justify-center mt-12 relative gap-4">
                        <div class="absolute -top-12 left-1/2 w-0.5 h-12 bg-slate-300 transform -translate-x-1/2"></div>
                        ${childrenElements}
                    </div>
                `;
            }

            // Node HTML
            return `
                <div class="flex flex-col items-center z-10">
                    <div class="node-card group">
                        <div class="avatar">${node.name.charAt(0)}</div>
                        <div class="text-sm font-bold text-gray-800">${node.name}</div>
                        <div class="text-[10px] text-gray-500 uppercase tracking-wide font-medium mt-1">${node.role}</div>
                        ${node.spouse ? `<div class="text-[10px] text-pink-500 mt-1 border-t w-full text-center pt-1">+ ${node.spouse}</div>` : ''}
                    </div>
                    ${childrenHTML}
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            canvas.innerHTML = generateTreeHTML(demoTree);
            loadConfig();
        });


        /* --- 3. SUPABASE & MODAL LOGIC --- */
        const supabaseUrl = 'https://ojphjodmpyblyfyinacb.supabase.co';
        const k1 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qcGhqb2RtcHlibHlmeWluYWN";
        const k2 = "iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTUwNTAsImV4cCI6MjA3OTk5MTA1MH0";
        const k3 = ".mwKu_g5_OT_89KcAeeSsY8IMlnakV2nQVtKRhWWTcDw";
        const _supabase = supabase.createClient(supabaseUrl, k1+k2+k3, { auth: { persistSession: false } });

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function previewFile() { document.getElementById('previewArea').classList.remove('hidden'); }

        async function loadConfig() {
            const { data } = await _supabase.from('site_config').select('*').limit(1);
            if (data && data[0]) {
                document.getElementById('dynamicUrduText').innerText = data[0].about_urdu || "Hamare shajra mein khushamdeed.";
                if(data[0].whatsapp) document.getElementById('waLink').href = "https://wa.me/" + data[0].whatsapp;
            }
        }

        async function uploadData() {
            const name = document.getElementById('nameInput').value;
            const file = document.getElementById('imageInput').files[0];
            const btn = document.getElementById('btn-upload');
            const status = document.getElementById('status');

            if (!name) { status.innerText = "Please enter a name"; status.className = "text-red-500 text-xs mt-2"; return; }
            
            btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Saving...";
            btn.disabled = true;

            try {
                let imgUrl = null;
                if(file) {
                    const fileName = Date.now() + "_" + file.name.replace(/\s/g, '');
                    const { error: imgErr } = await _supabase.storage.from('family-images').upload(fileName, file);
                    if (imgErr) throw imgErr;
                    const { data: urlData } = _supabase.storage.from('family-images').getPublicUrl(fileName);
                    imgUrl = urlData.publicUrl;
                }
                const { error: dbErr } = await _supabase.from('family_data').insert([{ full_name: name, image_url: imgUrl }]);
                if (dbErr) throw dbErr;
                
                status.innerText = "Member Added Successfully!";
                status.className = "text-green-600 font-bold text-xs mt-2";
                setTimeout(() => { closeModal('uploadModal'); btn.innerHTML = "Save to Shajra"; btn.disabled = false; location.reload(); }, 1500);

            } catch (err) {
                status.innerText = "Error: " + err.message;
                btn.innerHTML = "Try Again";
                btn.disabled = false;
            }
        }

        async function fetchStats() {
            const { data } = await _supabase.from('family_data').select('*');
            if(data) {
                document.getElementById('statTotal').innerText = data.length;
                let males = 0, females = 0;
                // Assuming gender detection or column existence in future
                // data.forEach(m => m.gender === 'female' ? females++ : males++);
                document.getElementById('statGender').innerText = "N/A"; // Placeholder until column added

                // Common name
                const counts = {};
                data.forEach(m => {
                    const first = m.full_name.trim().split(' ')[0];
                    counts[first] = (counts[first] || 0) + 1;
                });
                let maxN = "--", maxC = 0;
                for(let n in counts) { if(counts[n] > maxC) { maxC = counts[n]; maxN = n; }}
                document.getElementById('statCommonName').innerText = maxN + " (" + maxC + ")";
            }
        }
    </script>
</body>
</html>