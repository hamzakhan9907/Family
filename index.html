<!DOCTYPE html>
<html lang="ur">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Shajra</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// IMPORTANT: Supabase connection details (Moved to HEAD for faster loading and combined for cleaner code)
const supabaseUrl = 'https://ojphjodmpyblyfyinacb.supabase.co';
const k1 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qcGhqb2RtcHlibHlmeWluYWN";
const k2 = "iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTUwNTAsImV4cCI6MjA3OTk5MTA1MH0";
const k3 = ".mwKu_g5_OT_89KcAeeSsY8IMlnakV2nQVtKRhWWTcDw";
const SUPABASE_ANON_KEY = k1 + k2 + k3; // Key ko jod diya gaya hai
const _supabase = supabase.createClient(supabaseUrl, SUPABASE_ANON_KEY);

// NEW: Global variable to store the female detail passcode fetched from the database
let femalePasscode = null; 
// NEW: Global variable to store member data pending password verification
let tempMemberData = null; 

// --- NEW: Search & Tree Globals for faster interaction ---
let allMembersData = []; 
let currentRootId = null; 
let isHorizontal = false; 
// NEW Global Sort State for All Members Table
let currentSortColumn = 'full_name'; 
let currentSortDirection = 'asc'; 
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script> 

<style>
/* ----------------- GLOBAL ----------------- */
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f0f2f5; text-align:center; }
header { background-color: #2c3e50; padding:10px 15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); position:sticky; top:0; z-index:1000; }
.site-title { font-family:'Poppins',sans-serif; font-size:20px; font-weight:800; margin:0; background:linear-gradient(to right,#4ade80,#3b82f6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.admin-btn { background:#e74c3c; color:white; border:none; padding:6px 14px; border-radius:20px; cursor:pointer; font-family:'Poppins',sans-serif; font-size:12px; text-decoration:none; transition:0.3s; }
.shajra-navbar { background:#34495e; padding:0; display:flex; justify-content:space-around; align-items:center; height:25px; }
.shajra-nav-btn { background:none; border:none; color:#bdc3c7; display:flex; align-items:center; text-decoration:none; font-size:11px; cursor:pointer; padding:0 10px; height:100%; transition:all 0.2s; }
.shajra-nav-btn i { font-size:12px; margin-right:4px; color:#bdc3c7; }
.shajra-nav-btn:hover { background-color:#496075; color:white; } 
.shajra-nav-btn:hover i { color:white; }
.shajra-dropdown { position:relative; }
.shajra-dropdown-menu { display:none; position:absolute; right:0; top:25px; background:#fff; min-width:160px; box-shadow:0px 10px 25px rgba(0,0,0,0.15); z-index:100; border-radius:8px; border:1px solid #f0f0f0; overflow:hidden; }
.shajra-dropdown-menu a { color:#333; padding:10px 16px; text-decoration:none; display:flex; align-items:center; gap:10px; font-size:13px; font-weight:500; border-bottom:1px solid #f9f9f9; text-align:left; transition:background 0.2s; }
.shajra-dropdown-menu a:last-child { border-bottom:none; }
.shajra-dropdown-menu a:hover { background-color:#f0f7ff; color:#2196f3; }
.shajra-dropdown-menu i { width:18px; text-align:center; color:#7f8c8d; }
.show { display:block; }

/* --- Search Bar Styles (UPDATED) --- */
.shajra-search-container {
    padding: 5px 10px;
    background-color: #34495e; 
    border-bottom: 2px solid #2c3e50;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px; /* Added gap between input and button */
}
#memberSearchInput {
    padding: 5px 10px;
    border-radius: 6px;
    border: 1px solid #5d6d7e;
    font-size: 13px;
    width: 90%;
    max-width: 400px;
    background: #fcfcfc;
    color: #333;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}
/* NEW: Close Button Style */
.search-close-btn {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    line-height: 1; /* Ensures icon is centered */
    transition: background 0.2s;
}
.search-close-btn:hover {
    background: #c0392b;
}

/* ---------------------------------------------------------------------------------- */
/* ---------- NEW: Search Results Dropdown Styles ---------- */
/* ---------------------------------------------------------------------------------- */
.search-results-container {
    position: absolute; 
    top: 95px; /* Adjust based on header+navbar+search height */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 0 0 8px 8px; /* Rounded bottom */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 999; 
    max-height: 300px;
    overflow-y: auto;
}
.search-result-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
    text-align: left;
}
.search-result-item:hover {
    background-color: #f0f7ff;
}
.search-result-item:last-child {
    border-bottom: none;
}
.result-info {
    flex-grow: 1;
    margin-left: 10px;
}
.result-name {
    font-weight: 700;
    color: #2c3e50;
    font-size: 14px;
    line-height: 1.2;
}
.result-parent {
    font-size: 11px;
    color: #7f8c8d;
    margin-top: 2px;
}
.result-icon {
    font-size: 16px;
    color: #3498db;
    width: 20px;
    text-align: center;
}

/* ---------------------------------------------------------------------------------- */
/* ---------- NEW: Highlighting Effect ---------- */
/* ---------------------------------------------------------------------------------- */
.highlighted-member {
    animation: highlightPulse 0.5s 10 alternate; /* 5 seconds total (10 alternating pulses) */
    border-color: #e67e22 !important; 
    box-shadow: 0 0 15px rgba(230, 126, 34, 0.8) !important;
}
@keyframes highlightPulse {
    from { box-shadow: 0 0 15px rgba(230, 126, 34, 0.8) !important; }
    to { box-shadow: 0 0 5px rgba(230, 126, 34, 0.2) !important; }
}


/* ---------------------------------------------------------------------------------- */
/* ---------- MODALS (Unique Common Styles) ---------- */
/* ---------------------------------------------------------------------------------- */
.shajra-modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; backdrop-filter:blur(2px); }
/* Default small modal size for Stats/About */
.shajra-modal-content { background:white; width:85%; max-width:340px; padding:25px; border-radius:16px; text-align:center; position:relative; max-height:90vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
/* UNIQUE CLASS FOR HEADER */
.shajra-modal-title { font-size:20px; font-weight:700; color:#333; margin-bottom:15px; border-bottom:3px solid #3ecf8e; display:inline-block; padding-bottom:5px; }
/* UNIQUE CLASS FOR CLOSE X */
.shajra-modal-close-x { position:absolute; top:15px; right:20px; font-size:24px; color:#aaa; cursor:pointer; transition:0.2s; }
/* UNIQUE CLASS FOR BOTTOM BUTTON */
.shajra-modal-action-btn { background:#f1f2f6; border:none; padding:12px 0; width:100%; border-radius:10px; font-weight:bold; color:#555; cursor:pointer; margin-top:10px; transition: background 0.2s; }
.shajra-modal-action-btn:hover { background: #e0e0e0; }


/* ---------------------------------------------------------------------------------- */
/* ---------- PASSCODE MODAL SPECIFIC STYLES (NEW) ----- */
/* ---------------------------------------------------------------------------------- */
#passcodeModal .shajra-modal-content {
    max-width: 350px;
    padding: 30px 20px;
}
.passcode-icon {
    font-size: 50px;
    color: #e67e22; /* Orange color for security */
    margin-bottom: 15px;
}
.passcode-instruction {
    font-family: 'Noto Nastaliq Urdu', serif;
    font-size: 16px;
    color: #34495e;
    margin-bottom: 20px;
    line-height: 1.6;
}
.passcode-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #bdc3c7;
    border-radius: 8px;
    font-size: 18px;
    text-align: center;
    letter-spacing: 2px;
    margin-bottom: 5px; /* Reduced margin to fit error display */
    outline: none;
    transition: border-color 0.3s;
}
.passcode-input:focus {
    border-color: #3498db;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
}
.passcode-error {
    color: #e74c3c;
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 10px;
    min-height: 20px;
}
.passcode-submit-btn {
    background: #2ecc71;
    color: white;
    border: none;
    padding: 12px;
    width: 100%;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 16px;
    margin-top: 5px;
}
.passcode-submit-btn:hover {
    background: #27ae60;
}


/* ---------------------------------------------------------------------------------- */
/* ---------- ANALYTICS MODAL SPECIFIC STYLES (FIXED) ----- */
/* ---------------------------------------------------------------------------------- */
#analyticsModal .shajra-modal-content { max-width: 380px; } /* Enforce size */
.analytics-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
}
.analytics-stat-card {
    background: #eaf6ff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.analytics-stat-card .stat-number { /* Added .analytics-stat-card to enforce specificity */
    display: block;
    font-size: 24px;
    font-weight: 800;
    color: #1e88e5;
    line-height: 1;
}
.analytics-stat-card .stat-urdu { /* Added .analytics-stat-card to enforce specificity */
    display: block;
    font-size: 11px;
    color: #555;
    font-family: 'Noto Nastaliq Urdu', serif;
    margin-top: 3px;
    font-weight: 500;
}
.analytics-fun-box {
    background: #f7f9fc;
    border: 1px solid #e0e0e0;
    padding: 15px;
    border-radius: 10px;
    text-align: left;
    margin-bottom: 20px;
}
.fun-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 14px;
    color: #444;
    border-bottom: 1px dashed #eee;
}
.fun-item:last-child { border-bottom: none !important; }
.fun-item span:first-child { font-weight: 500; }
.fun-item span:last-child { font-weight: 700; color: #388e3c; }


/* ---------------------------------------------------------------------------------- */
/* ---------- ABOUT MODAL SPECIFIC STYLES (FIXED) ----- */
/* ---------------------------------------------------------------------------------- */
#aboutModal .shajra-modal-content { max-width: 380px; } /* Enforce size */
.about-urdu-text-style {
    font-family: 'Noto Nastaliq Urdu', serif;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    margin-bottom: 20px;
    /* FIX: Center the Urdu text */
    text-align: center; 
}
.about-contact-box-style {
    background: #fff3e0;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    text-align: left; /* FIX: Added text-align: left; to keep content stable */
}
.about-contact-box-style p { margin: 5px 0; } /* FIX: Added to control paragraph spacing */
.contact-whatsapp-btn-style {
    display: block;
    background: #25d366;
    color: white;
    padding: 10px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    margin-top: 15px;
    transition: background 0.3s;
    font-size: 14px;
    text-align: center; /* FIX: Added to center button text */
}
.contact-whatsapp-btn-style:hover {
    background: #128c7e;
}
.features-list-box-style {
    text-align: left;
    background: #e8f5e9;
    padding: 15px;
    border-radius: 10px;
    margin-top: 20px;
}
.features-list-box-style ul {
    list-style: disc;
    padding-left: 20px;
    margin-top: 5px;
}
.features-list-box-style li {
    font-size: 13px;
    color: #333;
    margin-bottom: 5px;
}


/* ---------------------------------------------------------------------------------- */
/* ---------- ALL MEMBERS MODAL SPECIFIC STYLES ----- */
/* ---------------------------------------------------------------------------------- */
/* Overrides default size for large modal */
#allMembersModal .shajra-modal-content {
    max-width: 90%; 
    width: 700px; 
    padding: 15px;
}
.all-members-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
.all-members-table th {
    background-color: #34495e;
    color: white;
    padding: 10px 8px;
    text-align: left;
    cursor: pointer;
    position: sticky; /* Keep header visible on scroll */
    top: 0;
    z-index: 50;
}
.all-members-table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
}
.all-members-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.all-members-table tr:hover {
    background-color: #f0f7ff;
}
.sortable {
    user-select: none;
    cursor: pointer;
    position: relative;
}
/* Sort icon styles */
.sortable::after {
    content: '\f0dc'; /* Font Awesome: up/down arrows */
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    margin-left: 5px;
    color: #bdc3c7;
    font-size: 10px;
}
.sortable.asc::after {
    content: '\f0de'; /* Arrow up */
    color: #4ade80;
}
.sortable.desc::after {
    content: '\f0dd'; /* Arrow down */
    color: #e74c3c;
}
.details-link {
    background: #3498db;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 11px;
    font-weight: 600;
    transition: background 0.2s;
}
.details-link:hover {
    background: #2980b9;
}


/* ---------------------------------------------------------------------------------- */
/* ---------- EVENTS MODAL SPECIFIC STYLES (NEW) ----- */
/* ---------------------------------------------------------------------------------- */
#eventsModal .shajra-modal-content { max-width: 90%; width: 500px; padding: 15px; }
.event-tab-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #ecf0f1;
    color: #555;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.2s, color 0.2s;
}
.event-tab-btn:hover {
    background: #bdc3c7;
}
.event-tab-btn.active-tab {
    background: #3498db;
    color: white;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.event-list-container {
    max-height: 50vh;
    overflow-y: auto;
    padding: 5px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fcfcfc;
}
.event-card {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    background: #ffffff;
    border-left: 5px solid #2ecc71; /* Default: Upcoming/Success */
}
.event-card.past {
    border-left: 5px solid #95a5a6; /* Grey for past events */
}
.event-icon {
    font-size: 24px;
    color: #3498db;
    margin-right: 15px;
    width: 30px;
    text-align: center;
}
.event-details {
    flex-grow: 1;
    text-align: left;
}
.event-title {
    font-size: 14px;
    font-weight: 700;
    color: #333;
    line-height: 1.2;
}
.event-date {
    font-size: 12px;
    color: #7f8c8d;
    margin-top: 3px;
}
.event-days {
    font-size: 12px;
    font-weight: 600;
    color: #e67e22;
    margin-left: 10px;
}


/* ---------------------------------------------------------------------------------- */
/* ---------- MEMBER DETAIL MODAL STYLES (Existing) ----- */
/* ---------------------------------------------------------------------------------- */
#detailModal .shajra-modal-content { max-width: 400px; }
#detailModal #modalContentArea { text-align: center; }
/* Applied to image, or to the new icon placeholder div */
#detailModal .modal-profile-img, #detailModal .modal-profile-icon { 
    width: 120px; 
    height: 120px; 
    border-radius: 50%; 
    object-fit: cover; 
    margin: 0 auto 15px auto; 
    border: 5px solid #a0522d; 
    box-shadow: 0 0 0 3px #fff8e1; 
    transition: transform 0.3s; 
    cursor: pointer; /* Keep hover effect on icon too */
}
#detailModal .modal-profile-img:hover, #detailModal .modal-profile-icon:hover { transform: scale(1.05); }
/* Additional style for the icon background */
#detailModal .modal-profile-icon {
    background-color: #f7f7f7;
    display: flex;
    justify-content: center;
    align-items: center;
}
/* ... (Other detail modal styles are retained) ... */
#detailModal .modal-full-name { font-size: 28px; font-weight: 800; color: #2c3e50; margin-bottom: 5px; text-transform: capitalize; text-align: center; }
#detailModal .modal-relation { font-size: 14px; color: #888; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; text-align: center; }
#detailModal .detail-data-section { text-align: left; padding: 0 10px; }
#detailModal .modal-data-row { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
#detailModal .modal-data-row:last-child { border-bottom: none; }
#detailModal .modal-data-row span:first-child { font-weight: 600; color: #555; text-align: right; }
#detailModal .modal-data-row span:last-child { color: #222; font-weight: 700; text-align: left; }


/* ---------------------------------------------------------------------------------- */
/* ---------- HEADING & DROPDOWN STYLES (Horizontal Toggle)  ----- */
/* ---------------------------------------------------------------------------------- */
.heading-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 90%;
    margin: 25px auto 10px auto; 
    padding: 0 10px;
    flex-wrap: wrap; 
}
.family-name-display {
    font-family: 'Noto Nastaliq Urdu', serif;
    font-size: 20px; 
    font-weight: 700;
    color: #2c3e50;
    margin: 0; 
    border-bottom: 3px solid #4ade80; 
    display: inline-block;
    padding-bottom: 3px;
    text-align: center; 
    flex-grow: 1; 
    order: 2; 
}
.root-select-container {
    flex-grow: 0;
    max-width: 150px;
    text-align: left;
    margin-bottom: 5px;
    order: 1; 
}
#rootMemberSelect {
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 12px;
    width: 100%;
}

/* NEW: Utility container for buttons and toggles */
.shajra-utility-container {
    display: flex;
    gap: 10px;
    align-items: center;
    order: 3;
    flex-grow: 0;
    float: right;
}
.toggle-deceased-box {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 8px;
    background: #34495e; /* Match navbar */
    border-radius: 6px;
    color: white;
}
#toggleViewBtn {
    background: #3498db;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}
#toggleViewBtn:hover {
    background: #2980b9;
}

/* NEW: Toggle Switch CSS */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 30px;
  height: 17px;
}
.toggle-switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}
.slider:before {
  position: absolute;
  content: "";
  height: 13px;
  width: 13px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}
input:checked + .slider {
  background-color: #2ecc71;
}
input:focus + .slider {
  box-shadow: 0 0 1px #2ecc71;
}
input:checked + .slider:before {
  -webkit-transform: translateX(13px);
  -ms-transform: translateX(13px);
  transform: translateX(13px);
}
.slider.round {
  border-radius: 17px;
}
.slider.round:before {
  border-radius: 50%;
}

/* Deceased member style (Dimming and Hiding Logic) */
.deceased-member {
    opacity: 0.5; /* Always dim deceased members */
    transition: opacity 0.3s;
}
.deceased-member:hover {
    opacity: 1; /* Bring back opacity on hover */
}
/* Class applied to the main tree container to hide deceased members */
.hide-deceased .deceased-member {
    display: none !important; /* Hide them if class is applied to tree container */
}

/* For very small screens, adjust layout */
@media (max-width: 500px) {
    .heading-container {
        flex-direction: column;
        align-items: stretch;
    }
    .root-select-container, .shajra-utility-container {
        max-width: 100%;
        margin-bottom: 10px;
        order: 1; 
        justify-content: space-between;
    }
    .family-name-display {
        text-align: center;
        order: 3; 
        margin-top: 5px;
    }
    .shajra-utility-container {
        float: none;
        width: 100%;
        justify-content: space-around;
        gap: 5px;
    }
    #toggleViewBtn {
        flex-grow: 1;
        justify-content: center;
    }
    .toggle-deceased-box {
        flex-grow: 1;
        justify-content: center;
    }
}

/* ------------------------------------------------------------- */
/* ---------- FAMILY TREE STYLES (Vertical Default) ------------------------------- */
/* ------------------------------------------------------------- */
.family-tree { 
    font-family: 'Inter', sans-serif; 
    text-align: center; 
    padding: 30px 10px; 
    background-color: #fcfbf6; 
    overflow-x: auto; 
    min-height: 400px; 
}
.family-tree ul { 
    padding-top: 25px; 
    position: relative; 
    list-style: none; 
    padding-left: 0; 
    display: flex; 
    justify-content: flex-start; 
    transition: all 0.5s ease-in-out; 
    margin: 0; 
}
/* Standard Vertical Tree Connectors (Unchanged) */
.family-tree > ul { padding-top: 0; }
.family-tree li { list-style-type: none; position: relative; padding: 25px 15px 0 15px; flex-shrink: 0; transition: all 0.5s ease-in-out; }
.family-tree > ul > li { padding-top: 0; }
.family-tree li .member-card-wrapper { border: 2px solid #a0522d; background-color: #fff8e1; padding: 10px; text-decoration: none; display: inline-flex; flex-direction: column; align-items: center; border-radius: 12px; transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-width: 140px; position: relative; cursor: pointer; }
.family-tree li .member-card-wrapper:hover { background: #e7c29e; border-color: #a0522d; transform: translateY(-2px); box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.15); }
/* Custom style for icon placeholder */
.member-img-placeholder {
    width: 60px; 
    height: 60px; 
    border-radius: 50%; 
    object-fit: cover; 
    border: 3px solid #a0522d; 
    margin-bottom: 5px; 
    transition: transform 0.3s;
    background: #fff8e1; 
    display: flex; 
    justify-content: center; 
    align-items: center;
}
/* Existing image style */
.member-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid #a0522d; margin-bottom: 5px; transition: transform 0.3s; }

.member-img:hover, .member-img-placeholder:hover { transform: scale(1.05); }

.member-info { color: #5d4037; font-size: 0.85rem; font-weight: 700; line-height: 1.2; text-transform: uppercase; text-align: center; padding-top: 5px; }
.collapse-btn { position: absolute; top: -12px; right: -12px; background: #3b82f6; color: white; border: 2px solid #fff; border-radius: 50%; width: 25px; height: 25px; display: flex; justify-content: center; align-items: center; font-size: 14px; cursor: pointer; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); z-index: 10; transition: background 0.3s; }
.collapse-btn:hover { background: #1e40af; }
.collapsed > ul { display: none; }
.collapsed > .member-card-wrapper > .collapse-btn { background: #10b981; }
/* Connectors */
.family-tree li::after { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #8d6e63; border-top: 1px solid #8d6e63; width: 50%; height: 25px; }
.family-tree li::before { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #8d6e63; width: 50%; height: 25px; }
.family-tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #8d6e63; width: 0; height: 25px; }
.family-tree ul:first-child > li::before, .family-tree ul:first-child > li::after { content: none; height: 0; }
.family-tree li:first-child::before { border: none; }
.family-tree li:last-child:not(:only-child)::after { border-top: none; width: 0; }
.family-tree li:only-child::before, .family-tree li:only-child::after { border: none; }
.family-tree li:only-child::after { border-left: 1px solid #8d6e63 !important; }


/* ------------------------------------------------------------- */
/* ---------- SHAHJRA HORIZONTAL TREE STYLES (Unique Classes) ------------------------------- */
/* ------------------------------------------------------------- */
.shajra-horizontal-tree {
    /* Main container needs extra vertical space for layout */
    padding: 50px 10px; 
}
.shajra-horizontal-tree > ul { 
    /* The root ul should be horizontal */
    flex-direction: row; 
    justify-content: flex-start;
    padding-top: 0; 
    margin: 0;
    width: max-content; /* Allow content to dictate width */
}
.shajra-horizontal-tree ul ul {
    /* All children ul should display children vertically, add vertical connector line */
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    position: relative;
    padding-left: 40px;
    border-left: 1px solid #8d6e63; /* Vertical line from parent generation to children */
    margin: 0;
    transition: none; /* Disable transition on UL to prevent odd rotation */
}
/* Clear standard vertical connectors */
.shajra-horizontal-tree li::after, .shajra-horizontal-tree li::before, .shajra-horizontal-tree ul ul::before {
    content: none !important;
    border: none !important;
}
/* Horizontal line from the vertical line to the member card (li::before) */
.shajra-horizontal-tree li::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    border-top: 1px solid #8d6e63;
    width: 40px;
    height: 0;
    transform: translateY(-50%);
}
/* Horizontal line segment 2 (from line to card) (li::after) */
.shajra-horizontal-tree li::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 40px;
    border-top: 1px solid #8d6e63;
    width: 40px;
    height: 0;
    transform: translateY(-50%);
}
/* Root node has no incoming lines */
.shajra-horizontal-tree > ul > li::before, .shajra-horizontal-tree > ul > li::after {
    content: none !important;
}
/* Reposition collapse button */
.shajra-horizontal-tree .collapse-btn {
    top: 50%;
    right: -25px;
    transform: translateY(-50%);
}
</style>
</head>
<body>
<header>
    <div class="site-title" id="mainTitle">Loading...</div>
    <a href="admin.html" class="admin-btn"><i class="fa-solid fa-lock"></i> Admin</a>
</header>

<div class="shajra-navbar">
    <a href="index.html" class="shajra-nav-btn active"><i class="fa-solid fa-house-chimney"></i> Home</a>
    <button onclick="openAnalytics()" class="shajra-nav-btn"><i class="fa-solid fa-chart-pie"></i> Stats</button>
    <button onclick="openAbout()" class="shajra-nav-btn"><i class="fa-solid fa-circle-info"></i> About</button>
    <div class="shajra-dropdown">
        <button onclick="toggleMenu()" class="shajra-nav-btn"><i class="fa-solid fa-bars-staggered"></i> Menu</button>
        <div id="myDropdown" class="shajra-dropdown-menu">
            <a href="#" onclick="openAllMembers(event)"><i class="fa-solid fa-list-ul"></i> All Members</a>
            <a href="#" onclick="handleSearchToggle(false)"><i class="fa-solid fa-magnifying-glass"></i> Search</a>
            <a href="#" onclick="openEvents()"><i class="fa-solid fa-calendar-alt"></i> Events/Birthdays</a>
        </div>
    </div>
</div>

<div id="searchContainer" class="shajra-search-container" style="display: none;">
    <input type="text" id="memberSearchInput" placeholder="Search by Member Name (Full/Partial)..." onkeyup="handleSearchInput(this.value)">
    <button class="search-close-btn" onclick="handleSearchToggle(true)">
        <i class="fa-solid fa-xmark"></i>
    </button>
</div>
<div id="searchResults" class="search-results-container" style="display: none;">
    </div>

<div class="heading-container">
    <div class="root-select-container">
        <select id="rootMemberSelect" onchange="loadFamilyTree(this.value)">
            </select>
    </div>
    <h1 class="family-name-display" id="currentFamilyName"><i class="fa-solid fa-sitemap"></i> Loading...</h1>
    
    <div class="shajra-utility-container">
        <button id="toggleViewBtn" onclick="toggleView()">
            <i class="fa-solid fa-expand"></i> Horizontal
        </button>
        <div class="toggle-deceased-box">
            <label class="toggle-switch">
                <input type="checkbox" id="deceasedToggle" onchange="toggleDeceasedVisibility(this.checked)" checked>
                <span class="slider round"></span>
            </label>
            <span style="font-size: 12px; color: white;">Show Deceased</span>
        </div>
        </div>
    </div>

<div id="visualTreeContainer" class="family-tree">
    </div>

<div id="detailModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeDetail()">
    <div class="shajra-modal-content" style="max-width: 400px; padding: 15px;">
        <span class="shajra-modal-close-x" onclick="closeDetail()">&times;</span>
        <div id="modalContentArea">
            <div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>
        </div>
    </div>
</div>

<div id="passcodeModal" class="shajra-modal-overlay">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closePasscodeModal()">&times;</span>
        <i class="fa-solid fa-user-shield passcode-icon"></i>
        <div class="shajra-modal-title" style="margin-bottom: 10px;">Security Check</div>
        <div class="passcode-instruction">
            یہ ایک خاندانی عورت کی تفصیل ہے۔ تفصیل دیکھنے کے لیے پاس کوڈ درج کریں۔
        </div>
        <input type="password" id="femalePasscodeInput" class="passcode-input" placeholder="Passcode Darj Karein..." onkeydown="if(event.key==='Enter') verifyFemalePasscode();">
        <div id="passcodeError" class="passcode-error"></div>
        <button class="passcode-submit-btn" onclick="verifyFemalePasscode()">
            <i class="fa-solid fa-lock-open"></i> View Details 
        </button>
        <button onclick="closePasscodeModal()" class="shajra-modal-action-btn" style="margin-top: 15px; background: #e74c3c; color: white;">Cancel</button>
    </div>
</div>


<div id="allMembersModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeAllMembers()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closeAllMembers()">&times;</span>
        <div class="shajra-modal-title"><i class="fa-solid fa-list-ul"></i> All Members List</div>
        <div style="margin-bottom: 10px;">
            <input type="text" id="allMembersSearch" placeholder="Search in list..." 
                   onkeyup="searchMemberList(this.value)" 
                   style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 100%; max-width: 300px; font-size: 13px;">
        </div>
        <div style="max-height: 50vh; overflow-y: auto;">
            <table class="all-members-table">
                <thead id="memberListHeader">
                    <tr>
                        <th class="sortable asc" data-sort="full_name" style="width: 30%;">Name</th>
                        <th class="sortable" data-sort="parent_name" style="width: 30%;">Parent</th>
                        <th class="sortable" data-sort="is_alive" style="width: 15%;">Status</th>
                        <th class="sortable" data-sort="dob" style="width: 15%;">Age</th>
                        <th style="width: 10%;">Details</th>
                    </tr>
                </thead>
                <tbody id="memberListBody">
                    </tbody>
            </table>
        </div>
        <button onclick="closeAllMembers()" class="shajra-modal-action-btn">Close</button>
    </div>
</div>

<div id="analyticsModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeAnalytics()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closeAnalytics()">&times;</span>
        <div class="shajra-modal-title" style="display: block; text-align: center;">
    <i class="fa-solid fa-chart-simple"></i> Statistics (شماریات)
    <span id="statsContextTitle" style="display: block; font-size: 13px; font-weight: 500; color: #7f8c8d; margin-top: 5px;">(Puri Family)</span>
</div>
        <div class="analytics-stats-grid">
            <div class="analytics-stat-card" style="grid-column: span 2;">
                <span class="stat-number" id="statTotal">0</span><span class="stat-urdu">کل افراد</span>
            </div>
            <div class="analytics-stat-card"><span class="stat-number" id="statMale">--</span><span class="stat-urdu">مرد /</span><span class="stat-urdu">عورت</span></div>
            <div class="analytics-stat-card"><span class="stat-number" id="statAlive">--</span><span class="stat-urdu">زندہ /</span><span class="stat-urdu">انتقال</span></div>
        </div>
        <div class="analytics-fun-box">
            <div style="font-weight:bold; font-size:13px; margin-bottom:8px; color:#1565c0;">Dilchasp Malumat:</div>
            <div class="fun-item"><span>Oldest Member (DOB)</span><span id="statOldest">N/A</span></div>
            <div class="fun-item"><span>Youngest Member (DOB)</span><span id="statYoungest">N/A</span></div>
        </div>
        <button onclick="closeAnalytics()" class="shajra-modal-action-btn">Close</button>
    </div>
</div>

<div id="eventsModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeEvents()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closeEvents()">&times;</span>
        <div class="shajra-modal-title"><i class="fa-solid fa-calendar-alt"></i> Family Events</div>
        
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
            <button class="event-tab-btn active-tab" onclick="changeEventTab(this, 'upcoming')">Upcoming</button>
            <button class="event-tab-btn" onclick="changeEventTab(this, 'past')">Past</button>
        </div>

        <div id="upcomingEventsContainer" class="event-list-container">
            <div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading events...</div>
        </div>
        <div id="pastEventsContainer" class="event-list-container" style="display: none;">
            </div>

        <button onclick="closeEvents()" class="shajra-modal-action-btn">Close</button>
    </div>
</div>

<div id="aboutModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeAbout()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closeAbout()">&times;</span>
        <div class="shajra-modal-title"><i class="fa-solid fa-circle-info"></i> About This Shajra</div>
        <div class="about-urdu-text-style" id="dynamicUrduText">
            (Loading Urdu text from settings...)
        </div>
        
        <div class="about-contact-box-style">
            <div style="font-size:16px; font-weight:700; color:#e74c3c; margin-bottom:10px; border-bottom: 2px solid #ffcc80; padding-bottom: 5px; text-align: center;"><i class="fa-solid fa-headset"></i> رابطہ کریں</div>

            <p style="font-size:14px; margin-top:0; color:#555; text-align: center;" id="dynamicAboutText">
                (Loading Contact text from settings...)
            </p>
            <p style="font-size:15px; font-weight:700; color:#1e88e5; margin-bottom:15px; margin-top:15px; text-align: center;">
                <span id="dynamicPhone">N/A</span>
            </p>
            <a href="#" id="dynamicWhatsapp" target="_blank" class="contact-whatsapp-btn-style">
                <i class="fa-brands fa-whatsapp"></i> WhatsApp
            </a>
        </div>
        <div class="features-list-box-style">
            <div style="font-weight:bold; font-size:14px; color:#388e3c;">Features:</div>
            <ul id="featuresList">
                <li>Responsive Design</li>
                <li>Passcode Security for Female Details</li>
            </ul>
        </div>
        <button onclick="closeAbout()" class="shajra-modal-action-btn">Close</button>
    </div>
</div>


<script>
// Function to mask female names (e.g., Maryam -> Ma****)
function maskFemaleName(fullName, gender) {
    // Check 1: If it's female
    if (gender && gender.toLowerCase() === 'f') {
        // Check 2: Mask ONLY if a password is set.
        if (femalePasscode) {
            if (!fullName || fullName.length < 2) return 'F-****';
            // Take the first two characters (case insensitive)
            const firstTwo = fullName.substring(0, 2);
            // Mask the rest of the characters
            const maskedPart = '*'.repeat(fullName.length - 2);
            return firstTwo + maskedPart;
        }
    }
    // Agar male hai ya female hai par password set nahi hai, toh poora naam return karein
    return fullName;
}

// --- Age Calculation Function (Updated in Detail Modal) ---
function calculateAge(dob, dod, isAlive) {
    if (!dob) return 'N/A';

    const dobDate = new Date(dob);
    let today = new Date();
    let endDate = today;
    let statusText = '(Age:';

    if (!isAlive && dod) {
        endDate = new Date(dod);
        statusText = '(Passed away at:';
    } else if (!isAlive && !dod) {
        statusText = '(Deceased, Age:';
    }

    let age = endDate.getFullYear() - dobDate.getFullYear();
    const monthDifference = endDate.getMonth() - dobDate.getMonth();

    if (monthDifference < 0 || (monthDifference === 0 && endDate.getDate() < dobDate.getDate())) {
        age--;
    }

    if (age < 0) return 'N/A'; // Should not happen

    return `${statusText} ${age} years)`;
}

// Helper for All Members List sorting
function getAgeForList(dob, isAlive, dod) {
    if (!dob) return -1; // Sorts N/A members last

    const dobDate = new Date(dob);
    let endDate = isAlive ? new Date() : new Date(dod);

    if (!isAlive && !dod) return -1; // If deceased but DOD is missing

    let age = endDate.getFullYear() - dobDate.getFullYear();
    const monthDifference = endDate.getMonth() - dobDate.getMonth();
    if (monthDifference < 0 || (monthDifference === 0 && endDate.getDate() < dobDate.getDate())) {
        age--;
    }
    return age;
}

// --- Navigation/Modal Functions ---
function toggleMenu() {
    document.getElementById("myDropdown").classList.toggle("show");
}

// UPDATED: handleSearchToggle to clear search results and use allMembersData
function handleSearchToggle(isForcedClose) {
    const searchContainer = document.getElementById('searchContainer');
    const searchResults = document.getElementById('searchResults');
    
    if (searchContainer.style.display === 'flex' || isForcedClose) {
        // Close action
        searchContainer.style.display = 'none';
        document.getElementById('memberSearchInput').value = ''; 
        searchResults.innerHTML = ''; // NEW: Clear search results
        searchResults.style.display = 'none'; // NEW: Hide search results
        
        // Reload full tree only if a root is selected (clears any partial search view if filterTree was manually run)
        if (currentRootId) loadFamilyTree(currentRootId); 
    } else {
        // Open action (Only triggered by menu click)
        searchContainer.style.display = 'flex';
        document.getElementById('memberSearchInput').focus();
    }
    document.getElementById("myDropdown").classList.remove('show');
}

function openAbout(){
    document.getElementById("aboutModal").style.display="flex";
    document.getElementById("myDropdown").classList.remove('show');
}
function closeAbout(){
    document.getElementById("aboutModal").style.display="none";
}
// UPDATED: openAnalytics now calls calcStats with the current root ID
function openAnalytics(){
    document.getElementById("analyticsModal").style.display="flex";
    // Pass the currently selected root ID for scoped stats
    calcStats(currentRootId); 
}
function closeAnalytics(){
    document.getElementById("analyticsModal").style.display="none";
}
function closeDetail(){
    document.getElementById("detailModal").style.display="none";
}

// --- Passcode Modal Functions ---
function openPasscodeModal(data) {
    tempMemberData = data; // We display the detail modal behind it so it gets the overlay effect, but it's empty
    document.getElementById("detailModal").style.display = "flex";
    document.getElementById('passcodeError').innerText = ''; // Clear previous errors
    document.getElementById('femalePasscodeInput').value = ''; // Clear input
    document.getElementById("passcodeModal").style.display = "flex";
    // Focus on input after modal is displayed
    setTimeout(() => document.getElementById('femalePasscodeInput').focus(), 100);
}
function closePasscodeModal() {
    document.getElementById("passcodeModal").style.display = "none";
    // Also close the detail modal overlay
    document.getElementById("detailModal").style.display = "none";
    tempMemberData = null; // Clear temporary data
}
// Function to handle passcode submission
async function verifyFemalePasscode() {
    const inputField = document.getElementById('femalePasscodeInput');
    const errorDisplay = document.getElementById('passcodeError');
    const inputPasscode = inputField.value.trim();

    if (!inputPasscode) {
        errorDisplay.innerText = 'Passcode lazmi hai.';
        return;
    }

    if (inputPasscode === femalePasscode) {
        errorDisplay.innerText = '';
        closePasscodeModal();
        // The checkAndLoadDetail function will be called with the temporary data, bypassing the security check
        if (tempMemberData) {
             // Since tempMemberData only has ID, Name, Gender, fetch full details now
             const { data: fullData, error } = await _supabase.from('family_data').select('*').eq('id', tempMemberData.id).single();
             if (error) {
                 console.error("Error fetching full details:", error);
                 document.getElementById("detailModal").style.display = "none";
                 alert("تفصیلات لوڈ نہیں ہو سکی۔");
                 return;
             }
             renderAndShowDetailModal(fullData);
        }
    } else {
        errorDisplay.innerText = 'Ghalat Passcode. Dubara koshish karein.';
        inputField.value = '';
    }
}

// Helper function to check for passcode requirement and load data
function checkAndLoadDetail(data) {
    const isFemale = data.gender && data.gender.toLowerCase() === 'f';
    const isProtected = isFemale && femalePasscode;

    if (isProtected) {
        // If protected, open the passcode modal
        openPasscodeModal(data);
    } else {
        // If not protected, proceed to load details
        document.getElementById("detailModal").style.display = "flex";
        renderAndShowDetailModal(data);
    }
}


// Renamed original logic to this helper function
async function renderAndShowDetailModal(data) {
    const modalContentArea = document.getElementById('modalContentArea');
    
    // We already have full data from the global cache (or fetched after passcode verification)
    
    // detailModal is already shown by checkAndLoadDetail (or openPasscodeModal)
    const statusText = data.is_alive ? 'زندہ (Alive)' : 'انتقال کر گئے (Deceased)';
    const genderText = data.gender ? (data.gender.toLowerCase() === 'm' ? 'مرد (Male)' : 'عورت (Female)') : 'N/A';
    const dobText = data.dob ? formatDate(data.dob) : 'N/A';
    const dodText = data.dod ? formatDate(data.dod) : 'N/A';
    const ageInfo = calculateAge(data.dob, data.dod, data.is_alive);
    const relationText = data.is_alive ? 'Family Member' : 'Late Family Member'; // Could be improved
    
    const spouse = allMembersData.find(m => m.id === data.spouse_id);
    let spouseHtml = '';
    if (spouse) {
        const spouseName = maskFemaleName(spouse.full_name, spouse.gender);
        spouseHtml = `<div class="modal-data-row"><span>Spouse</span><span>${spouseName}</span></div>`;
    }
    
    const phoneText = data.phone || 'N/A';
    
    let profileImageHtml = '';
    if (data.image_url) {
        profileImageHtml = `<img src="${data.image_url}" alt="${data.full_name}" class="modal-profile-img">`;
    } else {
        // NEW: Placeholder icon if no image
        const iconClass = data.gender && data.gender.toLowerCase() === 'f' ? 'fa-person-dress' : 'fa-person';
        const iconColor = data.gender && data.gender.toLowerCase() === 'f' ? '#d90429' : '#1e40af';
        profileImageHtml = `<div class="modal-profile-icon"> <i class="fa-solid ${iconClass}" style="font-size: 60px; color: ${iconColor};"></i> </div>`;
    }

    // Name is shown in full here as user provided the passcode
    const modalHtml = `
        ${profileImageHtml}
        <div class="modal-full-name">${data.full_name}</div>
        <div class="modal-relation">رشتہ: ${relationText}</div>
        <div class="detail-data-section" style="margin-top:20px;">
            <div class="modal-data-row"><span>Status</span><span>${statusText}</span></div>
            <div class="modal-data-row"><span>Age</span><span>${ageInfo}</span></div>
            <div class="modal-data-row"><span>Gender</span><span>${genderText}</span></div>
            <div class="modal-data-row"><span>Date of Birth</span><span>${dobText}</span></div>
            ${data.is_alive ? '' : `<div class="modal-data-row"><span>Date of Death</span><span>${dodText}</span></div>`}
            ${spouseHtml}
            <div class="modal-data-row"><span>Phone/Contact</span><span>${phoneText}</span></div>
        </div>
    `;
    modalContentArea.innerHTML = modalHtml;
}

// NEW ENTRY POINT: openMemberDetail (Performs password check if female)
async function openMemberDetail(memberId) {
    const data = allMembersData.find(m => m.id == memberId);
    if (!data) {
        // Fallback: If data is not in cache, fetch it minimally for check
        const { data: fetchedData } = await _supabase.from('family_data').select('id, full_name, gender').eq('id', memberId).single();
        if (!fetchedData) { alert("Member data not found!"); return; }
        // Need to load full data later if required, but proceed with check
        return checkAndLoadDetail(fetchedData);
    }
    checkAndLoadDetail(data);
}

// --- Events Functions ---
function changeEventTab(btn, type) {
    document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active-tab'));
    btn.classList.add('active-tab');
    document.getElementById('upcomingEventsContainer').style.display = type === 'upcoming' ? 'block' : 'none';
    document.getElementById('pastEventsContainer').style.display = type === 'past' ? 'block' : 'none';
}

// Helper to format date
function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

// Calculates days difference
function calculateDaysDifference(date) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const eventDate = new Date(date);
    eventDate.setHours(0, 0, 0, 0);
    
    // Check if the event is for the current year, and if it has passed, use next year
    const currentYear = today.getFullYear();
    let nextEventDate = new Date(currentYear, eventDate.getMonth(), eventDate.getDate());
    
    // If the event has already passed this year, set it for next year
    if (nextEventDate < today) {
        nextEventDate = new Date(currentYear + 1, eventDate.getMonth(), eventDate.getDate());
    }

    const diffTime = nextEventDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Today!';
    if (diffDays === 1) return 'Tomorrow';
    if (diffDays > 0) return `in ${diffDays} days`;
    
    // For past events in the current calendar year (handled in loadEvents)
    if (diffDays === -1) return 'Yesterday';
    return `${Math.abs(diffDays)} days ago`; // Should not hit this path if logic is correct
}

// Main logic for fetching and displaying events
async function loadEvents() {
    const upcomingContainer = document.getElementById('upcomingEventsContainer');
    const pastContainer = document.getElementById('pastEventsContainer');
    upcomingContainer.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading events...</div>';
    pastContainer.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading events...</div>';
    
    // Use global allMembersData if loaded, otherwise fetch it.
    const members = allMembersData.length > 0 ? allMembersData : (await _supabase.from('family_data').select('*')).data || [];
    
    const events = [];
    const today = new Date();
    const currentYear = today.getFullYear();
    today.setHours(0, 0, 0, 0);

    members.forEach(member => {
        const name = maskFemaleName(member.full_name, member.gender);

        // 1. Birthday Event
        if (member.dob) {
            const dobDate = new Date(member.dob);
            
            // Calculate upcoming birthday date
            let birthdayThisYear = new Date(currentYear, dobDate.getMonth(), dobDate.getDate());
            if (birthdayThisYear < today) {
                birthdayThisYear = new Date(currentYear + 1, dobDate.getMonth(), dobDate.getDate());
            }

            events.push({
                id: member.id,
                date: birthdayThisYear,
                type: 'birthday',
                title: `${name}'s Birthday`,
                icon: 'fa-cake-candles',
                isAlive: member.is_alive
            });
        }

        // 2. Death Anniversary Event
        if (!member.is_alive && member.dod) {
            const dodDate = new Date(member.dod);
            
            // Calculate upcoming death anniversary date
            let anniversaryThisYear = new Date(currentYear, dodDate.getMonth(), dodDate.getDate());
            if (anniversaryThisYear < today) {
                anniversaryThisYear = new Date(currentYear + 1, dodDate.getMonth(), dodDate.getDate());
            }

            events.push({
                id: member.id,
                date: anniversaryThisYear,
                type: 'death',
                title: `${name}'s Death Anniversary`,
                icon: 'fa-cross',
                isAlive: false
            });
        }
    });

    events.sort((a, b) => a.date - b.date);

    // Separate into upcoming and past events (relative to today)
    const upcomingEvents = [];
    const pastEvents = [];

    events.forEach(event => {
        // If the event is today or in the future
        if (event.date.getTime() >= today.getTime()) {
            upcomingEvents.push(event);
        } else {
            // Only add to past if it occurred in the current calendar year
            if (event.date.getFullYear() === currentYear) {
                pastEvents.push(event);
            }
        }
    }); 
    
    // Render lists (Past events are shown newest first)
    renderEventList(upcomingEvents, upcomingContainer, 'upcoming');
    renderEventList(pastEvents.reverse(), pastContainer, 'past');
}

function renderEventList(events, container, type) {
    if (events.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#777; padding:20px;">
            <i class="fa-solid fa-circle-info"></i> No ${type} events found for this year. 
        </div>`;
        return;
    }

    let html = '';
    events.forEach(event => {
        const daysDiffText = calculateDaysDifference(event.date);
        const cardClass = type === 'past' ? 'past' : '';
        const cardColor = event.type === 'death' ? '#e74c3c' : (event.type === 'birthday' ? '#2ecc71' : '#3498db');

        html += `
            <div class="event-card ${cardClass}" style="border-left-color: ${cardColor};">
                <div class="event-icon" style="color: ${cardColor};">
                    <i class="fa-solid ${event.icon}"></i>
                </div>
                <div class="event-details">
                    <div class="event-title">${event.title}</div>
                    <div class="event-date">
                        ${formatDate(event.date)} 
                        <span class="event-days">${type === 'upcoming' ? daysDiffText : ''}</span>
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function openEvents() {
    loadEvents();
    document.getElementById("eventsModal").style.display="flex";
    document.getElementById("myDropdown").classList.remove('show');
}
function closeEvents() {
    document.getElementById("eventsModal").style.display="none";
}


// --- All Members List Functions ---
function openAllMembers(event){
    event.preventDefault(); // Stop link navigation
    document.getElementById("allMembersModal").style.display="flex";
    document.getElementById("myDropdown").classList.remove('show');
    // Clear search and reset sort before loading
    document.getElementById('allMembersSearch').value = '';
    currentSortColumn = 'full_name'; 
    currentSortDirection = 'asc'; 
    renderMemberList();
    setupSortListeners();
}
function closeAllMembers(){
    document.getElementById("allMembersModal").style.display="none";
}

// Function to sort the array
function sortMemberList(a, b) {
    const column = currentSortColumn;
    const dir = currentSortDirection === 'asc' ? 1 : -1;
    let valA = a[column];
    let valB = b[column];

    // Custom handling for Age sorting (using DOB column)
    if (column === 'dob') {
        valA = getAgeForList(a.dob, a.is_alive, a.dod);
        valB = getAgeForList(b.dob, b.is_alive, b.dod);
        if (valA === -1) return dir * 1;
        if (valB === -1) return dir * -1;
        // Sort by Age (Largest Age first for 'asc' means oldest first)
        return dir * (valB - valA); 
    }
    
    // Custom handling for Parent Name sorting (we need to get the parent's full name)
    if (column === 'parent_name') {
        const parentA = allMembersData.find(m => m.id === a.parent_id);
        const parentB = allMembersData.find(m => m.id === b.parent_id);
        valA = parentA ? parentA.full_name : '';
        valB = parentB ? parentB.full_name : '';
    }

    // Custom handling for Status (is_alive boolean)
    if (column === 'is_alive') {
        valA = a.is_alive ? 1 : 0;
        valB = b.is_alive ? 1 : 0;
        // Alive first
        return dir * (valB - valA);
    }

    // Default string comparison
    if (typeof valA === 'string') {
        return dir * (valA || '').localeCompare((valB || ''), 'en', { sensitivity: 'base' });
    }

    // Default numeric comparison
    if (valA < valB) return dir * -1;
    if (valA > valB) return dir * 1;
    return 0;
}

// Function to render the table body (UPDATED to use masked name)
function renderMemberList(members = allMembersData) {
    const body = document.getElementById('memberListBody');
    body.innerHTML = '';
    
    // Apply sorting before rendering
    members.sort(sortMemberList);

    // Update table header icons
    document.querySelectorAll('#memberListHeader .sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.getAttribute('data-sort') === currentSortColumn) {
            th.classList.add(currentSortDirection);
        }
    });

    if (members.length === 0) {
        body.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#777; padding:20px;">No members found.</td></tr>`;
        return;
    }

    let html = '';
    members.forEach(member => {
        const nameToDisplay = maskFemaleName(member.full_name, member.gender);
        
        const parent = allMembersData.find(m => m.id === member.parent_id);
        const parentName = parent ? maskFemaleName(parent.full_name, parent.gender) : 'N/A (Root)';
        
        const statusText = member.is_alive ? 'Alive' : 'Deceased';
        const age = getAgeForList(member.dob, member.is_alive, member.dod);
        const ageText = age >= 0 ? `${age} yrs` : 'N/A';
        
        html += `
            <tr>
                <td>${nameToDisplay}</td>
                <td>${parentName}</td>
                <td>${statusText}</td>
                <td>${ageText}</td>
                <td><button class="details-link" onclick="openMemberDetail(${member.id})">View</button></td>
            </tr>
        `;
    });
    body.innerHTML = html;
}

function searchMemberList(searchText) {
    const text = searchText.toLowerCase().trim();
    if (!text) {
        renderMemberList(allMembersData);
        return;
    }
    
    const filtered = allMembersData.filter(member => {
        const name = (member.full_name || '').toLowerCase();
        const parent = allMembersData.find(m => m.id === member.parent_id);
        const parentName = (parent ? parent.full_name : '').toLowerCase();
        const status = (member.is_alive ? 'alive' : 'deceased').toLowerCase();
        
        return name.includes(text) || parentName.includes(text) || status.includes(text);
    });
    
    renderMemberList(filtered);
}

// Listener for table header clicks
function setupSortListeners() {
    document.querySelectorAll('#memberListHeader .sortable').forEach(th => {
        th.addEventListener('click', function() {
            const newColumn = this.getAttribute('data-sort');
            if (currentSortColumn === newColumn) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = newColumn;
                currentSortDirection = 'asc'; // Default ascending for new column
            }
            renderMemberList();
        });
    });
}
// --- END All Members List Functions ---


// NEW: Function to find the path of IDs from the root to a member
function findPathToMember(targetMemberId, rootId) {
    // If the target is the root itself
    if (targetMemberId === rootId) return [rootId];
    
    const path = [];
    let current = allMembersData.find(m => m.id === targetMemberId);

    // Loop upwards until we reach the ultimate root or a parent is missing
    while (current && current.id !== rootId) {
        path.unshift(current.id); // Add current member to the front of the path
        current = allMembersData.find(m => m.id === current.parent_id);
    }
    
    // If the loop stopped because current.id === rootId, add the root id to the front
    if (current && current.id === rootId) {
        path.unshift(rootId);
    } else if (path.length > 0) {
         // If we stopped before reaching the intended rootId (e.g. rootId is wrong/missing parent), just return the path found
         return path;
    }

    return path; 
}


// NEW: Function to handle instant search input
function handleSearchInput(searchText) {
    const resultsContainer = document.getElementById('searchResults');
    const text = searchText.toLowerCase().trim();
    
    // Clear previous results and hide if search text is too short
    if (text.length < 2) {
        resultsContainer.innerHTML = '';
        resultsContainer.style.display = 'none';
        // Reload main tree view if search bar is cleared
        if (currentRootId) loadFamilyTree(currentRootId); 
        return;
    }
    
    // Filter members
    const matchingMembers = allMembersData.filter(member => 
        member.full_name && member.full_name.toLowerCase().includes(text)
    ).slice(0, 10); // Limit to 10 results

    let html = '';
    
    if (matchingMembers.length === 0) {
        html = '<div style="padding: 10px; color: #777; font-size: 13px; text-align: center;">کوئی ممبر نہیں ملا۔</div>';
    } else {
        matchingMembers.forEach(member => {
            // Find parent for context (Display Context Feature)
            const parent = allMembersData.find(m => m.id === member.parent_id);
            const parentName = parent ? maskFemaleName(parent.full_name, parent.gender) : 'Root / No Parent';
            const nameToDisplay = maskFemaleName(member.full_name, member.gender);
            const iconClass = member.gender && member.gender.toLowerCase() === 'f' ? 'fa-person-dress' : 'fa-person';
            const iconColor = member.gender && member.gender.toLowerCase() === 'f' ? '#e74c3c' : '#3498db';

            html += `
                <div class="search-result-item" onclick="selectMemberFromSearch(${member.id})">
                    <div class="result-icon" style="color: ${iconColor};">
                        <i class="fa-solid ${iconClass}"></i>
                    </div>
                    <div class="result-info">
                        <div class="result-name">${nameToDisplay}</div>
                        <div class="result-parent">Son/Daughter of: ${parentName}</div>
                    </div>
                </div>
            `;
        });
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
}

// NEW: Function to handle selecting a member from the search list (Locate & Highlight Feature)
function selectMemberFromSearch(memberId) {
    const member = allMembersData.find(m => m.id === memberId);
    if (!member) return;

    // Find the ultimate root of this member (the one with no parent)
    let root = member;
    while (root.parent_id) {
        const parent = allMembersData.find(m => m.id === root.parent_id);
        if (parent) {
            root = parent;
        } else {
            break;
        }
    }
    const ultimateRootId = root.id;

    // 1. Find the path of IDs from ultimateRootId to memberId
    const pathIds = findPathToMember(memberId, ultimateRootId);

    // 2. Hide search results and clear input
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('memberSearchInput').value = member.full_name; // Display full name in search box

    // 3. Set the root dropdown to the new root and load the tree with the path
    const rootSelect = document.getElementById('rootMemberSelect');
    rootSelect.value = ultimateRootId;
    
    // Load the tree using the new root and pass the path for auto-expansion/highlighting
    loadFamilyTree(ultimateRootId, pathIds);
}


// --- Tree Rendering Functions (Minor Updates for Global Data Cache) ---
function toggleChildren(btn, event) {
    event.stopPropagation();
    const li = btn.closest('li');
    li.classList.toggle('collapsed');
    btn.innerHTML = li.classList.contains('collapsed') ? '<i class="fa-solid fa-plus"></i>' : '<i class="fa-solid fa-minus"></i>';
}

// Recursive function to create the tree HTML
function createTreeHtml(member) {
    const nameToDisplay = maskFemaleName(member.full_name, member.gender);
    const hasChildren = member.children && member.children.length > 0;
    
    let imageHtml = '';
    if (member.image_url) {
        imageHtml = `<img src="${member.image_url}" alt="${nameToDisplay}" class="member-img">`;
    } else {
        const iconClass = member.gender && member.gender.toLowerCase() === 'f' ? 'fa-person-dress' : 'fa-person';
        const iconColor = member.gender && member.gender.toLowerCase() === 'f' ? '#e74c3c' : '#3498db';
        imageHtml = `<div class="member-img-placeholder"> <i class="fa-solid ${iconClass}" style="font-size: 30px; color: ${iconColor};"></i> </div>`;
    }
    
    // NEW: Add class for deceased members
    const isDeceased = !member.is_alive;
    const cardExtraClass = isDeceased ? 'deceased-member' : '';

    let html = `<li id="member-${member.id}" class="${hasChildren ? 'collapsed' : ''}"> 
        <div class="member-card-wrapper ${cardExtraClass}" onclick="openMemberDetail(${member.id})">
            ${imageHtml}
            <span class="member-info">${nameToDisplay.toUpperCase()}</span>
            ${hasChildren ? `<div class="collapse-btn" onclick="toggleChildren(this, event)"> <i class="fa-solid fa-plus"></i> </div>` : ''} 
        </div>`;

    if(hasChildren){
        html += "<ul>";
        member.children.forEach(child => html += createTreeHtml(child));
        html += "</ul>";
    }
    html += "</li>";
    return html;
}

// NEW: Function to toggle visibility of deceased members via CSS class
function toggleDeceasedVisibility(isChecked) {
    const container = document.getElementById('visualTreeContainer');
    if (!isChecked) {
        // If checkbox is unchecked, add class to hide
        container.classList.add('hide-deceased');
    } else {
        // If checked, remove class to show
        container.classList.remove('hide-deceased');
    }
}

function toggleView() {
    isHorizontal = !isHorizontal;
    const container = document.getElementById('visualTreeContainer');
    const toggleBtn = document.getElementById('toggleViewBtn');

    if (isHorizontal) {
        container.classList.add('shajra-horizontal-tree');
        container.classList.remove('family-tree');
        toggleBtn.innerHTML = '<i class="fa-solid fa-compress"></i> Vertical';
        // Horizontal view by default shows all children open
        document.querySelectorAll('.collapse-btn').forEach(btn => {
            btn.closest('li').classList.remove('collapsed');
            btn.innerHTML = '<i class="fa-solid fa-minus"></i>';
        });
    } else {
        container.classList.add('family-tree');
        container.classList.remove('shajra-horizontal-tree');
        loadFamilyTree(currentRootId); // Reload to reset collapse state
    }
}

// Function to fetch and load root members for the dropdown (unchanged)
async function loadRootMembers() {
    // This is only for the dropdown, so we fetch only root names/IDs
    const { data, error } = await _supabase.from('family_data').select('id, full_name').is('parent_id', null).order('full_name', { ascending: true });
    const select = document.getElementById('rootMemberSelect');
    select.innerHTML = '<option value="">-- فیملی کا انتخاب کریں --</option>';

    if (error) { console.error("Error loading root members:", error); return; }

    if (data && data.length > 0) {
        data.forEach(m => {
            select.innerHTML += `<option value="${m.id}">${m.full_name}</option>`;
        });
        select.value = data[0].id;
        loadFamilyTree(data[0].id);
    } else {
        document.getElementById('visualTreeContainer').innerHTML = `<div style='color:#777; padding:20px;'>فیملی کا کوئی ممبر نہیں ملا۔ ایڈمن پینل سے ممبر شامل کریں۔</div>`;
        document.getElementById('currentFamilyName').innerHTML = `<i class="fa-solid fa-sitemap"></i> کوئی ڈیٹا نہیں`;
    }
}

// UPDATED FUNCTION: Load tree based on selected rootId and apply view state
async function loadFamilyTree(rootId, pathIds = []) { // pathIds is new argument for expansion
    const container = document.getElementById('visualTreeContainer');
    const nameDisplay = document.getElementById('currentFamilyName');
    currentRootId = rootId;

    if (!rootId) {
        container.innerHTML = `<div style='color:#777; padding:20px;'>فیملی دیکھنے کے لیے اوپر سے کوئی رُوٹ (بنیادی ممبر) منتخب کریں۔</div>`;
        nameDisplay.innerHTML = `<i class="fa-solid fa-sitemap"></i> فیملی کا شجرہ`;
        return;
    }

    container.innerHTML = `<div style='text-align:center; padding:50px;'><i class="fa-solid fa-spinner fa-spin fa-2x"></i> Loading Family Tree...</div>`;
    
    // NEW: Fetch all data once if not yet loaded (for fast search/tree build)
    if (allMembersData.length === 0) {
        const { data: allData, error: allError } = await _supabase.from('family_data').select('*');
        if (allError) { console.error("Error loading all data:", allError); return; }
        allMembersData = allData || [];
    }

    const members = allMembersData; // Use the cached data

    const rootMember = members.find(m => m.id == rootId);
    if (!rootMember) {
        container.innerHTML = `<div style='color:red; padding:20px;'>Error: Root Member ID ${rootId} not found in data.</div>`;
        return;
    }

    nameDisplay.innerText = rootMember.full_name;

    // --- Existing recursive builder function ---
    function buildTree(parentId) {
        const children = members.filter(m => m.parent_id == parentId);
        if (children.length === 0) return null;

        return children.map(child => {
            return {
                ...child,
                children: buildTree(child.id) || []
            };
        });
    }

    const treeData = {
        ...rootMember,
        children: buildTree(rootId) || []
    };

    let treeHtml = '<ul>' + createTreeHtml(treeData) + '</ul>';

    container.innerHTML = treeHtml;
    
    // Apply the deceased visibility filter after rendering
    const deceasedToggle = document.getElementById('deceasedToggle');
    if (deceasedToggle) {
        toggleDeceasedVisibility(deceasedToggle.checked);
    }


    // Apply view state (Vertical/Horizontal)
    if (isHorizontal) {
        container.classList.add('shajra-horizontal-tree');
        container.classList.remove('family-tree');
        toggleBtn.innerHTML = '<i class="fa-solid fa-compress"></i> Vertical';
        // In horizontal view, children are open by default
        document.querySelectorAll('.collapse-btn').forEach(btn => {
            btn.closest('li').classList.remove('collapsed');
            btn.innerHTML = '<i class="fa-solid fa-minus"></i>';
        });
    } else {
        container.classList.add('family-tree');
        container.classList.remove('shajra-horizontal-tree');
    }
    
    // NEW: Tree Expansion Logic (Locate & Highlight)
    if(pathIds.length > 0) {
        setTimeout(() => {
            // Path IDs contains [RootId, MemberA, MemberB, TargetId]
            // We need to ensure all elements up to the target are expanded.
            
            // Toggle the collapse status of all parents in the path
            for (let i = 0; i < pathIds.length; i++) {
                const currentId = pathIds[i];
                const currentElement = document.getElementById(`member-${currentId}`);
                
                // If the element is a parent (has children) and is collapsed, expand it.
                if (currentElement && currentElement.classList.contains('collapsed')) {
                    const collapseBtn = currentElement.querySelector('.collapse-btn');
                    if (collapseBtn) {
                        const dummyEvent = { stopPropagation: () => {} };
                        toggleChildren(collapseBtn, dummyEvent);
                    }
                }
            }
            
            // Highlight the target member (the last ID in pathIds)
            const targetMemberId = pathIds[pathIds.length - 1];
            const targetCard = document.querySelector(`#member-${targetMemberId} .member-card-wrapper`);
            if (targetCard) {
                // Ensure the element is visible by scrolling the container
                targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                targetCard.classList.add('highlighted-member');
                // Remove highlight after 5 seconds
                setTimeout(() => {
                    targetCard.classList.remove('highlighted-member');
                }, 5000);
            }
        }, 50);
    }
}


// NEW: Helper function to get the current root member and all their descendants.
function getDescendantsAndSelf(rootId) {
    if (!rootId || allMembersData.length === 0) return [];

    const rootMember = allMembersData.find(m => m.id == rootId);
    if (!rootMember) return [];

    const scopedMembers = [rootMember];
    const queue = [rootId];
    const processedIds = new Set([rootId]);

    // Use a Breadth-First Search (BFS) approach to find all children recursively
    let head = 0;
    while (head < queue.length) {
        const parentId = queue[head++];
        
        allMembersData.forEach(member => {
            if (member.parent_id == parentId && !processedIds.has(member.id)) {
                processedIds.add(member.id);
                scopedMembers.push(member);
                queue.push(member.id);
            }
        });
    }

    return scopedMembers;
}

// --- Analytics/Stats Functions ---
// UPDATED: Now accepts rootId to scope the data
async function calcStats(rootId) { 
    // If allMembersData is empty, fetch it first (unchanged logic)
    if (allMembersData.length === 0) {
        const { data, error } = await _supabase.from('family_data').select('*');
        if (error) { console.error("Error loading stats data:", error); return; }
        allMembersData = data || [];
    }
    
    // --- NEW: Filter data based on the current root ---
    const membersInBranch = getDescendantsAndSelf(rootId);
    const data = membersInBranch;
    
    const rootMember = allMembersData.find(m => m.id == rootId);
    const rootName = rootMember ? maskFemaleName(rootMember.full_name, rootMember.gender) : 'Puri Family';
    
    // Update the modal title to show context
    const contextTitleElement = document.getElementById('statsContextTitle');
    if (rootId) {
        contextTitleElement.innerHTML = `(<span style="font-weight: 700;">${rootName}</span> ki nasl)`;
    } else {
        contextTitleElement.innerText = '(Puri Family)';
    }
    // --- END NEW ---

    // Check if there is data to process
    if (data.length === 0) {
         document.getElementById('statTotal').innerText = 0;
         document.getElementById('statMale').innerText = '0 / 0';
         document.getElementById('statAlive').innerText = '0 / 0';
         document.getElementById('statOldest').innerText = 'N/A';
         document.getElementById('statYoungest').innerText = 'N/A';
         return; // Exit if no data
    }
    
    // The rest of the logic runs on the 'data' array (membersInBranch)
    let total = data.length;
    let m = 0; // Male count
    let f = 0; // Female count
    let a = 0; // Alive count
    let d = 0; // Deceased count

    let oldestDob = '2100-01-01'; // Future date (to find the earliest DOB)
    let oldestMember = null;
    let youngestDob = '1900-01-01'; // Past date (to find the latest DOB)
    let youngestMember = null;

    data.forEach(x=>{
        // Gender counting
        if(x.gender) {
            if(x.gender.toLowerCase().startsWith('m')) m++;
            else f++;
        }

        // Alive/Deceased counting
        if(x.is_alive!==undefined){
            if(x.is_alive) a++;
            else d++;
        }

        // Oldest/Youngest calculation
        if(x.dob) {
            // Check for oldest (earliest date)
            if (x.dob < oldestDob) {
                oldestDob = x.dob;
                oldestMember = x;
            }
            // Check for youngest (latest date)
            if (x.dob > youngestDob) {
                youngestDob = x.dob;
                youngestMember = x;
            }
        }
    });

    // Displaying results in the modal (using IDs in HTML)
    document.getElementById('statTotal').innerText = total;
    document.getElementById('statMale').innerText = `${m} / ${f}`;
    document.getElementById('statAlive').innerText = `${a} / ${d}`;
    
    // Masking and displaying oldest/youngest members
    
    if (oldestMember) {
        document.getElementById('statOldest').innerText = maskFemaleName(oldestMember.full_name, oldestMember.gender);
    } else {
        document.getElementById('statOldest').innerText = 'N/A';
    }
    
    if (youngestMember) {
        document.getElementById('statYoungest').innerText = maskFemaleName(youngestMember.full_name, youngestMember.gender);
    } else {
        document.getElementById('statYoungest').innerText = 'N/A';
    }
}


// --- Site Initialization ---
async function loadSiteSettings() {
    // Select all columns to ensure 'female-pass' is fetched
    const { data } = await _supabase.from('site_config').select('*').limit(1); 
    
    if(data?.[0]){
        // Store the passcode fetched from the database column 'female-pass'
        femalePasscode = data[0]['female-pass'] || data[0].female_pass || null; 
        
        // Existing settings logic
        document.getElementById('mainTitle').innerText=data[0].site_name;
        document.getElementById('dynamicUrduText').innerText=data[0].about_urdu;
        // The HTML structure has been updated, dynamicAboutText is now centered
        document.getElementById('dynamicAboutText').innerText=data[0].contact_desc; 
        // The HTML structure has been updated, dynamicPhone is now centered without "Contact:"
        document.getElementById('dynamicPhone').innerText=data[0].phone; 
        document.getElementById('dynamicWhatsapp').href = `https://wa.me/${data[0].whatsapp.replace(/[^0-9+]/g, '')}`;
        document.getElementById('featuresList').innerHTML=(data[0].features||"").split(',').map(f=>`<li>${f.trim()}</li>`).join('');
    }
}

// Initial load sequence
window.onload = function() {
    loadSiteSettings();
    loadRootMembers();
};

</script>
</body>
</html>