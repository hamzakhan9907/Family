<!DOCTYPE html>
<html lang="ur">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Shajra</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// IMPORTANT: Supabase connection details (Moved to HEAD for faster loading and combined for cleaner code)
const supabaseUrl = 'https://ojphjodmpyblyfyinacb.supabase.co';
const k1 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qcGhqb2RtcHlibHlmeWluYWN";
const k2 = "iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTUwNTAsImV4cCI6MjA3OTk5MTA1MH0";
const k3 = ".mwKu_g5_OT_89KcAeeSsY8IMlnakV2nQVtKRhWWTcDw";
const SUPABASE_ANON_KEY = k1 + k2 + k3; // Key ko jod diya gaya hai
const _supabase = supabase.createClient(supabaseUrl, SUPABASE_ANON_KEY);

// NEW: Global variable to store the female detail passcode fetched from the database
let femalePasscode = null; 
// NEW: Global variable to store member data pending password verification
let tempMemberData = null; 

// --- NEW: Search & Tree Globals for faster interaction ---
let allMembersData = []; 
let currentRootId = null; 
let isHorizontal = false; 
// NEW Global Sort State for All Members Table
let currentSortColumn = 'full_name'; 
let currentSortDirection = 'asc'; 
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script> 

<style>
/* ----------------- GLOBAL ----------------- */
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f0f2f5; text-align:center; }
header { background-color: #2c3e50; padding:10px 15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); position:sticky; top:0; z-index:1000; }
.site-title { font-family:'Poppins',sans-serif; font-size:20px; font-weight:800; margin:0; background:linear-gradient(to right,#4ade80,#3b82f6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.admin-btn { background:#e74c3c; color:white; border:none; padding:6px 14px; border-radius:20px; cursor:pointer; font-family:'Poppins',sans-serif; font-size:12px; text-decoration:none; transition:0.3s; }
.shajra-navbar { background:#34495e; padding:0; display:flex; justify-content:space-around; align-items:center; height:25px; }
.shajra-nav-btn { background:none; border:none; color:#bdc3c7; display:flex; align-items:center; text-decoration:none; font-size:11px; cursor:pointer; padding:0 10px; height:100%; transition:all 0.2s; }
.shajra-nav-btn i { font-size:12px; margin-right:4px; color:#bdc3c7; }
.shajra-nav-btn:hover { background-color:#496075; color:white; } 
.shajra-nav-btn:hover i { color:white; }
.shajra-dropdown { position:relative; }
.shajra-dropdown-menu { display:none; position:absolute; right:0; top:25px; background:#fff; min-width:160px; box-shadow:0px 10px 25px rgba(0,0,0,0.15); z-index:100; border-radius:8px; border:1px solid #f0f0f0; overflow:hidden; }
.shajra-dropdown-menu a { color:#333; padding:10px 16px; text-decoration:none; display:flex; align-items:center; gap:10px; font-size:13px; font-weight:500; border-bottom:1px solid #f9f9f9; text-align:left; transition:background 0.2s; }
.shajra-dropdown-menu a:last-child { border-bottom:none; }
.shajra-dropdown-menu a:hover { background-color:#f0f7ff; color:#2196f3; }
.shajra-dropdown-menu i { width:18px; text-align:center; color:#7f8c8d; }
.show { display:block; }

/* --- Search Bar Styles (UPDATED) --- */
.shajra-search-container {
    padding: 5px 10px;
    background-color: #34495e; 
    border-bottom: 2px solid #2c3e50;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px; /* Added gap between input and button */
}
#memberSearchInput {
    padding: 5px 10px;
    border-radius: 6px;
    border: 1px solid #5d6d7e;
    font-size: 13px;
    width: 90%;
    max-width: 400px;
    background: #fcfcfc;
    color: #333;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}
/* NEW: Close Button Style */
.search-close-btn {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    line-height: 1; /* Ensures icon is centered */
    transition: background 0.2s;
}
.search-close-btn:hover {
    background: #c0392b;
}

/* ---------------------------------------------------------------------------------- */
/* ---------- NEW: Search Results Dropdown Styles ---------- */
/* ---------------------------------------------------------------------------------- */
.search-results-container {
    position: absolute; 
    top: 95px; /* Adjust based on header+navbar+search height */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 0 0 8px 8px; /* Rounded bottom */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 999; 
    max-height: 300px;
    overflow-y: auto;
}
.search-result-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
    text-align: left;
}
.search-result-item:hover {
    background-color: #f0f7ff;
}
.search-result-item:last-child {
    border-bottom: none;
}
.result-info {
    flex-grow: 1;
    margin-left: 10px;
}
.result-name {
    font-weight: 700;
    color: #2c3e50;
    font-size: 14px;
    line-height: 1.2;
}
.result-parent {
    font-size: 11px;
    color: #7f8c8d;
    margin-top: 2px;
}
.result-icon {
    font-size: 16px;
    color: #3498db;
    width: 20px;
    text-align: center;
}

/* ---------------------------------------------------------------------------------- */
/* ---------- NEW: Highlighting Effect ---------- */
/* ---------------------------------------------------------------------------------- */
.highlighted-member {
    animation: highlightPulse 0.5s 10 alternate; /* 5 seconds total (10 alternating pulses) */
    border-color: #e67e22 !important; 
    box-shadow: 0 0 15px rgba(230, 126, 34, 0.8) !important;
}
@keyframes highlightPulse {
    from { box-shadow: 0 0 15px rgba(230, 126, 34, 0.8) !important; }
    to { box-shadow: 0 0 5px rgba(230, 126, 34, 0.2) !important; }
}


/* ---------------------------------------------------------------------------------- */
/* ---------- MODALS (Unique Common Styles) ---------- */
/* ---------------------------------------------------------------------------------- */
.shajra-modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; backdrop-filter:blur(2px); }
/* Default small modal size for Stats/About */
.shajra-modal-content { background:white; width:85%; max-width:340px; padding:25px; border-radius:16px; text-align:center; position:relative; max-height:90vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
/* UNIQUE CLASS FOR HEADER */
.shajra-modal-title { font-size:20px; font-weight:700; color:#333; margin-bottom:15px; border-bottom:3px solid #3ecf8e; display:inline-block; padding-bottom:5px; }
/* UNIQUE CLASS FOR CLOSE X */
.shajra-modal-close-x { position:absolute; top:15px; right:20px; font-size:24px; color:#aaa; cursor:pointer; transition:0.2s; }
/* UNIQUE CLASS FOR BOTTOM BUTTON */
.shajra-modal-action-btn { background:#f1f2f6; border:none; padding:12px 0; width:100%; border-radius:10px; font-weight:bold; color:#555; cursor:pointer; margin-top:10px; transition: background 0.2s; }
.shajra-modal-action-btn:hover { background: #e0e0e0; }


/* ---------------------------------------------------------------------------------- */
/* ---------- PASSCODE MODAL SPECIFIC STYLES (NEW) ----- */
/* ---------------------------------------------------------------------------------- */
#passcodeModal .shajra-modal-content {
    max-width: 350px;
    padding: 30px 20px;
}
.passcode-icon {
    font-size: 50px;
    color: #e67e22; /* Orange color for security */
    margin-bottom: 15px;
}
.passcode-instruction {
    font-family: 'Noto Nastaliq Urdu', serif;
    font-size: 16px;
    color: #34495e;
    margin-bottom: 20px;
    line-height: 1.6;
}
.passcode-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #bdc3c7;
    border-radius: 8px;
    font-size: 18px;
    text-align: center;
    letter-spacing: 2px;
    margin-bottom: 5px; /* Reduced margin to fit error display */
    outline: none;
    transition: border-color 0.3s;
}
.passcode-input:focus {
    border-color: #3498db;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
}
.passcode-error {
    color: #e74c3c;
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 10px;
    min-height: 20px;
}
.passcode-submit-btn {
    background: #2ecc71;
    color: white;
    border: none;
    padding: 12px;
    width: 100%;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 16px;
    margin-top: 5px;
}
.passcode-submit-btn:hover {
    background: #27ae60;
}


/* ---------------------------------------------------------------------------------- */
/* ---------- ANALYTICS MODAL SPECIFIC STYLES (FIXED) ----- */
/* ---------------------------------------------------------------------------------- */
#analyticsModal .shajra-modal-content { max-width: 380px; } /* Enforce size */
.analytics-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
}
.analytics-stat-card {
    background: #eaf6ff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.analytics-stat-card .stat-number { /* Added .analytics-stat-card to enforce specificity */
    display: block;
    font-size: 24px;
    font-weight: 800;
    color: #1e88e5;
    line-height: 1;
}
.analytics-stat-card .stat-urdu { /* Added .analytics-stat-card to enforce specificity */
    display: block;
    font-size: 11px;
    color: #555;
    font-family: 'Noto Nastaliq Urdu', serif;
    margin-top: 3px;
    font-weight: 500;
}
.analytics-fun-box {
    background: #f7f9fc;
    border: 1px solid #e0e0e0;
    padding: 15px;
    border-radius: 10px;
    text-align: left;
    margin-bottom: 20px;
}
.fun-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 14px;
    color: #444;
    border-bottom: 1px dashed #eee;
}
.fun-item:last-child { border-bottom: none !important; }
.fun-item span:first-child { font-weight: 500; }
.fun-item span:last-child { font-weight: 700; color: #388e3c; }


/* ---------------------------------------------------------------------------------- */
/* ---------- ABOUT MODAL SPECIFIC STYLES (FIXED) ----- */
/* ---------------------------------------------------------------------------------- */
#aboutModal .shajra-modal-content { max-width: 380px; } /* Enforce size */
.about-urdu-text-style {
    font-family: 'Noto Nastaliq Urdu', serif;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    margin-bottom: 20px;
    /* FIX: Center the Urdu text */
    text-align: center; 
}
.about-contact-box-style {
    text-align: center;
	background: #fff3e0;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}
.about-contact-box-style p { margin: 5px 0; } /* FIX: Added to control paragraph spacing */
.contact-whatsapp-btn-style {
    display: block;
    background: #25d366;
    color: white;
    padding: 10px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    margin-top: 15px;
    transition: background 0.3s;
    font-size: 14px;
    text-align: center; /* FIX: Added to center button text */
}
.contact-whatsapp-btn-style:hover {
    background: #128c7e;
}
.features-list-box-style {
    text-align: left;
    background: #e8f5e9;
    padding: 15px;
    border-radius: 10px;
    margin-top: 20px;
}
.features-list-box-style ul {
    list-style: disc;
    padding-left: 20px;
    margin-top: 5px;
}
.features-list-box-style li {
    font-size: 13px;
    color: #333;
    margin-bottom: 5px;
}


/* ---------------------------------------------------------------------------------- */
/* ---------- ALL MEMBERS MODAL SPECIFIC STYLES (NEW) ----- */
/* ---------------------------------------------------------------------------------- */
/* Overrides default size for large modal */
#allMembersModal .shajra-modal-content {
    max-width: 90%; 
    width: 700px; 
    padding: 15px;
}
.all-members-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
.all-members-table th {
    background-color: #34495e;
    color: white;
    padding: 10px 8px;
    text-align: left;
    cursor: pointer;
    position: sticky; /* Keep header visible on scroll */
    top: 0;
    z-index: 50;
}
.all-members-table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
}
.all-members-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.all-members-table tr:hover {
    background-color: #f0f7ff;
}
.sortable {
    user-select: none;
    cursor: pointer;
    position: relative;
}
/* Sort icon styles */
.sortable::after {
    content: '\f0dc'; /* Font Awesome: up/down arrows */
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    margin-left: 5px;
    color: #bdc3c7;
    font-size: 10px;
}
.sortable.asc::after {
    content: '\f0de'; /* Arrow up */
    color: #4ade80;
}
.sortable.desc::after {
    content: '\f0dd'; /* Arrow down */
    color: #e74c3c;
}
.details-link {
    background: #3498db;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 11px;
    font-weight: 600;
    transition: background 0.2s;
}
.details-link:hover {
    background: #2980b9;
}


/* ---------------------------------------------------------------------------------- */
/* ---------- EVENTS MODAL SPECIFIC STYLES (NEW) ----- */
/* ---------------------------------------------------------------------------------- */
#eventsModal .shajra-modal-content { max-width: 90%; width: 500px; padding: 15px; }
.event-tab-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #ecf0f1;
    color: #555;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.2s, color 0.2s;
}
.event-tab-btn:hover {
    background: #bdc3c7;
}
.event-tab-btn.active-tab {
    background: #3498db;
    color: white;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.event-list-container {
    max-height: 50vh;
    overflow-y: auto;
    padding: 5px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fcfcfc;
}
.event-card {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    background: #ffffff;
    border-left: 5px solid #2ecc71; /* Default: Upcoming/Success */
}
.event-card.past {
    border-left: 5px solid #95a5a6; /* Grey for past events */
}
.event-icon {
    font-size: 24px;
    color: #3498db;
    margin-right: 15px;
    width: 30px;
    text-align: center;
}
.event-details {
    flex-grow: 1;
    text-align: left;
}
.event-title {
    font-size: 14px;
    font-weight: 700;
    color: #333;
    line-height: 1.2;
}
.event-date {
    font-size: 12px;
    color: #7f8c8d;
    margin-top: 3px;
}
.event-days {
    font-size: 12px;
    font-weight: 600;
    color: #e67e22;
    margin-left: 10px;
}


/* ---------------------------------------------------------------------------------- */
/* ---------- MEMBER DETAIL MODAL STYLES (Existing) ----- */
/* ---------------------------------------------------------------------------------- */
#detailModal .shajra-modal-content { max-width: 400px; }
#detailModal #modalContentArea { text-align: center; }
/* Applied to image, or to the new icon placeholder div */
#detailModal .modal-profile-img, #detailModal .modal-profile-icon { 
    width: 120px; 
    height: 120px; 
    border-radius: 50%; 
    object-fit: cover; 
    margin: 0 auto 15px auto; 
    border: 5px solid #a0522d; 
    box-shadow: 0 0 0 3px #fff8e1; 
    transition: transform 0.3s; 
    cursor: pointer; /* Keep hover effect on icon too */
}
#detailModal .modal-profile-img:hover, #detailModal .modal-profile-icon:hover { transform: scale(1.05); }
/* Additional style for the icon background */
#detailModal .modal-profile-icon {
    background-color: #f7f7f7;
    display: flex;
    justify-content: center;
    align-items: center;
}
/* ... (Other detail modal styles are retained) ... */
#detailModal .modal-full-name { font-size: 28px; font-weight: 800; color: #2c3e50; margin-bottom: 5px; text-transform: capitalize; text-align: center; }
#detailModal .modal-relation { font-size: 14px; color: #888; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; text-align: center; }
#detailModal .detail-data-section { text-align: left; padding: 0 10px; }
#detailModal .modal-data-row { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
#detailModal .modal-data-row:last-child { border-bottom: none; }
#detailModal .modal-data-row span:first-child { font-weight: 600; color: #555; text-align: right; }
#detailModal .modal-data-row span:last-child { color: #222; font-weight: 700; text-align: left; }


/* ---------------------------------------------------------------------------------- */
/* ---------- HEADING & DROPDOWN STYLES (Horizontal Toggle)  ----- */
/* ---------------------------------------------------------------------------------- */
.heading-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 90%;
    margin: 25px auto 10px auto; 
    padding: 0 10px;
    flex-wrap: wrap; 
}
.family-name-display {
    font-family: 'Noto Nastaliq Urdu', serif;
    font-size: 20px; 
    font-weight: 700;
    color: #2c3e50;
    margin: 0; 
    border-bottom: 3px solid #4ade80; 
    display: inline-block;
    padding-bottom: 3px;
    text-align: center; 
    flex-grow: 1; 
    order: 2; 
}
.root-select-container {
    flex-grow: 0;
    max-width: 150px;
    text-align: left;
    margin-bottom: 5px;
    order: 1; 
}
#rootMemberSelect {
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 12px;
    width: 100%;
}

/* NEW: Utility container for buttons and toggles */
.shajra-utility-container {
    display: flex;
    gap: 10px;
    align-items: center;
    order: 3;
    flex-grow: 0;
    float: right;
}
.toggle-deceased-box {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 8px;
    background: #34495e; /* Match navbar */
    border-radius: 6px;
    color: white;
}
#toggleViewBtn {
    background: #3498db;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}
#toggleViewBtn:hover {
    background: #2980b9;
}

/* NEW: Toggle Switch CSS */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 30px;
  height: 17px;
}
.toggle-switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}
.slider:before {
  position: absolute;
  content: "";
  height: 13px;
  width: 13px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}
input:checked + .slider {
  background-color: #2ecc71;
}
input:focus + .slider {
  box-shadow: 0 0 1px #2ecc71;
}
input:checked + .slider:before {
  -webkit-transform: translateX(13px);
  -ms-transform: translateX(13px);
  transform: translateX(13px);
}
.slider.round {
  border-radius: 17px;
}
.slider.round:before {
  border-radius: 50%;
}

/* Deceased member style (Dimming and Hiding Logic) */
.deceased-member {
    opacity: 0.5; /* Always dim deceased members */
    transition: opacity 0.3s;
}
.deceased-member:hover {
    opacity: 1; /* Bring back opacity on hover */
}
/* Class applied to the main tree container to hide deceased members */
.hide-deceased .deceased-member {
    display: none !important; /* Hide them if class is applied to tree container */
}

/* For very small screens, adjust layout */
@media (max-width: 500px) {
    .heading-container {
        flex-direction: column;
        align-items: stretch;
    }
    .root-select-container, .shajra-utility-container {
        max-width: 100%;
        margin-bottom: 10px;
        order: 1; 
        justify-content: space-between;
    }
    .family-name-display {
        text-align: center;
        order: 3; 
        margin-top: 5px;
    }
    .shajra-utility-container {
        float: none;
        width: 100%;
        justify-content: space-around;
        gap: 5px;
    }
    #toggleViewBtn {
        flex-grow: 1;
        justify-content: center;
    }
    .toggle-deceased-box {
        flex-grow: 1;
        justify-content: center;
    }
}

/* ------------------------------------------------------------- */
/* ---------- FAMILY TREE STYLES (Vertical Default) ------------------------------- */
/* ------------------------------------------------------------- */
.family-tree { 
    font-family: 'Inter', sans-serif; 
    text-align: center; 
    padding: 30px 10px; 
    background-color: #fcfbf6; 
    overflow-x: auto; 
    min-height: 400px; 
}
.family-tree ul { 
    padding-top: 25px; 
    position: relative; 
    list-style: none; 
    padding-left: 0; 
    display: flex; 
    justify-content: flex-start; 
    transition: all 0.5s ease-in-out; 
    margin: 0; 
}
/* Standard Vertical Tree Connectors (Unchanged) */
.family-tree > ul { padding-top: 0; }
.family-tree li { list-style-type: none; position: relative; padding: 25px 15px 0 15px; flex-shrink: 0; transition: all 0.5s ease-in-out; }
.family-tree > ul > li { padding-top: 0; } /* Ensures the Root LI has no top padding */
.family-tree li .member-card-wrapper { border: 2px solid #a0522d; background-color: #fff8e1; padding: 10px; text-decoration: none; display: inline-flex; flex-direction: column; align-items: center; border-radius: 12px; transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-width: 140px; position: relative; cursor: pointer; }
.family-tree li .member-card-wrapper:hover { background: #e7c29e; border-color: #a0522d; transform: translateY(-2px); box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.15); }
/* Custom style for icon placeholder */
.member-img-placeholder {
    width: 60px; 
    height: 60px; 
    border-radius: 50%; 
    object-fit: cover; 
    border: 3px solid #a0522d; 
    margin-bottom: 5px; 
    transition: transform 0.3s;
    background: #fff8e1; 
    display: flex; 
    justify-content: center; 
    align-items: center;
}
/* Existing image style */
.member-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid #a0522d; margin-bottom: 5px; transition: transform 0.3s; }

.member-img:hover, .member-img-placeholder:hover { transform: scale(1.05); }

.member-info { color: #5d4037; font-size: 0.85rem; font-weight: 700; line-height: 1.2; text-transform: uppercase; text-align: center; padding-top: 5px; }
.collapse-btn { position: absolute; top: -12px; right: -12px; background: #3b82f6; color: white; border: 2px solid #fff; border-radius: 50%; width: 25px; height: 25px; display: flex; justify-content: center; align-items: center; font-size: 14px; cursor: pointer; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); z-index: 10; transition: background 0.3s; }
.collapse-btn:hover { background: #1e40af; }
.collapsed > ul { display: none; }
.collapsed > .member-card-wrapper > .collapse-btn { background: #10b981; }
/* Connectors */
.family-tree li::after { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #8d6e63; border-top: 1px solid #8d6e63; width: 50%; height: 25px; }
.family-tree li::before { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #8d6e63; width: 50%; height: 25px; }
.family-tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #8d6e63; width: 0; height: 25px; }
.family-tree ul:first-child > li::before, .family-tree ul:first-child > li::after { content: none; height: 0; } /* Hides top lines for the root member LI */
.family-tree li:first-child::before { border: none; }
.family-tree li:last-child:not(:only-child)::after { border-top: none; width: 0; }
.family-tree li:only-child::before, .family-tree li:only-child::after { border: none; }
.family-tree li:only-child::after { border-left: 1px solid #8d6e63 !important; }


/* ------------------------------------------------------------- */
/* ---------- SHAHJRA HORIZONTAL TREE STYLES (Unique Classes) ------------------------------- */
/* ------------------------------------------------------------- */
.shajra-horizontal-tree {
    /* Main container needs extra vertical space for layout */
    padding: 50px 10px; 
}
.shajra-horizontal-tree > ul { 
    /* The root ul should be horizontal */
    flex-direction: row; 
    justify-content: flex-start;
    padding-top: 0; 
    margin: 0;
    width: max-content; /* Allow content to dictate width */
}
.shajra-horizontal-tree ul ul {
    /* All children ul should display children vertically, add vertical connector line */
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    position: relative;
    padding-left: 40px;
    border-left: 1px solid #8d6e63; /* Vertical line from parent generation to children */
    margin: 0;
    transition: none; /* Disable transition on UL to prevent odd rotation */
}
/* Clear standard vertical connectors */
.shajra-horizontal-tree li::after, .shajra-horizontal-tree li::before, .shajra-horizontal-tree ul ul::before {
    content: none !important;
    border: none !important;
}
/* Horizontal line from the vertical line to the member card (li::before) */
.shajra-horizontal-tree li::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    border-top: 1px solid #8d6e63;
    width: 40px;
    height: 0;
    transform: translateY(-50%);
}
/* Horizontal line segment 2 (from line to card) (li::after) */
.shajra-horizontal-tree li::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 40px;
    border-top: 1px solid #8d6e63;
    width: 40px;
    height: 0;
    transform: translateY(-50%);
}
/* Root LI in horizontal view should not have the before/after line if it's the root */
.shajra-horizontal-tree > ul > li::before, .shajra-horizontal-tree > ul > li::after {
    content: none !important;
    border: none !important;
}

/* Horizontal mode: Make root card stay in place and children flow horizontally */
.shajra-horizontal-tree li {
    display: flex;
    flex-direction: row;
    align-items: center;
    padding: 0; /* Remove top padding for LI in horizontal */
}
.shajra-horizontal-tree .member-card-wrapper {
    margin: 10px 0; /* Vertical margin for cards */
}
.shajra-horizontal-tree > ul {
    /* The main root ul */
    padding-left: 0;
    display: block; /* Root UL holds one LI */
}
.shajra-horizontal-tree > ul > li {
    /* The root LI */
    padding-left: 0;
    padding-top: 0; 
}
/* Center connector on root card */
.shajra-horizontal-tree > ul > li > ul::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 100%; /* Start line from right edge of root card */
    border-top: 1px solid #8d6e63;
    width: 25px; /* Length of the connecting line */
    height: 0;
    transform: translateY(-50%);
}

.shajra-horizontal-tree li > ul {
    /* Children list alignment */
    padding-left: 25px; /* Space for the line from parent to children */
    margin: 10px 0; /* Vertical margin to space out children blocks */
    border-left: none; /* Already handled by the LI before/after */
}

/* Ensure the main root's children UL has the connecting line */
.shajra-horizontal-tree > ul > li > ul {
    display: flex;
    flex-direction: row; /* Children of root are horizontal */
    align-items: flex-start;
    padding-left: 25px; /* Extra space for line from root card */
    margin: 0;
    flex-wrap: wrap; /* Allow children to wrap if space is tight */
    /* Remove vertical line for horizontal view */
    border-left: none; 
}

/* New: Lines for root's children (horizontal mode) */
.shajra-horizontal-tree > ul > li > ul > li {
    padding-top: 25px; /* Restore padding for vertical line connectors between siblings */
    padding-right: 15px; /* Space between members */
    padding-left: 15px;
    flex-direction: column; /* Children cards are vertical */
    align-items: center;
}
.shajra-horizontal-tree > ul > li > ul > li::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    border-top: 1px solid #8d6e63;
    width: 50%;
    height: 25px;
    transform: none; /* Remove horizontal transform */
}
.shajra-horizontal-tree > ul > li > ul > li::after {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    border-left: 1px solid #8d6e63;
    border-top: 1px solid #8d6e63;
    width: 50%;
    height: 25px;
    transform: none;
}
.shajra-horizontal-tree > ul > li > ul > li:first-child::before {
    border: none;
}
.shajra-horizontal-tree > ul > li > ul > li:last-child:not(:only-child)::after {
    border-top: none;
    width: 0;
}
.shajra-horizontal-tree > ul > li > ul > li:only-child::before, .shajra-horizontal-tree > ul > li > ul > li:only-child::after {
    border: none;
}
.shajra-horizontal-tree > ul > li > ul > li:only-child::after { 
    border-left: 1px solid #8d6e63 !important;
}

/* Reset to Vertical Tree for subsequent generations (ul ul) */
.shajra-horizontal-tree ul ul {
    display: block; /* Reset to standard vertical flow */
    border-left: none; /* Already handled by LI before/after */
    padding-left: 0;
    margin: 0;
}
/* Re-apply vertical lines for deeper generations */
.shajra-horizontal-tree ul ul ul::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    border-left: 1px solid #8d6e63;
    width: 0;
    height: 25px;
}
.shajra-horizontal-tree ul ul > li {
    padding: 25px 15px 0 15px; /* Restore vertical padding for deeper li's */
    flex-direction: column;
}
.shajra-horizontal-tree ul ul > li::before, .shajra-horizontal-tree ul ul > li::after {
    /* Restore vertical connectors for deeper li's */
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    border-top: 1px solid #8d6e63;
    width: 50%;
    height: 25px;
    transform: none;
}
.shajra-horizontal-tree ul ul > li::after {
    border-left: 1px solid #8d6e63;
}
.shajra-horizontal-tree ul ul > li:first-child::before {
    border: none;
}
.shajra-horizontal-tree ul ul > li:last-child:not(:only-child)::after {
    border-top: none;
    width: 0;
}
.shajra-horizontal-tree ul ul > li:only-child::before, .shajra-horizontal-tree ul ul > li:only-child::after {
    border: none;
}
.shajra-horizontal-tree ul ul > li:only-child::after { 
    border-left: 1px solid #8d6e63 !important;
}
</style>
</head>
<body>

<header>
    <h1 class="site-title" id="mainTitle">Family Shajra</h1>
    <a href="./admin.html" class="admin-btn"><i class="fa-solid fa-lock"></i> Admin</a>
</header>
<nav class="shajra-navbar">
    <button onclick="loadFamilyTree(currentRootId)" class="shajra-nav-btn"><i class="fa-solid fa-home"></i> Home</button>
    <button onclick="openAnalytics()" class="shajra-nav-btn"><i class="fa-solid fa-chart-pie"></i> Stats</button>
    <button onclick="openAbout()" class="shajra-nav-btn"><i class="fa-solid fa-circle-info"></i> About</button>
    <div class="shajra-dropdown">
        <button onclick="toggleMenu()" class="shajra-nav-btn"><i class="fa-solid fa-bars-staggered"></i> Menu</button>
        <div id="myDropdown" class="shajra-dropdown-menu">
            <a href="#" onclick="openAllMembers(event)"><i class="fa-solid fa-list-ul"></i> All Members</a>
            <a href="#" onclick="handleSearchToggle(false)"><i class="fa-solid fa-magnifying-glass"></i> Search</a>
            <a href="#" onclick="openEvents()"><i class="fa-solid fa-calendar-alt"></i> Events/Birthdays</a>
        </div>
    </div>
</nav>

<div id="searchContainer" class="shajra-search-container" style="display: none;">
    <input type="text" id="memberSearchInput" placeholder="Search by Member Name (Full/Partial)..." onkeyup="handleSearchInput(this.value)">
    <button class="search-close-btn" onclick="handleSearchToggle(true)">
        <i class="fa-solid fa-xmark"></i>
    </button>
</div>
<div id="searchResults" class="search-results-container" style="display: none;">
</div>

<div class="heading-container">
    <div class="root-select-container">
        <select id="rootMemberSelect" onchange="loadFamilyTree(this.value)">
        </select>
    </div>
    <h1 class="family-name-display" id="currentFamilyName"><i class="fa-solid fa-sitemap"></i> Loading...</h1>
    <div class="shajra-utility-container">
        <button id="toggleViewBtn" onclick="toggleView()">
            <i class="fa-solid fa-expand"></i> Horizontal
        </button>
        <div class="toggle-deceased-box">
            <label class="toggle-switch">
                <input type="checkbox" id="deceasedToggle" onchange="toggleDeceasedVisibility(this.checked)" checked>
                <span class="slider round"></span>
            </label>
            <span style="font-size: 12px; color: white;">Show Deceased</span>
        </div>
    </div>
</div>

<div id="visualTreeContainer" class="family-tree">
</div>

<div id="detailModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeDetail()">
    <div class="shajra-modal-content" style="max-width: 400px; padding: 15px;">
        <span class="shajra-modal-close-x" onclick="closeDetail()">&times;</span>
        <div id="modalContentArea">
            <div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>
        </div>
    </div>
</div>

<div id="passcodeModal" class="shajra-modal-overlay" onclick="if (event.target === this) closePasscodeModal()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closePasscodeModal()">&times;</span>
        <div class="passcode-icon"><i class="fa-solid fa-user-lock"></i></div>
        <div class="shajra-modal-title">محفوظ تفصیلات</div>
        <p class="passcode-instruction">یہ تفصیلات محفوظ ہیں، براہ کرم دیکھنے کے لیے پاس کوڈ درج کریں۔</p>
        <input type="password" id="femalePasscodeInput" class="passcode-input" placeholder="پاس کوڈ" onkeyup="if(event.key === 'Enter') verifyFemalePasscode()">
        <div id="passcodeError" class="passcode-error"></div>
        <button class="passcode-submit-btn" onclick="verifyFemalePasscode()">تصدیق کریں (Verify)</button>
    </div>
</div>

<div id="analyticsModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeAnalytics()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closeAnalytics()">&times;</span>
        <div class="shajra-modal-title"><i class="fa-solid fa-chart-pie"></i> فیملی کے اعداد و شمار</div>
        <div class="analytics-stats-grid">
            <div class="analytics-stat-card"><span class="stat-number" id="statTotal">--</span><span class="stat-urdu">کل ممبران</span></div>
            <div class="analytics-stat-card"><span class="stat-number" id="statMale">-- / --</span><span class="stat-urdu">مرد / عورت</span></div>
            <div class="analytics-stat-card"><span class="stat-number" id="statAlive">-- / --</span><span class="stat-urdu">زندہ / انتقال</span></div>
        </div>
        <div class="analytics-fun-box">
            <div style="font-weight:bold; font-size:13px; margin-bottom:8px; color:#1565c0;">Dilchasp Malumat:</div>
            <div class="fun-item"><span>Oldest Member (DOB)</span><span id="statOldest">N/A</span></div>
            <div class="fun-item"><span>Youngest Member (DOB)</span><span id="statYoungest">N/A</span></div>
        </div>
        <button onclick="closeAnalytics()" class="shajra-modal-action-btn">Close</button>
    </div>
</div>

<div id="eventsModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeEvents()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closeEvents()">&times;</span>
        <div class="shajra-modal-title"><i class="fa-solid fa-calendar-alt"></i> Family Events</div>
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
            <button class="event-tab-btn active-tab" onclick="changeEventTab(this, 'upcoming')">Upcoming</button>
            <button class="event-tab-btn" onclick="changeEventTab(this, 'past')">Past</button>
        </div>
        <div id="upcomingEventsContainer" class="event-list-container">
            <div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading events...</div>
        </div>
        <div id="pastEventsContainer" class="event-list-container" style="display: none;">
        </div>
        <button onclick="closeEvents()" class="shajra-modal-action-btn">Close</button>
    </div>
</div>

<div id="aboutModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeAbout()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closeAbout()">&times;</span>
        <div class="shajra-modal-title"><i class="fa-solid fa-circle-info"></i> About</div>
        <div class="about-urdu-text-style" id="dynamicUrduText">
            یہ شجرہ آپ کی فیملی کی مکمل تاریخ کو محفوظ کرنے کے لیے بنایا گیا ہے۔
        </div>
        <div class="about-contact-box-style">
            <div style="color:#d90429; font-weight:700; font-size:18px; margin-bottom:10px; font-family:'Noto Nastaliq Urdu',serif; text-align:center;">
                <i class="fa-solid fa-headset"></i> رابطہ کریں
            </div>
             <p style="font-size:13px; color:#555;" id="dynamicAboutText">
                Contact the developer for customization, new features, or technical support.
            </p>
			<p style"font-size:16px; font-weight:700; margin:10px 0; color:#333;"i class="fa-solid fa-phone-volume"></i> <span id="dynamicPhone"></span></p>
            <a href="https://wa.me/03001234567" target="_blank" class="contact-whatsapp-btn-style" id="dynamicWhatsapp">
                <i class="fa-brands fa-whatsapp"></i> Message on WhatsApp
            </a>
        </div>
        <div class="features-list-box-style">
            <div style="font-weight:700; font-size:14px; color:#2ecc71;">Key Features:</div>
            <ul id="featuresList">
                <li>Responsive Design (Mobile/Desktop)</li>
                <li>Search & View All Members</li>
                <li>Upcoming Birthdays/Events</li>
                <li>Analytics & Stats</li>
            </ul>
        </div>
        <button onclick="closeAbout()" class="shajra-modal-action-btn">Close</button>
    </div>
</div>

<div id="allMembersModal" class="shajra-modal-overlay" onclick="if (event.target === this) closeAllMembers()">
    <div class="shajra-modal-content">
        <span class="shajra-modal-close-x" onclick="closeAllMembers()">&times;</span>
        <div class="shajra-modal-title"><i class="fa-solid fa-list-ul"></i> All Members List</div>
        <input type="text" id="allMembersSearch" placeholder="Search by Name, Parent, or Status..." onkeyup="searchMemberList(this.value)" style="padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 100%; margin-bottom: 15px; font-size: 13px;">
        <div style="max-height: 60vh; overflow-y: auto;">
            <table class="all-members-table">
                <thead id="memberListHeader">
                    <tr>
                        <th data-sort="full_name" class="sortable asc">Name</th>
                        <th data-sort="parent_name" class="sortable">Parent</th>
                        <th data-sort="is_alive" class="sortable">Status</th>
                        <th data-sort="dob" class="sortable">Age</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="memberListBody">
                    <tr><td colspan="5" style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading members...</td></tr>
                </tbody>
            </table>
        </div>
        <button onclick="closeAllMembers()" class="shajra-modal-action-btn">Close</button>
    </div>
</div>

<script>
// --- Helper Functions ---

// NEW: Utility function for basic Urdu to Roman (Latin) transliteration for search purposes
function romanizeForSearch(urduText) {
    if (!urduText) return "";
    // A simplified map for common Urdu characters to English letters for search matching
    const map = {
        'ا': 'a', 'آ': 'aa', 'ب': 'b', 'پ': 'p', 'ت': 't', 'ٹ': 't', 'ث': 's',
        'ج': 'j', 'چ': 'ch', 'ح': 'h', 'خ': 'kh', 'د': 'd', 'ڈ': 'd', 'ذ': 'z',
        'ر': 'r', 'ڑ': 'r', 'ز': 'z', 'ژ': 'j', 'س': 's', 'ش': 'sh', 'ص': 's',
        'ض': 'z', 'ط': 't', 'ظ': 'z', 'ع': 'a', 'غ': 'gh', 'ف': 'f', 'ق': 'q',
        'ک': 'k', 'گ': 'g', 'ل': 'l', 'م': 'm', 'ن': 'n', 'و': 'w', 'ہ': 'h',
        'ی': 'y', 'ے': 'e', 'ء': '', 'ں': 'n',
        'بھ': 'bh', 'پھ': 'ph', 'تھ': 'th', 'ٹھ': 'tth', 'جھ': 'jh', 'چھ': 'chh', 
        'دھ': 'dh', 'ڈھ': 'ddh', 'کھ': 'kh', 'گھ': 'gh',
        // Combining forms are ignored for simplicity in non-contextual search
    };

    let romanized = '';
    // Normalize spaces and convert to a basic Romanized string
    let normalizedText = urduText.replace(/\s+/g, ' ').trim();
    
    // Simple character-by-character mapping
    for (let char of normalizedText) {
        if (map[char]) {
            romanized += map[char];
        } else {
            // Keep existing Latin characters, numbers, and common symbols (like space)
            romanized += char;
        }
    }
    
    // Minor cleanup/normalization for better search results
    romanized = romanized.replace(/a+a/g, 'aa'); 
    
    return romanized.toLowerCase();
}


// Function to mask female name (Updated to show 'Po***' style)
function maskFemaleName(fullName, gender) {
    // Check karein ke member female hai AND passcode set hai
    if (gender && fullName && gender.toLowerCase() === 'f' && femalePasscode) {
        
        // Agar naam ka pehla lafz 4 ya us se zyada letters ka hai to mask karein
        if (fullName.length > 3) {
            // Naam ke pehle do haroof (characters) lein
            const firstTwo = fullName.substring(0, 2); 
            
            // Baki bache hue haroof ki ta'adad maloom karein
            const remainingLength = fullName.length - 2;
            
            // Baki haroof ko stars (*) se badal dein
            const stars = '*'.repeat(remainingLength);
            
            // Wapas karein: Pehle do haroof + stars
            return firstTwo + stars;
        } else {
            // Agar naam 3 ya us se chota hai to sirf 1st haroof aur stars
            return fullName.substring(0, 1) + '***';
        }
    }
    
    // Agar member male hai ya passcode set nahi, to pura naam wapas kar dein
    return fullName;
}
// Function to toggle tree children (unchanged)
function toggleChildren(btn, event) {
    event.stopPropagation(); // Prevent card click event
    const parentLi = btn.closest('li');
    if (parentLi.classList.contains('collapsed')) {
        parentLi.classList.remove('collapsed');
        btn.querySelector('i').classList.remove('fa-plus');
        btn.querySelector('i').classList.add('fa-minus');
    } else {
        parentLi.classList.add('collapsed');
        btn.querySelector('i').classList.remove('fa-minus');
        btn.querySelector('i').classList.add('fa-plus');
    }
}

// Function to find the path from the current root to a target member (unchanged)
function findPathToMember(targetId, currentRoot) {
    if (!currentRoot) return null;

    // Check if the current node is the target
    if (currentRoot.id == targetId) return [targetId];

    // Check children recursively
    if (currentRoot.children) {
        for (const child of currentRoot.children) {
            const path = findPathToMember(targetId, child);
            if (path) {
                return [currentRoot.id, ...path];
            }
        }
    }
    return null;
}

// Function to expand a given path of IDs (unchanged)
function expandPath(pathIds) {
    if (!pathIds || pathIds.length <= 1) return; // Need at least root + 1 member

    // Wait a little for the tree to render
    setTimeout(() => {
        // Start from the second ID (the root is already open)
        for (let i = 1; i < pathIds.length; i++) {
            const memberId = pathIds[i];
            const currentElement = document.getElementById(`member-${memberId}`);
            
            // Only toggle if it's currently collapsed
            if (currentElement && currentElement.classList.contains('collapsed')) {
                const collapseBtn = currentElement.querySelector('.collapse-btn');
                if (collapseBtn) {
                    const dummyEvent = { stopPropagation: () => {} };
                    toggleChildren(collapseBtn, dummyEvent);
                }
            }
        }

        // Highlight the target member (the last ID in pathIds)
        const targetMemberId = pathIds[pathIds.length - 1];
        const targetCard = document.querySelector(`#member-${targetMemberId} .member-card-wrapper`);
        if (targetCard) {
            // Ensure the element is visible by scrolling the container
            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetCard.classList.add('highlighted-member');
            // Remove highlight after 5 seconds
            setTimeout(() => {
                targetCard.classList.remove('highlighted-member');
            }, 5000);
        }
    }, 50);
}

// NEW: Helper function to get the current root member and all their descendants. (unchanged)
function getDescendantsAndSelf(rootId) {
    if (!rootId || allMembersData.length === 0) return [];
    const rootMember = allMembersData.find(m => m.id == rootId);
    if (!rootMember) return [];
    const scopedMembers = [rootMember];
    const queue = [rootId];
    const processedIds = new Set([rootId]); 
    // Use a Breadth-First Search (BFS) approach to find all children recursively
    let head = 0;
    while (head < queue.length) {
        const parentId = queue[head++];
        allMembersData.forEach(member => {
            if (member.parent_id == parentId && !processedIds.has(member.id)) {
                processedIds.add(member.id);
                scopedMembers.push(member);
                queue.push(member.id);
            }
        });
    }
    return scopedMembers;
}

// Helper to format date (unchanged)
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(dateString).toLocaleDateString('en-US', options);
}

// Helper to calculate age (unchanged)
function calculateAge(dob, isAlive, dod) {
    if (!dob) return 'N/A';
    const dobDate = new Date(dob);
    let endDate = isAlive ? new Date() : new Date(dod);
    let statusText = '(Age:';
    if (!isAlive && !dod) { return 'N/A'; } // Deceased but DOD missing
    if (!isAlive && dod) { statusText = '(Deceased, Age:'; }

    let age = endDate.getFullYear() - dobDate.getFullYear();
    const monthDifference = endDate.getMonth() - dobDate.getMonth();
    if (monthDifference < 0 || (monthDifference === 0 && endDate.getDate() < dobDate.getDate())) {
        age--;
    }
    if (age < 0) return 'N/A'; // Should not happen
    return `${statusText} ${age} years)`;
}

// Helper for All Members List sorting (unchanged)
function getAgeForList(dob, isAlive, dod) {
    if (!dob) return -1; // Sorts N/A members last
    const dobDate = new Date(dob);
    let endDate = isAlive ? new Date() : new Date(dod);
    if (!isAlive && !dod) return -1; // If deceased but DOD is missing
    let age = endDate.getFullYear() - dobDate.getFullYear();
    const monthDifference = endDate.getMonth() - dobDate.getMonth();
    if (monthDifference < 0 || (monthDifference === 0 && endDate.getDate() < dobDate.getDate())) {
        age--;
    }
    return age;
}

// --- Navigation/Modal Functions ---

function toggleMenu() {
    document.getElementById("myDropdown").classList.toggle("show");
}

// UPDATED: handleSearchToggle to clear search results and use allMembersData (unchanged)
function handleSearchToggle(isForcedClose) {
    const searchContainer = document.getElementById('searchContainer');
    const searchResults = document.getElementById('searchResults');
    if (searchContainer.style.display === 'flex' || isForcedClose) {
        // Close action
        searchContainer.style.display = 'none';
        document.getElementById('memberSearchInput').value = '';
        searchResults.innerHTML = ''; // NEW: Clear search results
        searchResults.style.display = 'none'; // NEW: Hide search results
        // Reload full tree only if a root is selected (clears any partial search view if filterTree was manually run)
        if (currentRootId) loadFamilyTree(currentRootId);
    } else {
        // Open action (Only triggered by menu click)
        searchContainer.style.display = 'flex';
        document.getElementById('memberSearchInput').focus();
    }
    document.getElementById("myDropdown").classList.remove('show');
}

function openAbout(){
    document.getElementById("aboutModal").style.display="flex";
    document.getElementById("myDropdown").classList.remove('show');
}

function closeAbout(){
    document.getElementById("aboutModal").style.display="none";
}

function closeDetail() {
    document.getElementById("detailModal").style.display = "none";
}
// Global variable to store member data pending password verification (must be global: let tempMemberData = null;)


// 1. Passcode Modal ko kholne ka function
function openPasscodeModal(data) {
    tempMemberData = { id: data.id, full_name: data.full_name, gender: data.gender };
    
    // Yahan display: flex !important istemal kiya gaya hai takay CSS ki koi bhi
    // doosri setting isko band na rakh sake.
    document.getElementById("passcodeModal").setAttribute('style', 'display: flex !important;'); 
    
    // Input field ko saaf karein aur focus dein
    document.getElementById('femalePasscodeInput').value = '';
    document.getElementById('passcodeError').innerText = '';
    document.getElementById('femalePasscodeInput').focus();
}

// 2. Passcode Modal ko band karne ka function
function closePasscodeModal() {
    // !important ka istemal takay ye modal foran band ho jaye
    document.getElementById("passcodeModal").setAttribute('style', 'display: none !important;');
}

// 3. Member detail ko load karne aur passcode check karne ka function
function checkAndLoadDetail(data) {
    const isFemale = data.gender && data.gender.toLowerCase() === 'f';
    // Passcode sirf tab zaroori hai jab female ho AUR femalePasscode variable mein value ho
    const isProtected = isFemale && femalePasscode; 

    if (isProtected) {
        // Agar protected hai, to passcode modal kholo
        openPasscodeModal(data);
    } else {
        // Agar protected nahi, to seedha detail modal kholo
        // Detail modal ko bhi display: flex !important se kholna behtar hai
        document.getElementById("detailModal").setAttribute('style', 'display: flex !important;');
        renderAndShowDetailModal(data);
    }
}

// 4. Passcode verify karne ka function
async function verifyFemalePasscode() {
    const inputField = document.getElementById('femalePasscodeInput');
    const errorDisplay = document.getElementById('passcodeError');
    const inputPasscode = inputField.value.trim();

    if (!inputPasscode) {
        errorDisplay.innerText = 'Passcode lazmi hai.';
        return;
    }

    if (inputPasscode === femalePasscode) {
        errorDisplay.innerText = '';
        closePasscodeModal(); // Passcode modal band

        if (tempMemberData) {
            // Full details database se fetch karein
            const { data: fullData, error } = await _supabase.from('family_data').select('*').eq('id', tempMemberData.id).single();
            if (error) {
                console.error("Error fetching full details:", error);
                // Error hone par detail modal band rakhen
                document.getElementById("detailModal").setAttribute('style', 'display: none !important;'); 
                alert("تفصیلات لوڈ نہیں ہو سکی۔");
                return;
            }
            
            // *** Yahan woh fix hai jo detail modal ko kholta hai ***
            // display: flex !important ka istemal takay ye zaroor khul jaye
            document.getElementById("detailModal").setAttribute('style', 'display: flex !important;');
            
            // Ab data bharen aur show karein
            renderAndShowDetailModal(fullData);
        }
    } else {
        errorDisplay.innerText = 'Ghalat Passcode. Dubara koshish karein.';
        inputField.value = '';
    }
}

// Renamed original logic to this helper function (unchanged)
async function renderAndShowDetailModal(data) {
    const modalContentArea = document.getElementById('modalContentArea');
    // We already have full data from the global cache (or fetched after passcode verification)
    // detailModal is already shown by checkAndLoadDetail (or openPasscodeModal)
    
    const statusText = data.is_alive ? 'زندہ (Alive)' : 'انتقال کر گئے (Deceased)';
    const genderText = data.gender ? (data.gender.toLowerCase() === 'm' ? 'مرد (Male)' : 'عورت (Female)') : 'N/A';
    const dobText = formatDate(data.dob);
    const dodText = data.dod ? formatDate(data.dod) : 'N/A';
    const ageInfo = calculateAge(data.dob, data.is_alive, data.dod);
    const phoneText = data.phone || 'N/A';
    
    // Find parent and spouse details (using allMembersData)
    const parent = allMembersData.find(m => m.id === data.parent_id);
    const parentName = parent ? maskFemaleName(parent.full_name, parent.gender) : 'N/A (Root)';

    // Find spouse (assuming one spouse for simplicity in this display)
    const spouse = allMembersData.find(m => m.spouse_id === data.id);
    const spouseName = spouse ? maskFemaleName(spouse.full_name, spouse.gender) : 'N/A';
    const spouseHtml = `<div class="modal-data-row"><span>Spouse</span><span>${spouseName}</span></div>`;

    // Relation is based on the perspective of the root, which is complex. For now, show Parent Name
    const relationText = parentName; // Simplified display of primary relationship

    // Image/Icon logic
    let profileImageHtml = '';
    if (data.image_url) {
        profileImageHtml = `<img src="${data.image_url}" alt="${data.full_name}" class="modal-profile-img" onclick="window.open('${data.image_url}', '_blank')">`;
    } else {
        const iconClass = data.gender && data.gender.toLowerCase() === 'f' ? 'fa-person-dress' : 'fa-person';
        const iconColor = data.gender && data.gender.toLowerCase() === 'f' ? '#e74c3c' : '#3498db';
        profileImageHtml = `<div class="modal-profile-icon"> <i class="fa-solid ${iconClass}" style="font-size: 60px; color: ${iconColor};"></i> </div>`;
    }

    // Name is shown in full here as user provided the passcode
    const modalHtml = `
        ${profileImageHtml}
        <div class="modal-full-name">${data.full_name}</div>
        <div class="modal-relation">رشتہ: ${relationText}</div>
        <div class="detail-data-section" style="margin-top:20px;">
            <div class="modal-data-row"><span>Status</span><span>${statusText}</span></div>
            <div class="modal-data-row"><span>Age</span><span>${ageInfo}</span></div>
            <div class="modal-data-row"><span>Gender</span><span>${genderText}</span></div>
            <div class="modal-data-row"><span>Date of Birth</span><span>${dobText}</span></div>
            ${data.is_alive ? '' : `<div class="modal-data-row"><span>Date of Death</span><span>${dodText}</span></div>`}
            ${spouseHtml}
            <div class="modal-data-row"><span>Phone/Contact</span><span>${phoneText}</span></div>
        </div>
    `;

    modalContentArea.innerHTML = modalHtml;
}

// NEW ENTRY POINT: openMemberDetail (Performs password check if female) (unchanged)
async function openMemberDetail(memberId) {
    const data = allMembersData.find(m => m.id == memberId);
    
    if (!data) {
        // Fallback: If data is not in cache, fetch it minimally for check
        const { data: fetchedData } = await _supabase.from('family_data').select('id, full_name, gender').eq('id', memberId).single();
        if (!fetchedData) {
            alert("Member data not found!");
            return;
        }
        // Need to load full data later if required, but proceed with check
        return checkAndLoadDetail(fetchedData);
    }
    checkAndLoadDetail(data);
}


// --- Events Functions ---

function changeEventTab(btn, type) {
    document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active-tab'));
    btn.classList.add('active-tab');
    document.getElementById('upcomingEventsContainer').style.display = type === 'upcoming' ? 'block' : 'none';
    document.getElementById('pastEventsContainer').style.display = type === 'past' ? 'block' : 'none';
}

// Function to load and render events (unchanged)
async function loadEvents() {
    const upcomingContainer = document.getElementById('upcomingEventsContainer');
    const pastContainer = document.getElementById('pastEventsContainer');
    upcomingContainer.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading events...</div>';
    pastContainer.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading events...</div>';

    // Use global allMembersData if loaded, otherwise fetch it.
    const members = allMembersData.length > 0 ? allMembersData : (await _supabase.from('family_data').select('*')).data || [];
    
    const events = [];
    const today = new Date();
    const currentYear = today.getFullYear();
    today.setHours(0, 0, 0, 0);

    members.forEach(member => {
        const name = maskFemaleName(member.full_name, member.gender);

        // 1. Birthday Event
        if (member.dob) {
            const dobDate = new Date(member.dob);
            // Calculate upcoming birthday date
            let birthdayThisYear = new Date(currentYear, dobDate.getMonth(), dobDate.getDate());
            if (birthdayThisYear < today) {
                birthdayThisYear = new Date(currentYear + 1, dobDate.getMonth(), dobDate.getDate());
            }
            events.push({
                id: member.id,
                date: birthdayThisYear,
                type: 'birthday',
                title: `${name}'s Birthday`,
                icon: 'fa-cake-candles',
                isAlive: member.is_alive
            });
        }

        // 2. Death Anniversary Event
        if (!member.is_alive && member.dod) {
            const dodDate = new Date(member.dod);
            // Calculate upcoming death anniversary date
            let anniversaryThisYear = new Date(currentYear, dodDate.getMonth(), dodDate.getDate());
            if (anniversaryThisYear < today) {
                anniversaryThisYear = new Date(currentYear + 1, dodDate.getMonth(), dodDate.getDate());
            }
            events.push({
                id: member.id,
                date: anniversaryThisYear,
                type: 'death',
                title: `${name}'s Death Anniversary`,
                icon: 'fa-cross',
                isAlive: member.is_alive 
            });
        }
    });

    // Sort events: Upcoming first, then by date
    events.sort((a, b) => a.date - b.date);

    const upcomingEvents = events.filter(e => e.date >= today);
    const pastEvents = events.filter(e => e.date < today);

    // Filter past events to only show those that already happened this year (by month/day comparison with current year)
    const pastEventsThisYear = [];
    events.forEach(e => {
        if (e.date < today) {
             // Only include events that are based on this year's calculation (i.e. if calculated date is past)
             // For birthdays/anniversaries, we only care about the year the calculation *put* it in.
             // Since the loop above calculates the *next* upcoming date, we only need to look at 'upcomingEvents' for events in the future.
             // This needs more robust logic for 'past' events if we want to show past events of the current year.
             // We will stick to the current implementation: Upcoming events (Today onwards)
        }
    });

    renderEventList(upcomingEvents, upcomingContainer, 'upcoming');
    // If we wanted to show all past events, this logic would need fixing. 
    // For now, keeping the past container empty or with a message, as the current date logic is future-focused.
    if (upcomingEvents.length === 0) {
        upcomingContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#555;">No upcoming events found.</div>';
    }
    pastContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#555;">Past events (within current year) functionality coming soon.</div>';
    
}

// Function to render the list of events (unchanged)
function renderEventList(events, container, type) {
    if (events.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:20px; color:#555;">No ${type} events found.</div>`;
        return;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let html = '';
    events.forEach(event => {
        const diffTime = event.date.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        let daysDiffText = '';
        if (diffDays === 0) daysDiffText = ' (Today)';
        else if (diffDays === 1) daysDiffText = ' (Tomorrow)';
        else if (diffDays > 0) daysDiffText = ` (in ${diffDays} days)`;

        html += `
        <div class="event-card ${type === 'past' ? 'past' : ''}">
            <div class="event-icon">
                <i class="fa-solid ${event.icon}"></i>
            </div>
            <div class="event-details">
                <div class="event-title">${event.title} ${event.isAlive ? '' : ' (Deceased)'}</div>
                <div class="event-date">
                    ${formatDate(event.date)} <span class="event-days">${type === 'upcoming' ? daysDiffText : ''}</span>
                </div>
            </div>
        </div>
        `;
    });
    container.innerHTML = html;
}


function openEvents() {
    loadEvents();
    document.getElementById("eventsModal").style.display="flex";
    document.getElementById("myDropdown").classList.remove('show');
}

function closeEvents() {
    document.getElementById("eventsModal").style.display="none";
}

// --- All Members List Functions ---

function openAllMembers(event){
    event.preventDefault(); // Stop link navigation
    document.getElementById("allMembersModal").style.display="flex";
    document.getElementById("myDropdown").classList.remove('show');
    // Clear search and reset sort before loading
    document.getElementById('allMembersSearch').value = '';
    currentSortColumn = 'full_name';
    currentSortDirection = 'asc';
    renderMemberList();
    setupSortListeners();
}

function closeAllMembers(){
    document.getElementById("allMembersModal").style.display="none";
}

// Function to sort the array (unchanged)
function sortMemberList(a, b) {
    const column = currentSortColumn;
    const dir = currentSortDirection === 'asc' ? 1 : -1;
    let valA = a[column];
    let valB = b[column];

    // Custom handling for Age sorting (using DOB column)
    if (column === 'dob') {
        valA = getAgeForList(a.dob, a.is_alive, a.dod);
        valB = getAgeForList(b.dob, b.is_alive, b.dod);
        
        if (valA === -1) return dir * 1;
        if (valB === -1) return dir * -1; 
        // Sort by Age (Largest Age first for 'asc' means oldest first)
        return dir * (valB - valA);
    }
    
    // Custom handling for Parent Name sorting (we need to get the parent's full name)
    if (column === 'parent_name') {
        const parentA = allMembersData.find(m => m.id === a.parent_id);
        const parentB = allMembersData.find(m => m.id === b.parent_id);
        valA = parentA ? parentA.full_name : 'zzzzz'; // Root members last
        valB = parentB ? parentB.full_name : 'zzzzz';
    }

    if (typeof valA === 'string') {
        return dir * valA.localeCompare(valB);
    }
    
    // Simple number comparison for ID/is_alive
    if (valA < valB) return dir * -1;
    if (valA > valB) return dir * 1;
    return 0;
}

// Function to render the member list (unchanged)
function renderMemberList(membersToRender) {
    const body = document.getElementById('memberListBody');
    const members = membersToRender || allMembersData;
    
    // Sort the list
    members.sort(sortMemberList);

    if (members.length === 0) {
        body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#555;">No members to display.</td></tr>';
        return;
    }

    let html = '';
    members.forEach(member => {
        const nameToDisplay = maskFemaleName(member.full_name, member.gender);
        const parent = allMembersData.find(m => m.id === member.parent_id);
        const parentName = parent ? maskFemaleName(parent.full_name, parent.gender) : 'N/A (Root)';
        const statusText = member.is_alive ? 'Alive' : 'Deceased';
        const age = getAgeForList(member.dob, member.is_alive, member.dod);
        const ageText = age >= 0 ? `${age} yrs` : 'N/A';

        html += `
            <tr>
                <td>${nameToDisplay}</td>
                <td>${parentName}</td>
                <td><td>${statusText}</td></td>
                <td>${ageText}</td>
                <td><button class="details-link" onclick="openMemberDetail(${member.id})">View</button></td>
            </tr>
        `;
    });
    body.innerHTML = html;
}

// MODIFIED: Added Romanized name and parent name search check
function searchMemberList(searchText) {
    const text = searchText.toLowerCase().trim();
    if (!text) {
        renderMemberList(allMembersData);
        return;
    }
    const filtered = allMembersData.filter(member => {
        const name = (member.full_name || '').toLowerCase();
        const romanizedName = romanizeForSearch(member.full_name); // NEW: Romanized name check

        const parent = allMembersData.find(m => m.id === member.parent_id);
        const parentName = (parent ? parent.full_name : '').toLowerCase();
        const romanizedParentName = parent ? romanizeForSearch(parent.full_name) : ''; // NEW: Romanized parent name check

        const status = (member.is_alive ? 'alive' : 'deceased').toLowerCase();
        
        return name.includes(text) || romanizedName.includes(text) || // Check Name (Urdu or Romanized)
               parentName.includes(text) || romanizedParentName.includes(text) || // Check Parent Name (Urdu or Romanized)
               status.includes(text); // Check Status
    });
    renderMemberList(filtered);
}

// Listener for table header clicks (unchanged)
function setupSortListeners() {
    document.querySelectorAll('#memberListHeader .sortable').forEach(th => {
        th.removeEventListener('click', handleSortClick); // Prevent duplicate listeners
        th.addEventListener('click', handleSortClick);
    });
}

function handleSortClick() {
    const newColumn = this.getAttribute('data-sort');
    if (currentSortColumn === newColumn) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // Reset direction to 'asc' for a new column
        currentSortColumn = newColumn;
        currentSortDirection = 'asc';
    }
    // Remove all sort classes
    document.querySelectorAll('#memberListHeader .sortable').forEach(t => t.classList.remove('asc', 'desc'));
    // Add current sort class
    this.classList.add(currentSortDirection);
    // Re-render the list with the current search filter
    searchMemberList(document.getElementById('allMembersSearch').value);
}


// --- Search Functions ---

// MODIFIED: Function to handle search input (Live Search Feature) to include Romanized search
function handleSearchInput(text) {
    const resultsContainer = document.getElementById('searchResults');
    text = text.toLowerCase().trim();

    // Hide if search text is too short
    if (text.length < 2) {
        resultsContainer.innerHTML = '';
        resultsContainer.style.display = 'none';
        // Reload main tree view if search bar is cleared
        if (currentRootId) loadFamilyTree(currentRootId);
        return;
    }

    // Filter members
    const matchingMembers = allMembersData.filter(member => {
        const name = (member.full_name || '').toLowerCase();
        const romanizedName = romanizeForSearch(member.full_name); // NEW: Romanized name check
        
        return name.includes(text) || romanizedName.includes(text); // Check against both Urdu and Romanized name
    }).slice(0, 10); // Limit to 10 results

    let html = '';
    if (matchingMembers.length === 0) {
        html = '<div style="padding: 10px; color: #777; font-size: 13px; text-align: center;">کوئی ممبر نہیں ملا۔</div>';
    } else {
        matchingMembers.forEach(member => {
            // Find parent for context (Display Context Feature)
            const parent = allMembersData.find(m => m.id === member.parent_id);
            const parentName = parent ? maskFemaleName(parent.full_name, parent.gender) : 'Root / No Parent';
            const nameToDisplay = maskFemaleName(member.full_name, member.gender);
            const iconClass = member.gender && member.gender.toLowerCase() === 'f' ? 'fa-person-dress' : 'fa-person';
            const iconColor = member.gender && member.gender.toLowerCase() === 'f' ? '#e74c3c' : '#3498db';

            html += `
                <div class="search-result-item" onclick="selectMemberFromSearch(${member.id})">
                    <div class="result-icon" style="color: ${iconColor};">
                        <i class="fa-solid ${iconClass}"></i>
                    </div>
                    <div class="result-info">
                        <div class="result-name">${nameToDisplay}</div>
                        <div class="result-parent">Son/Daughter of: ${parentName}</div>
                    </div>
                </div>
            `;
        });
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
}

// NEW: Function to handle selecting a member from the search list (Locate & Highlight Feature) (unchanged)
function selectMemberFromSearch(memberId) {
    const member = allMembersData.find(m => m.id == memberId);
    if (!member) return;

    // Rerender the tree with the selected member as the target for path expansion
    loadFamilyTree(currentRootId, [memberId]);
    
    // Close search interface
    handleSearchToggle(true); 
}


// --- Family Tree Functions ---

// MODIFIED: Added 'depth' argument and conditional collapse logic/icon
// Recursive function to create the tree HTML
function createTreeHtml(member, depth) {
    const nameToDisplay = maskFemaleName(member.full_name, member.gender);
    const hasChildren = member.children && member.children.length > 0;
    let imageHtml = '';
    if (member.image_url) {
        imageHtml = `<img src="${member.image_url}" alt="${nameToDisplay}" class="member-img">`;
    } else {
        const iconClass = member.gender && member.gender.toLowerCase() === 'f' ? 'fa-person-dress' : 'fa-person';
        const iconColor = member.gender && member.gender.toLowerCase() === 'f' ? '#e74c3c' : '#3498db';
        imageHtml = `<div class="member-img-placeholder"> <i class="fa-solid ${iconClass}" style="font-size: 30px; color: ${iconColor};"></i> </div>`;
    }

    // NEW: Add class for deceased members
    const isDeceased = !member.is_alive;
    const cardExtraClass = isDeceased ? 'deceased-member' : '';

    // LOGIC CHECK: Keep levels 1, 2, 3, and 4 OPEN. Collapse will only be applied from depth 5 onwards.
    const shouldBeCollapsed = hasChildren && depth > 4;

    let html = `<li id="member-${member.id}" class="${shouldBeCollapsed ? 'collapsed' : ''}"> 
        <div class="member-card-wrapper ${cardExtraClass}" onclick="openMemberDetail(${member.id})">
            ${imageHtml}
            <span class="member-info">${nameToDisplay.toUpperCase()}</span>
            ${hasChildren ? `<div class="collapse-btn" onclick="toggleChildren(this, event)"> 
                <i class="fa-solid ${shouldBeCollapsed ? 'fa-plus' : 'fa-minus'}"></i>
            </div>` : ''}
        </div>`;
    
    if(hasChildren){
        html += "<ul>";
        // RECURSIVE CALL: Pass depth + 1
        member.children.forEach(child => html += createTreeHtml(child, depth + 1));
        html += "</ul>";
    }

    html += "</li>";
    return html;
}

// NEW: Function to toggle visibility of deceased members via CSS class (unchanged)
function toggleDeceasedVisibility(isChecked) {
    const container = document.getElementById('visualTreeContainer');
    if (!isChecked) {
        // If checkbox is unchecked, add class to hide
        container.classList.add('hide-deceased');
    } else {
        // If checked, remove class to show
        container.classList.remove('hide-deceased');
    }
}

function toggleView() {
    isHorizontal = !isHorizontal;
    const container = document.getElementById('visualTreeContainer');
    const toggleBtn = document.getElementById('toggleViewBtn');

    if (isHorizontal) {
        container.classList.add('shajra-horizontal-tree');
        container.classList.remove('family-tree');
        toggleBtn.innerHTML = `<i class="fa-solid fa-compress"></i> Vertical`;
    } else {
        container.classList.add('family-tree');
        container.classList.remove('shajra-horizontal-tree');
        toggleBtn.innerHTML = `<i class="fa-solid fa-expand"></i> Horizontal`;
    }
    // Re-render the tree to apply the new classes/structure
    if (currentRootId) loadFamilyTree(currentRootId);
}

// MODIFIED FUNCTION: Load tree to include the root member in the display.
async function loadFamilyTree(rootId, pathIds = []) { 
    const container = document.getElementById('visualTreeContainer');
    const nameDisplay = document.getElementById('currentFamilyName');
    currentRootId = rootId;

    if (!rootId) {
        container.innerHTML = `<div style='color:#777; padding:20px;'>فیملی دیکھنے کے لیے اوپر سے کوئی رُوٹ (بنیادی ممبر) منتخب کریں۔</div>`;
        nameDisplay.innerHTML = `<i class="fa-solid fa-sitemap"></i> فیملی کا شجرہ`;
        return;
    }

    container.innerHTML = `<div style='text-align:center; padding:50px;'><i class="fa-solid fa-spinner fa-spin fa-2x"></i> Loading Family Tree...</div>`;

    if (allMembersData.length === 0) {
        const { data: allData, error: allError } = await _supabase.from('family_data').select('*');
        if (allError) {
            console.error("Error loading all data:", allError);
            return;
        }
        allMembersData = allData || [];
    }

    const members = allMembersData;

    const rootMember = members.find(m => m.id == rootId);
    if (!rootMember) {
        container.innerHTML = `<div style='color:red; padding:20px;'>Error: Root Member ID ${rootId} not found in data.</div>`;
        return;
    }

    nameDisplay.innerText = rootMember.full_name;

    // --- Existing recursive builder function ---
    function buildTree(parentId) {
        const children = members.filter(m => m.parent_id == parentId);
        if (children.length === 0) return null;

        return children.map(child => {
            return { ...child, children: buildTree(child.id) || [] };
        });
    }

    const rootData = { ...rootMember, children: buildTree(rootId) || [] };

    // Set the correct class for the tree container before rendering
    container.className = isHorizontal ? 'family-tree shajra-horizontal-tree' : 'family-tree';
    // Re-apply deceased filter if needed
    if (!document.getElementById('deceasedToggle').checked) {
        container.classList.add('hide-deceased');
    }

    // --- START MODIFICATION TO INCLUDE ROOT MEMBER ---
    
    // Get root member details for the card
    const rootName = maskFemaleName(rootMember.full_name, rootMember.gender);
    let rootImageHtml = '';
    if (rootMember.image_url) {
        rootImageHtml = `<img src="${rootMember.image_url}" alt="${rootName}" class="member-img">`;
    } else {
        const iconClass = rootMember.gender && rootMember.gender.toLowerCase() === 'f' ? 'fa-person-dress' : 'fa-person';
        const iconColor = rootMember.gender && rootMember.gender.toLowerCase() === 'f' ? '#e74c3c' : '#3498db';
        rootImageHtml = `<div class="member-img-placeholder"> <i class="fa-solid ${iconClass}" style="font-size: 30px; color: ${iconColor};"></i> </div>`;
    }
    const rootCardExtraClass = !rootMember.is_alive ? 'deceased-member' : '';

    // Start with the main UL for the tree structure
    let rootHtml = "<ul>"; 
    
    // Add the root member LI. The CSS for .family-tree > ul > li removes the top connector lines.
    rootHtml += `<li id="member-${rootMember.id}">
        <div class="member-card-wrapper ${rootCardExtraClass}" onclick="openMemberDetail(${rootMember.id})">
            ${rootImageHtml}
            <span class="member-info">${rootName.toUpperCase()}</span>
            </div>`;

    // Add children UL if they exist
    if (rootData.children && rootData.children.length > 0) {
        rootHtml += "<ul>";
        // Start children depth at 1. The children will be visible by default (depth 1 to 4 are not collapsed)
        rootData.children.forEach(child => rootHtml += createTreeHtml(child, 1));
        rootHtml += "</ul>";
    }

    rootHtml += "</li></ul>";

    container.innerHTML = rootHtml;
    
    // --- END MODIFICATION TO INCLUDE ROOT MEMBER ---

    // If a path is provided (from a search), expand it now
    if (pathIds.length > 0) {
        const fullPath = findPathToMember(pathIds[0], rootData);
        if (fullPath) expandPath(fullPath);
    }
}


// --- Site Initialization ---

// Function to load root members and site settings (unchanged)
async function loadRootMembers() {
    const { data, error } = await _supabase.from('family_data').select('id, full_name, gender').is('parent_id', null);

    if (error) {
        console.error("Error loading root members:", error);
        document.getElementById('rootMemberSelect').innerHTML = '<option>Error loading data</option>';
        return;
    }

    const select = document.getElementById('rootMemberSelect');
    select.innerHTML = '<option value="">-- Select Root --</option>'; // Default option

    if (data && data.length > 0) {
        // Sort roots by ID (or name, if preferred)
        data.sort((a, b) => a.id - b.id);
        
        data.forEach(member => {
            const nameToDisplay = maskFemaleName(member.full_name, member.gender);
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = nameToDisplay;
            select.appendChild(option);
        });
        
        // Auto-select the first root member and load the tree
        select.value = data[0].id;
        loadFamilyTree(data[0].id);
    } else {
        document.getElementById('visualTreeContainer').innerHTML = `<div style='color:red; padding:20px;'>No root members found. Please add data in the Admin Panel.</div>`;
    }
}

function openAnalytics() {
    // We only calculate stats for the currently selected root's descendants
    if (!currentRootId || allMembersData.length === 0) {
        document.getElementById('statTotal').innerText = '0';
        document.getElementById('statMale').innerText = '0 / 0';
        document.getElementById('statAlive').innerText = '0 / 0';
        document.getElementById('statOldest').innerText = 'N/A';
        document.getElementById('statYoungest').innerText = 'N/A';
        document.getElementById("analyticsModal").style.display="flex";
        document.getElementById("myDropdown").classList.remove('show');
        return;
    }

    const currentScope = getDescendantsAndSelf(currentRootId);
    calculateAndRenderStats(currentScope);
    
    document.getElementById("analyticsModal").style.display="flex";
    document.getElementById("myDropdown").classList.remove('show');
}

function closeAnalytics(){
    document.getElementById("analyticsModal").style.display="none";
}

function calculateAndRenderStats(data) {
    let total = data.length;
    let m = 0; // Male count
    let f = 0; // Female count
    let a = 0; // Alive count
    let d = 0; // Deceased count
    let oldestDob = '2100-01-01'; // Future date (to find the earliest DOB)
    let oldestMember = null;
    let youngestDob = '1900-01-01'; // Past date (to find the latest DOB)
    let youngestMember = null;

    data.forEach(x=>{
        // Gender counting
        if(x.gender) {
            if(x.gender.toLowerCase().startsWith('m')) m++;
            else f++;
        }

        // Alive/Deceased counting
        if(x.is_alive!==undefined){
            if(x.is_alive) a++;
            else d++;
        }

        // Oldest/Youngest calculation
        if (x.dob) {
            // Find oldest (earliest DOB)
            if (x.dob < oldestDob) {
                oldestDob = x.dob;
                oldestMember = x;
            }
            // Find youngest (latest DOB) - but only count alive members for meaningful 'youngest'
            if (x.dob > youngestDob && x.is_alive) {
                youngestDob = x.dob;
                youngestMember = x;
            }
        }
    });

    document.getElementById('statTotal').innerText = total;
    document.getElementById('statMale').innerText = `${m} / ${f}`;
    document.getElementById('statAlive').innerText = `${a} / ${d}`;

    if (oldestMember) {
        document.getElementById('statOldest').innerText = maskFemaleName(oldestMember.full_name, oldestMember.gender);
    } else {
        document.getElementById('statOldest').innerText = 'N/A';
    }

    if (youngestMember) {
        document.getElementById('statYoungest').innerText = maskFemaleName(youngestMember.full_name, youngestMember.gender);
    } else {
        document.getElementById('statYoungest').innerText = 'N/A';
    }
}


// --- Site Initialization ---
async function loadSiteSettings() {
    // Select all columns to ensure 'female-pass' is fetched
    const { data } = await _supabase.from('site_config').select('*').limit(1); 
    
    if(data?.[0]){
        // Store the passcode fetched from the database column 'female-pass'
        femalePasscode = data[0]['female-pass'] || data[0].female_pass || null; 
        
        // Existing settings logic
        document.getElementById('mainTitle').innerText=data[0].site_name;
        document.getElementById('dynamicUrduText').innerText=data[0].about_urdu;
        // The HTML structure has been updated, dynamicAboutText is now centered
        document.getElementById('dynamicAboutText').innerText=data[0].contact_desc; 
        // The HTML structure has been updated, dynamicPhone is now centered without "Contact:"
        document.getElementById('dynamicPhone').innerText=data[0].phone; 
        document.getElementById('dynamicWhatsapp').href = `https://wa.me/${data[0].whatsapp.replace(/[^0-9+]/g, '')}`;
        document.getElementById('featuresList').innerHTML=(data[0].features||"").split(',').map(f=>`<li>${f.trim()}</li>`).join('');
    }
}

// Initial load sequence
window.onload = function() {
    loadSiteSettings();
    loadRootMembers();
};
</script>

</body>
</html>