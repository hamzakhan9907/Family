<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Shajra</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // IMPORTANT: Supabase connection details 
        const supabaseUrl = 'https://ojphjodmpyblyfyinacb.supabase.co';
        const k1 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qcGhqb2RtcHlibHlmeWluYWN";
        const k2 = "iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTUwNTAsImV4cCI6MjA3OTk5MTA1MH0";
        const k3 = ".mwKu_g5_OT_89KcAeeSsY8IMlnakV2nQVtKRhWWTcDw";
        const SUPABASE_ANON_KEY = k1 + k2 + k3; 
        const _supabase = supabase.createClient(supabaseUrl, SUPABASE_ANON_KEY);
        
        // --- ADDED SESSION CONSTANT (FIXED: 1 HOUR) ---
        const SESSION_TIMEOUT_MS = 60 * 05 * 1000; // 60 minutes (1 hour) in milliseconds
        // ----------------------------------------------

        // --- NEW CONSTANT FOR STORAGE (Using user's bucket name) ---
        const MEMBER_BUCKET = 'shajra-photos'; 
        // -----------------------------------------------------------

        // --- DB-DRIVEN ADMIN PASSCODE ---
        let adminPasswordHash = null; // Password will be fetched from DB
        let femalePasscodeLocal = null; // To store the female detail passcode
        let settingsLoaded = false; 
        // ---------------------------------
        
        // --- AUTH & SETUP ---
        // Helper function to handle UI changes and initialization
        function togglePanelDisplay(status) {
            if (status) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadMembers();
                loadSiteConfig();
                // Default to showing member list after login
                showSection('memberListSection'); 
            } else {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        }

        // Function to extend the session
        function refreshSession() {
            // Check if still logged in via expiry token before refreshing
            const expiryString = localStorage.getItem('adminSessionExpiry');
            if (expiryString && Date.now() < parseInt(expiryString, 10)) { 
                const expiry = Date.now() + SESSION_TIMEOUT_MS;
                localStorage.setItem('adminSessionExpiry', expiry.toString());
            }
        }
        
        // Main function for session state management
        function setLoggedIn(status) {
            if (status) {
                const expiry = Date.now() + SESSION_TIMEOUT_MS;
                localStorage.setItem('adminSessionExpiry', expiry.toString());
                
                if (!window.sessionRefreshInterval) {
                    window.sessionRefreshInterval = setInterval(refreshSession, SESSION_TIMEOUT_MS / 2);
                }
            } else {
                localStorage.removeItem('adminSessionExpiry');
                
                if (window.sessionRefreshInterval) {
                    clearInterval(window.sessionRefreshInterval);
                    window.sessionRefreshInterval = null;
                }
            }
            togglePanelDisplay(status);
        }
        
        // Check session status on page load
        function checkLoginStatus() {
            const expiryString = localStorage.getItem('adminSessionExpiry');
            
            if (expiryString) {
                const expiryTime = parseInt(expiryString, 10);
                if (Date.now() < expiryTime) {
                    setLoggedIn(true); 
                } else {
                    localStorage.removeItem('adminSessionExpiry');
                    togglePanelDisplay(false);
                }
            } else {
                 togglePanelDisplay(false);
            }
            
            // Load the password hash from DB
            fetchAdminPassword();
        }

        // --- PASSCODE FETCHING ---
        async function fetchAdminPassword() {
            // Fetch admin_password and the correct column name female_pass
            const { data, error } = await _supabase.from('site_config').select('admin_password, female_pass').limit(1);
            
            if (data && data.length > 0) {
                // This ensures admin login uses the DB value
                adminPasswordHash = data[0].admin_password || "1234";
                
                // Fetch female passcode and use null if not set
                femalePasscodeLocal = data[0].female_pass || null; 
            } else if (error) {
                console.error("Error fetching admin password:", error);
                adminPasswordHash = "1234"; // Fallback
                femalePasscodeLocal = null; // Fallback
            } else {
                adminPasswordHash = "1234"; 
                femalePasscodeLocal = null;
            }
            // Update the display field
            if (document.getElementById('currentFemalePasscodeDisplay')) {
                document.getElementById('currentFemalePasscodeDisplay').value = femalePasscodeLocal || '(No Passcode Set)';
            }
        }

        // --- ADMIN LOGIN FUNCTION ---
        async function loginAdmin() {
            const passcode = document.getElementById('passcode').value;
            
            // Ensure password is loaded before comparing
            if (!adminPasswordHash) await fetchAdminPassword(); 
            
            if (passcode === adminPasswordHash) {
                setLoggedIn(true);
                alert("Login successful!");
            } else {
                alert("Invalid Passcode.");
            }
            document.getElementById('passcode').value = '';
        }
        
        // --- LOGOUT FUNCTION ---
        function logoutAdmin() {
            setLoggedIn(false);
            alert("Logged out.");
            window.location.href = 'index.html'; 
        }
        
        // --- SECTION SWITCHING (UPDATED to include femalePasscodeSection) ---
        function showSection(sectionId) {
            // Hide all sections
            document.getElementById('memberManagementSection').style.display = 'none';
            document.getElementById('memberListSection').style.display = 'none';
            document.getElementById('siteSettingsSection').style.display = 'none';
            document.getElementById('passcodeSection').style.display = 'none';
            document.getElementById('femalePasscodeSection').style.display = 'none'; 

            // Show the requested section
            document.getElementById(sectionId).style.display = 'block';

            // Special case: Load members if list is shown
            if (sectionId === 'memberListSection') {
                loadMembers();
            }
             // Special case: Load config if female passcode is shown
            if (sectionId === 'femalePasscodeSection') {
                // Ensure the latest loaded value is displayed
                 if(femalePasscodeLocal !== null) {
                    document.getElementById('currentFemalePasscodeDisplay').value = femalePasscodeLocal || '(No Passcode Set)';
                 } else {
                    fetchAdminPassword(); // Fetch all config including female pass
                 }
            }
            // Scroll to the top of the container
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
        }


        // --- DATA MANAGEMENT (CRUD) ---
        let allMembers = [];
        let editingMemberId = null;

        async function loadMembers() {
            const { data, error } = await _supabase.from('family_data').select('*').order('full_name', { ascending: true });
            
            if (error) {
                alert('Error loading members: ' + error.message);
                return;
            }
            
            allMembers = data;
            renderMemberTable(data);
            populateParentSelects();
            
            // NEW: Clear the search box when members are reloaded
            if (document.getElementById('memberSearchInput')) {
                document.getElementById('memberSearchInput').value = '';
            }
        }
        
        // (Render Member Table function MODIFIED for Mobile Card View data labels)
        function renderMemberTable(members) {
            const tableBody = document.getElementById('memberTableBody');
            tableBody.innerHTML = ''; 
            
            if (members.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; color: var(--color-danger); font-weight: 600;">No members found matching the current filter.</td></tr>';
                 return;
            }

            members.forEach(member => {
                const parent = allMembers.find(m => m.id === member.parent_id);
                const spouse = allMembers.find(m => m.id === member.spouse_id);
                
                const row = tableBody.insertRow();
                // Add class for striped effect
                row.className = row.rowIndex % 2 === 0 ? 'even-row' : 'odd-row'; 
                row.innerHTML = `
                    <td class="admin-table-cell" data-label="ID">${member.id}</td>
                    <td class="admin-table-cell" data-label="Full Name">${member.full_name || 'N/A'}</td>
                    <td class="admin-table-cell" data-label="Parent">${parent ? parent.full_name : 'Root'}</td>
                    <td class="admin-table-cell" data-label="DOB">${member.dob || 'N/A'}</td>
                    <td class="admin-table-cell" data-label="Gender">${member.gender || 'N/A'}</td>
                    <td class="admin-table-cell" data-label="Alive">${member.is_alive ? 'Yes' : 'No'}</td>
                    <td class="admin-table-cell" data-label="Spouse">${spouse ? spouse.full_name : (member.spouse_external_name || 'N/A')}</td>
                    <td class="admin-table-cell admin-actions" data-label="Actions">
                        <button onclick="editMember(${member.id})" class="edit-btn">Edit</button>
                        <button onclick="deleteMember(${member.id})" class="delete-btn">Delete</button>
                    </td>
                `;
            });
        }
        
        // (Populate Parent/Spouse Selects function remains the same)
        function populateParentSelects(currentParentId = null, currentSpouseId = null) {
            const parentSelect = document.getElementById('parentID');
            const spouseSelect = document.getElementById('spouseID');
            
            parentSelect.innerHTML = '<option value="">(Optional) No Parent / Root Member</option>';
            spouseSelect.innerHTML = '<option value="">(Optional) No Spouse / External Spouse</option>';
            
            allMembers.forEach(member => {
                const parentOption = new Option(member.full_name, member.id);
                // Store the searchable text on the option for fast filtering
                parentOption.setAttribute('data-search', getSearchableText(member.full_name)); 
                if (member.id === currentParentId) { parentOption.selected = true; }
                parentSelect.add(parentOption);
                
                const spouseOption = new Option(member.full_name, member.id);
                // Store the searchable text on the option for fast filtering
                spouseOption.setAttribute('data-search', getSearchableText(member.full_name));
                if (member.id === currentSpouseId) { spouseOption.selected = true; }
                spouseSelect.add(spouseOption);
            });
        }

        // --- NEW TRANS-LITERATION/SEARCHABLE TEXT HELPER (Used by both member list and select boxes) ---
        function getSearchableText(text) {
            if (!text) return '';
            let s = text.toLowerCase().trim();

            const urduToRomanMap = {
                'ا': 'a', 'آ': 'aa', 'ب': 'b', 'پ': 'p', 'ت': 't', 'ٹ': 't', 
                'ث': 's', 'ج': 'j', 'چ': 'ch', 'ح': 'h', 'خ': 'kh', 'د': 'd', 
                'ڈ': 'd', 'ذ': 'z', 'ر': 'r', 'ڑ': 'r', 'ز': 'z', 'ژ': 'zh', 
                'س': 's', 'ش': 'sh', 'ص': 's', 'ض': 'z', 'ط': 't', 'ظ': 'z', 
                'ع': 'a', 'غ': 'gh', 'ف': 'f', 'ق': 'q', 'ک': 'k', 'گ': 'g', 
                'ل': 'l', 'م': 'm', 'ن': 'n', 'و': 'w', 'ہ': 'h', 'ھ': 'h', 
                'ی': 'y', 'ے': 'y', 'ء': '', 'ؤ': 'w', 'ئ': 'y',
            };
            
            let romanized = '';
            for (const char of s) {
                if (urduToRomanMap[char]) {
                    romanized += urduToRomanMap[char];
                } else {
                    romanized += char;
                }
            }
            
            return romanized.replace(/[^a-z0-9]/g, '').trim(); 
        }
        // ---------------------------------------------------------------------

        // --- FILTERING FUNCTION FOR MEMBER LIST (NEW) ---
        function filterMemberList(filterText) {
            const filter = getSearchableText(filterText); 
            
            // If the filter is empty, show all members
            if (!filter) {
                renderMemberTable(allMembers);
                return;
            }

            const filteredMembers = allMembers.filter(member => {
                // Get the searchable version of the member's name
                const searchableName = getSearchableText(member.full_name);
                
                // Check if the searchable name contains the searchable filter text
                return searchableName.includes(filter);
            });

            renderMemberTable(filteredMembers);
        }
        // ----------------------------------------
        
        // --- FILTERING FUNCTION (for Parent/Spouse Selects) ---
        function filterSelectOptions(selectId, filterText) {
            const select = document.getElementById(selectId);
            const options = select.options;
            
            // Standardize the search query (e.g., "ali" -> "ali")
            const filter = getSearchableText(filterText); 

            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                
                // Keep the first option (No Parent/No Spouse) always visible
                if (i === 0) {
                    option.style.display = 'block';
                    continue; 
                }

                // Get the searchable text from the data attribute (pre-calculated Urdu->Roman or just the name)
                const searchableName = option.getAttribute('data-search') || getSearchableText(option.text);

                // If filter is empty, show all. If searchable name contains the filter, show it.
                if (filter === '' || searchableName.includes(filter)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            }
            
            // If the currently selected option is hidden, reset selection to the first option
            const currentlySelectedOption = select.selectedIndex > -1 ? select.options[select.selectedIndex] : null;
            
            if (currentlySelectedOption && currentlySelectedOption.style.display === 'none') {
                 select.selectedIndex = 0; // Select the 'No Parent/No Spouse' option
            }
        }
        // ----------------------------------------
        
        // --- NEW IMAGE HELPER FUNCTIONS ---
        function resetImageFields() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('existingImageURL').value = '';
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('currentImagePreview').src = '';
            document.getElementById('imageStatus').innerText = 'Current Image: ';
            
            // NEW: Also clear the search fields when resetting the form
            document.getElementById('parentSearch').value = '';
            filterSelectOptions('parentID', '');
            document.getElementById('spouseSearch').value = '';
            filterSelectOptions('spouseID', '');
        }

        // Function to mark image for removal/clearing
        function removeImage() {
            if (confirm('Are you sure you want to remove the current image?')) {
                // Set a special value to indicate deletion
                document.getElementById('existingImageURL').value = 'REMOVE_IMAGE'; 
                document.getElementById('imagePreviewContainer').style.display = 'none';
                alert('Image marked for removal on next save. Please click "Save Changes" now.');
            }
        }
        // ------------------------------------

        function setupMemberForm() {
            const form = document.getElementById('memberForm');
            form.reset();
            editingMemberId = null;
            document.getElementById('memberFormTitle').innerText = 'Add New Member';
            document.getElementById('memberFormSubmit').innerText = 'Add Member';
            
            // NEW: Reset relation to default and call image reset
            document.getElementById('relation').value = ''; 
            resetImageFields(); // Contains search reset
            
            loadMembers(); // Call loadMembers to fetch fresh data and populate selects with data-search attribute
            showSection('memberManagementSection'); 
        }

        async function saveMember() {
            const imageFile = document.getElementById('imageUpload').files[0];
            let imageURLToSave = document.getElementById('existingImageURL').value; 
            
            const fullName = document.getElementById('fullName').value.trim();

            // Basic Validation
            if (!fullName) {
                alert("Full Name is required.");
                return;
            }

            // --- 1. HANDLE IMAGE UPLOAD/DELETION ---
            if (imageURLToSave === 'REMOVE_IMAGE') {
                // Image marked for removal
                imageURLToSave = null; 
            } else if (imageFile) {
                // New image uploaded
                const fileExtension = imageFile.name.split('.').pop();
                // Create a unique filename based on ID or timestamp and name
                const baseName = fullName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50);
                const fileName = `${editingMemberId || Date.now()}-${baseName}.${fileExtension}`;
                
                // Upload to Supabase Storage
                const { data: uploadData, error: uploadError } = await _supabase.storage
                    .from(MEMBER_BUCKET)
                    .upload(fileName, imageFile, {
                        cacheControl: '3600',
                        upsert: true 
                    });

                if (uploadError) {
                    alert('Image upload failed: ' + uploadError.message);
                    return; 
                }
                
                // Get the public URL of the uploaded file
                const { data: publicUrlData } = _supabase.storage
                    .from(MEMBER_BUCKET)
                    .getPublicUrl(fileName);
                    
                imageURLToSave = publicUrlData.publicUrl;
                
            } else if (editingMemberId && imageURLToSave) {
                // Editing existing member, no new file, URL remains the same
            } else {
                 // No file and no existing URL
                 imageURLToSave = null;
            }
            // ------------------------------------------

            const memberData = {
                full_name: fullName,
                relation: document.getElementById('relation').value.trim() || null, 
                gender: document.getElementById('gender').value || null,
                dob: document.getElementById('dob').value || null,
                image_url: imageURLToSave, // FINAL Image URL
                is_alive: document.getElementById('isAlive').checked,
                parent_id: document.getElementById('parentID').value || null,
                spouse_id: document.getElementById('spouseID').value || null,
                spouse_external_name: document.getElementById('spouseExternalName').value.trim() || null,
            };


            let result;
            if (editingMemberId) {
                // Update existing member
                result = await _supabase.from('family_data').update(memberData).eq('id', editingMemberId);
                if (!result.error) {
                    alert('Member updated successfully!');
                }
            } else {
                // Insert new member
                result = await _supabase.from('family_data').insert([memberData]);
                if (!result.error) {
                    alert('Member added successfully!');
                }
            }

            if (result.error) {
                alert('Operation failed: ' + result.error.message);
            } else {
                setupMemberForm(); // Reset form and mode
                loadMembers(); // Refresh the table
                showSection('memberListSection'); // Go back to the list after action
            }
        }
        
        function editMember(memberId) {
            const member = allMembers.find(m => m.id === memberId);
            if (!member) return;

            editingMemberId = memberId;
            document.getElementById('memberFormTitle').innerText = `Edit Member: ${member.full_name}`;
            document.getElementById('memberFormSubmit').innerText = 'Save Changes';
            
            // Populate form fields
            document.getElementById('fullName').value = member.full_name || '';
            document.getElementById('relation').value = member.relation || ''; 
            document.getElementById('gender').value = member.gender || '';
            document.getElementById('dob').value = member.dob || '';
            document.getElementById('isAlive').checked = member.is_alive === true;
            document.getElementById('spouseExternalName').value = member.spouse_external_name || '';

            // --- NEW: Handle Image Preview and Existing URL ---
            resetImageFields(); // Pehle reset karein (This also clears search bars)
            if (member.image_url) {
                document.getElementById('existingImageURL').value = member.image_url;
                document.getElementById('currentImagePreview').src = member.image_url;
                document.getElementById('imageStatus').innerText = 'Current Image: ' + member.image_url.split('/').pop().substring(0, 20) + '...';
                document.getElementById('imagePreviewContainer').style.display = 'flex';
            }
            // ----------------------------------------------------

            // Populate Parent/Spouse selects with current values selected
            populateParentSelects(member.parent_id, member.spouse_id);
            
            // Show the form section
            showSection('memberManagementSection');
        }
        
        // (Delete Member function remains the same)
        async function deleteMember(memberId) {
            if (confirm(`Are you sure you want to delete member ID ${memberId}? This cannot be undone.`)) {
                const { error } = await _supabase.from('family_data').delete().eq('id', memberId);
                
                if (error) {
                    alert('Error deleting member: ' + error.message);
                } else {
                    alert('Member deleted successfully!');
                    loadMembers(); 
                    if (editingMemberId === memberId) {
                        setupMemberForm();
                    }
                }
            }
        }
        
        // --- SITE SETTINGS MANAGEMENT (Updated to include new fields) ---
        async function loadSiteConfig() {
            // UPDATED: Selecting all config fields including new ones
            const { data, error } = await _supabase.from('site_config').select('site_name, about_urdu, contact_desc, features, female_pass, phone, whatsapp, site_color, hide_dob_for_living, welcome_message').limit(1);
            if (error) {
                console.error("Error loading site config:", error);
                return;
            }
            if (data && data.length > 0) {
                const config = data[0];
                document.getElementById('siteName').value = config.site_name || '';
                document.getElementById('aboutUrdu').value = config.about_urdu || '';
                document.getElementById('contactDesc').value = config.contact_desc || '';
                document.getElementById('features').value = config.features || '';
                document.getElementById('phoneNumber').value = config.phone || '';
                document.getElementById('whatsappNumber').value = config.whatsapp || '';
                
                // NEW: Load new settings
                document.getElementById('siteColor').value = config.site_color || '#4338CA'; // Default: Indigo
                document.getElementById('hideDOB').checked = config.hide_dob_for_living === true;
                document.getElementById('welcomeMessage').value = config.welcome_message || '';

                // Load female passcode and store it locally
                femalePasscodeLocal = config.female_pass || null; 
                if (document.getElementById('currentFemalePasscodeDisplay')) {
                    document.getElementById('currentFemalePasscodeDisplay').value = femalePasscodeLocal || '(No Passcode Set)';
                }
            } else {
                 console.log("No site config found, ready for first save.");
            }
            settingsLoaded = true;
        }

        // (Save Site Config function updated)
        async function saveSiteConfig() {
            if (!settingsLoaded) {
                 alert("Settings not fully loaded yet. Please wait.");
                 return;
            }
            
            const configData = {
                site_name: document.getElementById('siteName').value.trim() || null,
                about_urdu: document.getElementById('aboutUrdu').value.trim() || null,
                contact_desc: document.getElementById('contactDesc').value.trim() || null,
                features: document.getElementById('features').value.trim() || null,
                phone: document.getElementById('phoneNumber').value.trim() || null,
                whatsapp: document.getElementById('whatsappNumber').value.trim() || null,
                
                // NEW: Save new settings
                site_color: document.getElementById('siteColor').value.trim() || '#4338CA',
                hide_dob_for_living: document.getElementById('hideDOB').checked,
                welcome_message: document.getElementById('welcomeMessage').value.trim() || null,
            };

            const { data: existing } = await _supabase.from('site_config').select('id').limit(1);
            let result;

            if (existing && existing.length > 0) {
                result = await _supabase.from('site_config').update(configData).eq('id', existing[0].id);
            } else {
                result = await _supabase.from('site_config').insert([configData]);
            }
            
            if (result.error) {
                alert('Error saving site configuration: ' + result.error.message);
            } else {
                alert('Site configuration saved successfully!');
                loadSiteConfig(); 
            }
        }
        
        // --- ADMIN PASSCODE MANAGEMENT (Remains the same) ---
        async function changePasscode() {
            const currentPass = document.getElementById('currentPasscode').value;
            const newPass = document.getElementById('newPasscode').value;
            const confirmPass = document.getElementById('confirmPasscode').value;
            
            if (!currentPass || !newPass || !confirmPass) {
                alert("All fields are required.");
                return;
            }
            
            if (currentPass !== adminPasswordHash) {
                alert("Incorrect Current Passcode.");
                return;
            }
            
            if (newPass !== confirmPass) {
                alert("New Passcode and Confirm Passcode do not match.");
                return;
            }

            if (newPass === adminPasswordHash) {
                 alert("Error: New Passcode cannot be the same as the current one.");
                 return;
            }
            
            // 1. Update the password in the database
            const { data: existing } = await _supabase.from('site_config').select('id').limit(1);
            let result;
            
            if (existing && existing.length > 0) {
                 result = await _supabase.from('site_config').update({ admin_password: newPass }).eq('id', existing[0].id);
            } else {
                 result = await _supabase.from('site_config').insert([{ admin_password: newPass }]);
            }

            if (result.error) {
                alert(`Error updating passcode in DB: ${result.error.message}`);
                return;
            }
            
            // 2. Update local variable and clear fields
            adminPasswordHash = newPass;
            document.getElementById('currentPasscode').value = '';
            document.getElementById('newPasscode').value = '';
            document.getElementById('confirmPasscode').value = '';

            alert("Admin Passcode successfully changed and saved to Supabase! You will now be logged out to apply the new setting.");
            
            // 3. Force logout
            logoutAdmin();
        }

        // --- FEMALE PASSCODE MANAGEMENT (RE-ADDED & MODIFIED) ---
        async function saveFemalePasscode() {
            // Trim to handle whitespace input
            const newPass = document.getElementById('newFemalePasscode').value.trim();
            const confirmPass = document.getElementById('confirmFemalePasscode').value.trim();
            
            // Check if user is trying to set a new password
            if (newPass) { 
                if (newPass !== confirmPass) {
                    alert("New Passcode and Confirm Passcode do not match.");
                    return;
                }
            } else {
                // If newPass is empty, user intends to remove/clear it.
                if (confirmPass) {
                     alert("To remove the passcode, both 'New Passcode' and 'Confirm New Passcode' fields must be empty.");
                     return;
                }
                // If both are empty, proceed to set to null
            }

            // Determine the value to save (null if empty, or the newPass value)
            const passcodeToSave = newPass || null;
            
            // 1. Update the female passcode in the database
            const { data: existing } = await _supabase.from('site_config').select('id').limit(1);
            let result;
            
            // Use 'female_pass' as the target column name for saving
            const updateData = { female_pass: passcodeToSave }; 
            
            if (existing && existing.length > 0) {
                 result = await _supabase.from('site_config').update(updateData).eq('id', existing[0].id);
            } else {
                 // If site_config is empty, insert the new female password
                 result = await _supabase.from('site_config').insert([updateData]);
            }

            if (result.error) {
                alert(`Error updating female passcode in DB: ${result.error.message}`);
                return;
            }
            
            // 2. Update local variable and clear fields
            femalePasscodeLocal = passcodeToSave;
            document.getElementById('currentFemalePasscodeDisplay').value = passcodeToSave || '(No Passcode Set)';
            document.getElementById('newFemalePasscode').value = '';
            document.getElementById('confirmFemalePasscode').value = '';

            if (passcodeToSave) {
                alert("Female Detail Passcode successfully changed and saved to Supabase!");
            } else {
                alert("Female Detail Passcode successfully REMOVED (cleared) from Supabase!");
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', checkLoginStatus);
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ----------------- COLOR PALETTE ----------------- */
        :root {
            --color-primary: #4338CA; /* Deep Indigo (Default) */
            --color-secondary: #10B981; /* Emerald Green */
            --color-danger: #EF4444; /* Red */
            --color-warning: #FBBF24; /* Amber */
            --color-background: #F9FAFB; /* Light Grey */
            --color-text-dark: #1F2937; /* Dark Grey */
            --color-text-light: #6B7280; /* Medium Grey */
        }
        
        /* ----------------- GLOBAL ----------------- */
        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            background-color: var(--color-background); 
            color: var(--color-text-dark);
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 10px; 
        }
        
        /* ----------------- HEADER ----------------- */
        .header { 
            background-color: var(--color-primary); 
            color: white; 
            padding: 18px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        .header h1 { 
            margin: 0; 
            font-size: 24px; 
            font-weight: 700;
        }
        .logout-btn { 
            background-color: var(--color-danger); 
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
            font-weight: 600;
        }
        .logout-btn:hover { 
            background-color: #DC2626; /* Slightly darker red */
        }

        /* ----------------- LOGIN PAGE ----------------- */
        #loginPage { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: #E0E7FF; /* Light Indigo background */
        }
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            width: 90%; 
            max-width: 400px; 
            text-align: center;
        }
        .login-box h2 { 
            color: var(--color-text-dark); 
            margin-bottom: 30px; 
            border-bottom: 4px solid var(--color-secondary); 
            display: inline-block; 
            padding-bottom: 8px; 
            font-size: 24px;
        }
        .login-box input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 25px;
            border: 2px solid #D1D5DB;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .login-box input[type="password"]:focus {
             border-color: var(--color-primary);
        }
        .login-box button {
            width: 100%;
            background-color: var(--color-primary);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .login-box button:hover {
            background-color: #3730A3; /* Darker Indigo */
        }

        /* ----------------- ADMIN PANEL NAVIGATION ----------------- */
        .admin-nav-button-container {
            display: flex;
            flex-direction: column; 
            gap: 12px;
            margin: 25px 0;
        }
        .admin-nav-button {
            background-color: var(--color-primary);
            color: white;
            padding: 15px 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-nav-button i {
            margin-right: 10px;
        }
        .admin-nav-button:hover {
            background-color: #3730A3;
            transform: translateY(-2px);
        }

        @media (min-width: 600px) {
            .admin-nav-button-container {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-between;
            }
            .admin-nav-button {
                width: 19%; 
            }
        }
        
        /* ----------------- ADMIN SECTIONS (CARDS) ----------------- */
        .admin-section {
            background: white;
            padding: 30px;
            margin: 25px 0;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border-top: 5px solid var(--color-secondary);
            display: none; 
        }
        .admin-section h2 {
            color: var(--color-primary);
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #F3F4F6;
            font-size: 22px;
            font-weight: 700;
        }
        .admin-section h2 i {
            margin-right: 8px;
        }
        
        /* ----------------- FORM ELEMENTS ----------------- */
        .admin-form label {
            display: block;
            margin-top: 18px;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--color-text-dark);
            font-size: 15px;
        }
        .admin-form input:not([type="checkbox"]):not([type="file"]):not([type="color"]), 
        .admin-form select, 
        .admin-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            box-sizing: border-box; 
            font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        /* Specific styling for the color input */
        .admin-form input[type="color"] {
            width: 100%;
            height: 44px; /* Same height as other inputs */
            padding: 4px; /* Adjust padding for visual alignment */
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            box-sizing: border-box;
            cursor: pointer;
        }
        
        .admin-form input:focus, 
        .admin-form select:focus, 
        .admin-form textarea:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(67, 56, 202, 0.1); 
            outline: none;
        }
        .admin-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Submit Buttons */
        .admin-form button.submit-btn {
            width: 100%; 
            background-color: var(--color-primary); /* Default is Indigo */
            color: white;
            padding: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            margin-top: 25px;
            transition: background-color 0.3s;
        }
        /* Specific Button Overrides */
        #memberFormSubmit {
            background-color: var(--color-secondary) !important; /* Emerald for Add/Save Member */
        }
        #memberFormSubmit:hover {
            background-color: #059669 !important; /* Darker Emerald */
        }
        .admin-form button.submit-btn[onclick*="setupMemberForm"] {
            background-color: #9CA3AF !important; /* Grey for Reset */
        }
        .admin-form button.submit-btn[onclick*="setupMemberForm"]:hover {
            background-color: #6B7280 !important;
        }
        .admin-section:nth-of-type(4) .submit-btn { /* Admin Passcode change */
            background-color: var(--color-primary) !important;
        }
        .admin-section:nth-of-type(5) .submit-btn { /* Female Passcode save */
            background-color: var(--color-warning) !important;
        }
        .admin-section:nth-of-type(5) .submit-btn:hover { 
            background-color: #D97706 !important; /* Darker Amber */
        }
        
        /* Grid Layout */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 20px;
        }
        @media (min-width: 900px) {
            .form-grid.three-col {
                grid-template-columns: repeat(3, 1fr);
            }
            .form-grid.two-col {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Checkbox/Toggle styling */
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #F3F4F6;
        }
        .checkbox-group input[type="checkbox"] {
            transform: scale(1.3);
            accent-color: var(--color-secondary);
        }
        .checkbox-group label {
            margin: 0;
            margin-left: 10px;
            font-weight: 500;
            /* Override the default block label style for this specific group */
            display: inline; 
            margin-top: 0; 
        }

        /* ----------------- MEMBER TABLE (DESKTOP) ----------------- */
        .table-responsive {
            overflow-x: auto; 
            width: 100%;
        }

        .member-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 800px; /* Desktop min-width */
            font-size: 14px;
            text-align: left;
            border-radius: 10px;
            overflow: hidden; 
        }
        .member-table th {
            background-color: #E0E7FF; 
            color: var(--color-primary);
            padding: 12px 10px;
            font-weight: 700;
            white-space: nowrap;
        }
        .member-table td {
            padding: 10px;
            border-bottom: 1px solid #F3F4F6;
            vertical-align: middle;
            color: var(--color-text-dark);
            white-space: nowrap;
        }
        .member-table tr.even-row {
            background-color: #ffffff;
        }
        .member-table tr.odd-row {
            background-color: #F9FAFB;
        }
        .member-table tr:hover {
            background-color: #EFF6FF; 
        }

        .admin-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
            font-weight: 600;
            transition: opacity 0.3s;
        }
        .admin-actions .edit-btn { background-color: var(--color-primary); color: white; }
        .admin-actions .delete-btn { background-color: var(--color-danger); color: white; }
        
        /* Read Only Input */
        .read-only-input {
            background-color: #E5E7EB; 
            font-weight: 700;
            color: var(--color-text-light);
            cursor: default;
        }

        /* ----------------- MOBILE TABLE (CARD VIEW) ----------------- */
        @media screen and (max-width: 800px) {
            /* Hide the table header */
            .member-table thead {
                display: none;
            }
            
            /* Remove desktop table styling */
            .member-table {
                min-width: 100%; 
                border-collapse: collapse;
            }

            /* Convert each row into a block-level card */
            .member-table tr {
                display: block;
                margin-bottom: 15px; 
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.08);
                padding: 0; 
            }
            
            /* Remove striped background on mobile cards */
            .member-table tr.even-row, .member-table tr.odd-row {
                background-color: white !important;
            }
            
            /* Convert each cell into a block-level element for stacking */
            .member-table td {
                display: block;
                border-bottom: 1px solid #F3F4F6;
                text-align: right;
                padding: 12px 15px;
                font-size: 15px;
                white-space: normal; /* Allow text wrapping */
            }

            /* Add the table header as a label using the data-label attribute */
            .member-table td:before {
                content: attr(data-label) ":";
                float: left;
                font-weight: 700;
                text-transform: capitalize; 
                color: var(--color-primary);
                font-size: 1em;
                margin-right: 10px;
            }
            
            /* Remove bottom border on the last cell (actions) */
            .member-table td:last-child {
                border-bottom: 0;
            }
            
            /* Center actions buttons in the card */
            .admin-actions {
                text-align: center;
                padding: 15px !important;
                display: flex;
                justify-content: space-around;
                gap: 10px;
                align-items: center;
            }
            
            .admin-actions button {
                flex-grow: 1; /* Make buttons grow to fill space */
                margin: 0;
                font-size: 13px;
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="login-box">
        <h2>Admin Login</h2>
        <input type="password" id="passcode" placeholder="Enter Passcode" onkeyup="if(event.key==='Enter') loginAdmin()" />
        <button onclick="loginAdmin()">Login</button>
        <div style="margin-top: 15px;">
             <a href="index.html" style="color:var(--color-primary); text-decoration:none; font-size:14px; font-weight: 500;"><i class="fa-solid fa-arrow-left"></i> Go Back to Public Site</a>
        </div>
    </div>
</div>

<div id="adminPanel" style="display:none;">
    <div class="header">
        <h1>Admin Panel</h1>
        <button class="logout-btn" onclick="logoutAdmin()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>

    <div class="container">
        <div class="admin-nav-button-container">
            <button class="admin-nav-button" onclick="setupMemberForm()"><i class="fa-solid fa-user-plus"></i> Naya Member Add</button>
            <button class="admin-nav-button" onclick="showSection('memberListSection')"><i class="fa-solid fa-list-ul"></i> View Member List</button>
            <button class="admin-nav-button" onclick="showSection('siteSettingsSection')"><i class="fa-solid fa-gear"></i> Site Settings</button>
            <button class="admin-nav-button" onclick="showSection('passcodeSection')"><i class="fa-solid fa-lock"></i> Admin Passcode</button>
            <button class="admin-nav-button" onclick="showSection('femalePasscodeSection')"><i class="fa-solid fa-user-shield"></i> Female Passcode</button>
        </div>

        <div class="admin-section" id="memberManagementSection">
            <h2 id="memberFormTitle"><i class="fa-solid fa-user-plus"></i> Add New Member</h2>
            <form id="memberForm" onsubmit="event.preventDefault(); saveMember()" class="admin-form">
                <div class="form-grid three-col">
                    <div>
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div>
                        <label for="relation">Relation</label>
                        <select id="relation">
                            <option value="">-- Select Relation --</option>
                            <option value="Son">Son</option>
                            <option value="Daughter">Daughter</option>
                            <option value="Wife">Wife</option>
                            <option value="Husband">Husband</option>
                            <option value="Self">Self (Root)</option>
                        </select>
                    </div>
                    <div>
                        <label for="gender">Gender</label>
                        <select id="gender">
                            <option value="">-- Select --</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                        </select>
                    </div>
                    <div>
                        <label for="dob">Date of Birth</label>
                        <input type="date" id="dob">
                    </div>
                    
                    <div>
                        <label for="imageUpload">Member ki Image Upload krain</label>
                        <input type="file" id="imageUpload" accept="image/*">
                    </div>
                    
                    <div style="grid-column: 1 / -1;">
                        <div id="imagePreviewContainer" style="margin-top: 15px; display: none; align-items: center; gap: 15px; padding: 10px; border: 1px dashed #D1D5DB; border-radius: 8px;">
                            <img id="currentImagePreview" src="" alt="Current Image" style="max-width: 80px; max-height: 80px; border-radius: 6px; object-fit: cover;">
                            <div>
                                <span id="imageStatus" style="font-size: 13px; color: var(--color-text-light); display: block; margin-bottom: 5px;">Current Image: </span>
                                <button type="button" onclick="removeImage()" id="removeImageBtn" style="background-color: var(--color-danger); color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background-color 0.3s;">Remove Current Image</button>
                            </div>
                        </div>
                        <input type="hidden" id="existingImageURL" value=""> 
                    </div>
                </div>
                
                <div class="form-grid two-col" style="margin-top: 10px;">
                    <div>
                        <label for="parentID">Member K Walid kn hain (Search and Select)</label>
                        <input type="text" id="parentSearch" placeholder="Type member name in English/Urdu to filter list..." onkeyup="filterSelectOptions('parentID', this.value)">
                        <select id="parentID">
                            <option value="">(Optional) No Parent / Root Member</option>
                        </select>
                    </div>
                    <div>
                        <label for="spouseID"> Member ki wife (if in system) (Search and Select)</label>
                        <input type="text" id="spouseSearch" placeholder="Type spouse name in English/Urdu to filter list..." onkeyup="filterSelectOptions('spouseID', this.value)">
                        <select id="spouseID">
                            <option value="">(Optional) No Spouse / External Spouse</option>
                        </select>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="spouseExternalName">wife ka Name (Manual)</label>
                        <input type="text" id="spouseExternalName">
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="isAlive" checked>
                    <label for="isAlive">Zainda ha?</label>
                </div>
                
                <button type="submit" id="memberFormSubmit" class="submit-btn"><i class="fa-solid fa-save"></i> Add Member</button>
                <button type="button" onclick="setupMemberForm()" class="submit-btn" style="margin-top: 10px;"><i class="fa-solid fa-undo"></i> Reset Form</button>
            </form>
        </div>

        <div class="admin-section" id="memberListSection">
            <h2><i class="fa-solid fa-list"></i> Member List</h2>
            
            <label for="memberSearchInput" style="margin-bottom: 5px; font-weight: 600; color: var(--color-text-dark); font-size: 15px;">Search Member by Name (English or Urdu Roman):</label>
            <input type="text" id="memberSearchInput" placeholder="Type name here to filter the list (e.g., 'ali' or 'احمد')" onkeyup="filterMemberList(this.value)" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box;">
            <div class="table-responsive">
                <table class="member-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Full Name</th>
                            <th>Parent</th>
                            <th>DOB</th>
                            <th>Gender</th>
                            <th>Alive</th>
                            <th>Spouse</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="memberTableBody">
                        <tr><td colspan="8" style="text-align:center;">Load members using the 'View Member List' button...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section" id="siteSettingsSection">
            <h2><i class="fa-solid fa-gear"></i> Site Settings</h2>
            <form onsubmit="event.preventDefault(); saveSiteConfig()" class="admin-form">
                
                <div class="form-grid three-col">
                    <div>
                        <label for="siteName">Site Title (Main)</label>
                        <input type="text" id="siteName">
                    </div>
                    <div style="grid-column: 2 / -1;">
                         <label for="siteColor">Main Site Color (Primary)</label>
                         <input type="color" id="siteColor" value="#4338CA" title="Select the main color theme for the site.">
                    </div>
                </div>

                <div class="form-grid two-col">
                    <div style="grid-column: 1 / -1;">
                        <label for="features">App Features (Comma Separated)</label>
                        <input type="text" id="features">
                    </div>
                    
                    <div>
                        <label for="phoneNumber">Contact Number</label>
                        <input type="text" id="phoneNumber" placeholder="+923XXYYYYYYY">
                    </div>
                    <div>
                        <label for="whatsappNumber">WhatsApp Number</label>
                        <input type="text" id="whatsappNumber" placeholder="+923XXYYYYYYY">
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="hideDOB">
                    <label for="hideDOB">Zinda (Alive) Members ki Date of Birth (DOB) Chhupain?</label>
                </div>

                <div class="form-grid two-col">
                    <div style="grid-column: 1 / -1;">
                        <label for="welcomeMessage">Public Welcome/Announcement Message (Optional)</label>
                        <textarea id="welcomeMessage" rows="2" placeholder="Example: Jalsa 2024 ki tafseelat jald announce ki jayengi."></textarea>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="contactDesc">Contact Description</label>
                        <textarea id="contactDesc"></textarea>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="aboutUrdu">About Urdu Text (Max 3 lines)</label>
                        <textarea id="aboutUrdu"></textarea>
                    </div>
                </div>
                <button type="submit" class="submit-btn"><i class="fa-solid fa-floppy-disk"></i> Save Site Settings</button>
            </form>
        </div>
        
        <div class="admin-section" id="passcodeSection">
            <h2><i class="fa-solid fa-lock"></i> Change Admin Passcode</h2>
            <form onsubmit="event.preventDefault(); changePasscode()" class="admin-form">
                 <div class="form-grid three-col">
                    <div>
                        <label for="currentPasscode">Current Passcode</label>
                        <input type="password" id="currentPasscode" required>
                    </div>
                    <div>
                        <label for="newPasscode">New Passcode</label>
                        <input type="password" id="newPasscode" required>
                    </div>
                    <div>
                        <label for="confirmPasscode">Confirm New Passcode</label>
                        <input type="password" id="confirmPasscode" required>
                    </div>
                </div>
                <button type="submit" class="submit-btn"><i class="fa-solid fa-key"></i> Change Passcode</button>
            </form>
        </div>

        <div class="admin-section" id="femalePasscodeSection">
            <h2><i class="fa-solid fa-user-shield"></i> Female Detail Passcode Management</h2>
            <form onsubmit="event.preventDefault(); saveFemalePasscode()" class="admin-form">
                <p style="color: var(--color-text-light); font-size: 14px; margin-top: -10px;">
                    یہ پاس کوڈ خواتین کی تفصیلات دیکھنے کے لیے استعمال ہو گا جو عوامی سائٹ پر درج کیا جاتا ہے۔
                </p>
                
                 <div class="form-grid three-col">
                    <div>
                        <label for="currentFemalePasscodeDisplay">Current Passcode</label>
                        <input type="text" id="currentFemalePasscodeDisplay" class="read-only-input" readonly value="(No Passcode Set)" title="Current Passcode is loaded from Supabase.">
                    </div>
                    <div>
                        <label for="newFemalePasscode">New Passcode</label>
                        <input type="password" id="newFemalePasscode" placeholder="Enter New Passcode (Leave empty to remove)">
                    </div>
                    <div>
                        <label for="confirmFemalePasscode">Confirm New Passcode</label>
                        <input type="password" id="confirmFemalePasscode" placeholder="Confirm New Passcode (Leave empty to remove)">
                    </div>
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fa-solid fa-floppy-disk"></i> Save / Remove Female Passcode
                </button>
            </form>
        </div>
        
    </div>
</div>

</body>
</html>